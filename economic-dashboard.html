<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Economic Dashboard | Affordable Housing Intelligence</title>
  <meta name="description" content="Real-time economic indicators from FRED affecting affordable housing development.">
  <script src="js/config.js"></script>
  <script src="js/path-resolver.js"></script>
  <script src="js/fetch-helper.js"></script>
  <script src="js/data-service-portable.js"></script>
  <script src="js/scroll-fix.js"></script>
  <script src="js/api-config-wrapper.js"></script>
  <script src="js/vendor/chart.umd.min.js"></script>
  <link rel="stylesheet" href="css/site-theme.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/pages.css">
  <link rel="stylesheet" href="css/predictions-dashboard.css">
  <style>main#main-content { border-left: 1px solid var(--border); border-right: 1px solid var(--border); }</style>
  <script defer src="js/navigation.js"></script>
  <script defer src="js/dark-mode-toggle.js"></script>
  <script defer src="js/mobile-menu.js"></script>
</head>
<body class="no-shell" data-page="economic-dashboard.html">
<div id="statusPanel" aria-live="polite"></div>
<a class="skip-link" href="#main-content">Skip to main content</a>
<!-- Navigation (mimics HousingMetrics style) -->
<main id="main-content" class="container">

<section class="hero" style="padding-left:0;padding-right:0;padding-bottom:0;">
<div style="padding:0 var(--sp4) var(--sp4);">
<div class="kicker">Real-time • FRED</div>
<h1>Economic Dashboard</h1>
<p class="sub" style="max-width:none;font-size:0.97rem;line-height:1.7;margin-bottom:var(--sp3);">
        Macro conditions that determine deal outcomes are tracked in real time. Interest rate movements affect equity pricing and permanent debt terms. Construction cost indices influence per-unit budgets and change-order exposure. Labor market tightness impacts contractor bids and development timelines. Housing supply and vacancy data define the market case for new units.
      </p>
<p class="sub" style="max-width:none;font-size:0.97rem;line-height:1.7;margin-bottom:var(--sp3);">
        Whether underwriting a LIHTC deal, sizing a construction loan, assessing rental demand, or shaping housing policy, these numbers move outcomes: the rate environment that prices tax credit equity, the CPI trajectory that determines rent restrictions’ viability, pipeline pressure signals from starts and permits data, and labor costs in contractor estimates.
      </p>
<p class="sub" style="max-width:none;font-size:0.97rem;line-height:1.7;margin-bottom:var(--sp4);">
        Construction PPIs feed feasibility models, Treasury yields and mortgage spreads set permanent debt terms, SOFR for variable-rate exposure, and vacancy and homeownership rates anchor market studies. All sourced from FRED, the Federal Reserve’s public data repository, and updated on each series’ schedule. In affordable housing finance, assumptions are made months before closing, and the market rarely waits.
      </p>
<div class="toolbar">
<div class="card control" style="flex-wrap:wrap;">
<span class="pill">FRED connected: <strong id="conn">…</strong></span>
<span class="pill">Indicators: <strong id="count">—</strong></span>
<span class="pill">Last updated: <strong id="lastUpdated">—</strong></span>
<button class="btn primary" id="refresh" type="button">Refresh</button>
</div>
</div>
</div>
<!-- Hero KPI Strip — full width -->
<div class="kpi-strip" role="region" aria-label="Key economic indicators" style="margin-top:var(--sp3);margin-left:calc(-1 * var(--sp4));margin-right:calc(-1 * var(--sp4));">
<div class="kpi-strip-item">
<div class="kpi-strip-value" id="statCpi">—</div>
<div class="kpi-strip-label">Inflation (CPI YoY)</div>
<div style="font-size:var(--tiny);color:var(--faint);margin-top:2px;" id="deltaCpi">—</div>
</div>
<div class="kpi-strip-item">
<div class="kpi-strip-value" id="statUnemp">—</div>
<div class="kpi-strip-label">Unemployment Rate</div>
<div style="font-size:var(--tiny);color:var(--faint);margin-top:2px;" id="deltaUnemp">—</div>
</div>
<div class="kpi-strip-item">
<div class="kpi-strip-value" id="stat10y">—</div>
<div class="kpi-strip-label">10-Year Treasury</div>
<div style="font-size:var(--tiny);color:var(--faint);margin-top:2px;" id="delta10y">—</div>
</div>
<div class="kpi-strip-item">
<div class="kpi-strip-value" id="statStarts">—</div>
<div class="kpi-strip-label">Housing Starts (SAAR)</div>
<div style="font-size:var(--tiny);color:var(--faint);margin-top:2px;" id="deltaStarts">—</div>
</div>
<div class="kpi-strip-item">
<div class="kpi-strip-value" id="statMfStarts">—</div>
<div class="kpi-strip-label">Multifamily Starts</div>
<div style="font-size:var(--tiny);color:var(--faint);margin-top:2px;" id="deltaMfStarts">—</div>
</div>
<div class="kpi-strip-item">
<div class="kpi-strip-value" id="statPermits">—</div>
<div class="kpi-strip-label">Building Permits</div>
<div style="font-size:var(--tiny);color:var(--faint);margin-top:2px;" id="deltaPermits">—</div>
</div>
<div class="kpi-strip-item">
<div class="kpi-strip-value" id="statUnderConst">—</div>
<div class="kpi-strip-label">Units Under Construction</div>
<div style="font-size:var(--tiny);color:var(--faint);margin-top:2px;" id="deltaUnderConst">—</div>
</div>
<div class="kpi-strip-item">
<div class="kpi-strip-value" id="statCompletions">—</div>
<div class="kpi-strip-label">Completions</div>
<div style="font-size:var(--tiny);color:var(--faint);margin-top:2px;" id="deltaCompletions">—</div>
</div>
</div>
<div style="padding:0 var(--sp4);">
<p class="note" style="margin-top:var(--sp3);">
        Data source: <a href="https://fred.stlouisfed.org" rel="noopener" target="_blank">FRED</a>, Federal Reserve Bank of St. Louis. Data refreshed daily via automated workflow.
      </p>
</div>
</section><section id="census-stats" style="margin:18px 0; padding:18px;">
<h2>Census snapshot</h2>
<div class="census-controls">
  <label>Geography<select id="censusLevel">
    <option value="national" selected>National (U.S.)</option>
    <option value="state">State</option>
    <option value="county">County</option>
    <option value="place">Place</option>
  </select></label>
  <label id="censusStateWrap" style="display:none;">State<select id="censusState"></select></label>
  <label id="censusGeoWrap" style="display:none;">Select<select id="censusGeo"></select></label>
  <div class="census-vintage" data-census-vintage="">Loading…</div>
</div>
<div class="census-grid"></div>

<div class="census-construction-header">
  <span class="census-construction-title">Housing Construction Activity</span>
  <span class="census-construction-note">National · Census Bureau via FRED · Most recent monthly data</span>
</div>
<div class="census-grid" id="census-construction"></div>
</section>
<!-- Collapsible sections (Nixvir-like: metric cards with inline charts) -->
<details class="card" open="">
<summary>
        Construction Costs
        <span class="pill small">6 indicators</span>
</summary>
<div class="section-body">
<p class="section-desc">Producer price indices and cost proxies that impact per-unit construction budgets and feasibility.</p>
<div class="metric-grid" id="sec-construction"></div>
</div>
</details>
<details class="card" open="">
<summary>
        Housing Market
        <span class="pill small">9 indicators</span>
</summary>
<div class="section-body">
<p class="section-desc">Starts, permits, prices, and affordability signals that shape pipeline and underwriting assumptions.</p>
<div class="metric-grid" id="sec-housing"></div>
</div>
</details>
<details class="card" open="">
<summary>
        Financial &amp; Interest Rates
        <span class="pill small">6 indicators</span>
</summary>
<div class="section-body">
<p class="section-desc">Rates and spreads that move equity pricing, permanent debt terms, and bond execution costs.</p>
<div class="metric-grid" id="sec-finance"></div>
</div>
</details>
<details class="card" open="">
<summary>
        Labor Market
        <span class="pill small">6 indicators</span>
</summary>
<div class="section-body">
<p class="section-desc">Employment, earnings, and labor supply indicators relevant to labor cost pressure and demand.</p>
<div class="metric-grid" id="sec-labor"></div>
</div>
</details>
<p class="note small">
      Implementation notes: FRED data is fetched client-side via the FRED API “observations” endpoint.
      Some series update monthly or quarterly; charts show the most recent 5 years (or max available if shorter).
    </p>

<!-- ══════════════════════════════════════════════════════════════
     HOUSING PREDICTIVE MODELING SECTION  (housing-predictions.js)
     ══════════════════════════════════════════════════════════════ -->
    <div id="housing-predictions-section" aria-label="Housing Predictive Modeling"></div>

<!-- ══════════════════════════════════════════════════════════════
     METHODOLOGY & SOURCES (bottom of page)
     ══════════════════════════════════════════════════════════════ -->
<details class="card" style="margin-top:var(--sp4);" id="methodology-sources">
<summary>Methodology &amp; Data Sources</summary>
<div class="section-body">
  <h3 style="margin-bottom:var(--sp2)">Data Sources by Section</h3>
  <ul style="margin-bottom:var(--sp3)">
    <li><strong>Construction Costs</strong> — BLS Producer Price Indices via <a href="https://fred.stlouisfed.org" target="_blank" rel="noopener">FRED</a>: WPUFD49207 (Inputs to construction), WPUFD4 (Construction materials), PCU236115236115 (New multifamily construction), WPU10170503 (Steel reinforcing bar), WPU0811 (Lumber), PCU32731327313 (Cement &amp; concrete products), CES2000000008 (Construction hourly earnings), ECIALLCIV (Employment Cost Index)</li>
    <li><strong>Housing Market</strong> — Census Bureau / Census-HUD via <a href="https://fred.stlouisfed.org" target="_blank" rel="noopener">FRED</a>: HOUST (Total housing starts), HOUST5F (Multifamily 5+ unit starts), PERMIT (Total building permits), PERMIT5 (Multifamily permits), UNDCONTSA (Units under construction), COMPUTSA (Multifamily completions), CSUSHPISA (S&amp;P/Case-Shiller HPI), MSPUS (Median sales price), RHORUSQ156N (Homeownership rate), RRVRUSQ156N (Rental vacancy rate)</li>
    <li><strong>Financial &amp; Interest Rates</strong> — Federal Reserve / ICE via <a href="https://fred.stlouisfed.org" target="_blank" rel="noopener">FRED</a>: DGS10 (10-yr Treasury), DGS2 (2-yr Treasury), DFF (Fed Funds), SOFR (Secured Overnight Financing Rate), MORTGAGE30US (30-yr Fixed Mortgage), BAA10Y (Moody's Baa spread), T10Y2Y (Yield curve 10Y-2Y)</li>
    <li><strong>Labor Market</strong> — BLS via <a href="https://fred.stlouisfed.org" target="_blank" rel="noopener">FRED</a>: UNRATE (Unemployment rate), PAYEMS (Nonfarm payrolls), CIVPART (Labor force participation), CES0500000003 (Average hourly earnings), JTSJOL (JOLTS job openings), ICSA (Initial jobless claims), CPIAUCSL (CPI All Items), CUUR0000SAH1 (CPI Shelter)</li>
    <li><strong>Census Snapshot</strong> — <a href="https://www.census.gov/data/developers/data-sets/acs-1year.html" target="_blank" rel="noopener">U.S. Census Bureau ACS 1-Year and 5-Year Estimates</a>: DP02 (Social), DP03 (Economic), DP04 (Housing), DP05 (Demographic) profile tables. Select a geography using the Census Snapshot dropdown to link to the source data for that jurisdiction.</li>
  </ul>
  <h3 style="margin-bottom:var(--sp2)">Methodology</h3>
  <p>All FRED series are fetched daily by a GitHub Actions workflow and stored in <code>data/fred-data.json</code> — no API key is required in the browser and no CORS issues occur. Charts show the most recent 84 months (7 years) or the maximum available history if shorter. Year-over-year changes are computed from the same-month prior year; for non-monthly series the nearest prior period is used.</p>
  <p>The <strong>Predictive Modeling</strong> section uses illustrative probability distributions aligned with published GSE and independent forecaster consensus. Expert consensus incorporates: Fannie Mae Economic &amp; Housing Outlook (monthly), Freddie Mac Quarterly Forecast, Federal Reserve Monetary Policy Reports (semiannual), NAR Economic Outlook, MBA Mortgage Finance Forecast, Zillow Research, Moody's Analytics, and CoreLogic market insights. These are not actual prediction-market contract prices.</p>
  <p>The <strong>Historical Accuracy</strong> table tracks documented housing outcomes against the forecaster consensus probability at the start of each year. Realized outcomes are sourced from FRED (CSUSHPISA, MORTGAGE30US, HOUST, RRVRUSQ156N), NAR, and the U.S. Census Bureau Housing Vacancy Survey. A "Correct" designation means the highest-probability outcome category materialized.</p>
  <p class="note">Data is updated daily. Series availability depends on publication lag from the originating agency — some series update monthly, others quarterly. Stub placeholder data (marked <code>_stub: true</code> in the JSON) will be replaced by real FRED observations on the next automated fetch cycle.</p>
</div>
</details>

</main>
<script>
(() => {
  const CONFIG_KEY = (window.APP_CONFIG && window.APP_CONFIG.FRED_API_KEY) ? window.APP_CONFIG.FRED_API_KEY : "";

  // Keep your "desired indicators" (24) but render them nixvir-style.
  const INDICATORS = [
    // Construction (6)
    {section:"construction", id:"WPUFD49207", title:"PPI: Inputs to construction", units:"index", fmt:"index"},
    {section:"construction", id:"WPUSI012011", title:"PPI: Lumber & wood products", units:"index", fmt:"index"},
    {section:"construction", id:"WPUFD4", title:"PPI: Construction materials", units:"index", fmt:"index"},
    {section:"construction", id:"PCU236115236115", title:"PPI: New multifamily construction", units:"index", fmt:"index"},
    {section:"construction", id:"CES2000000008", title:"Construction Avg Hourly Earnings", units:"$/hr", fmt:"usd"},
    {section:"construction", id:"ECIALLCIV", title:"Employment Cost Index (Total comp)", units:"index", fmt:"index"},
    {section:"construction", id:"WPU10170503", title:"PPI: Steel &amp; Metal Products", units:"index", fmt:"index"},
    {section:"construction", id:"WPU0811", title:"PPI: Lumber &amp; Wood Products (Softwood)", units:"index", fmt:"index"},
    {section:"construction", id:"PCU32731327313", title:"PPI: Cement & Concrete Products", units:"index", fmt:"index"},

    // Housing (6)
    {section:"housing", id:"HOUST", title:"Housing Starts (SAAR)", units:"thousands", fmt:"int"},
    {section:"housing", id:"PERMIT", title:"Building Permits (SAAR)", units:"thousands", fmt:"int"},
    {section:"housing", id:"CSUSHPISA", title:"Case-Shiller Home Price Index", units:"index", fmt:"index"},
    {section:"housing", id:"MSPUS", title:"Median Sales Price of Houses", units:"$", fmt:"usd"},
    {section:"housing", id:"RHORUSQ156N", title:"Homeownership Rate", units:"%", fmt:"pct"},
    {section:"housing", id:"RRVRUSQ156N", title:"Rental Vacancy Rate", units:"%", fmt:"pct"},
    {section:"housing", id:"HOUST5F",     title:"Multifamily Starts (5+ units)", units:"thousands", fmt:"int"},
    {section:"housing", id:"PERMIT5",     title:"Multifamily Permits (5+ units)", units:"thousands", fmt:"int"},
    {section:"housing", id:"UNDCONTSA",   title:"Units Under Construction", units:"thousands", fmt:"int"},
    {section:"housing", id:"COMPUTSA",    title:"Multifamily Completions (5+ units)", units:"thousands", fmt:"int"},

    // Finance (cached + SOFR in registry, hidden until cache populated)
    {section:"finance", id:"DGS10", title:"10-Year Treasury Yield", units:"%", fmt:"pct"},
    {section:"finance", id:"DGS2", title:"2-Year Treasury Yield", units:"%", fmt:"pct"},
    {section:"finance", id:"DFF", title:"Effective Fed Funds Rate", units:"%", fmt:"pct"},
    {section:"finance", id:"MORTGAGE30US", title:"30-Year Fixed Mortgage Rate", units:"%", fmt:"pct"},
    {section:"finance", id:"BAA10Y", title:"Moody’s Baa - 10Y Treasury Spread", units:"pts", fmt:"pct"},
    {section:"finance", id:"T10Y2Y", title:"Yield Curve (10Y-2Y)", units:"pts", fmt:"pct"},
    {section:"finance", id:"SOFR", title:"SOFR (Secured Overnight Financing Rate)", units:"%", fmt:"pct"},

    // Labor (cached + shelter CPI in registry, hidden until cache populated)
    {section:"labor", id:"UNRATE", title:"Unemployment Rate", units:"%", fmt:"pct"},
    {section:"labor", id:"PAYEMS", title:"Nonfarm Payrolls", units:"thousands", fmt:"int"},
    {section:"labor", id:"CIVPART", title:"Labor Force Participation", units:"%", fmt:"pct"},
    {section:"labor", id:"CES0500000003", title:"Average Hourly Earnings", units:"$", fmt:"usd"},
    {section:"labor", id:"JTSJOL", title:"Job Openings (JOLTS)", units:"thousands", fmt:"int"},
    {section:"labor", id:"ICSA", title:"Initial Jobless Claims", units:"count", fmt:"int"},
    {section:"labor", id:"CPIAUCSL", title:"CPI: All Items", units:"index", fmt:"index"},
    {section:"labor", id:"CUUR0000SAH1", title:"CPI: Shelter", units:"index", fmt:"index"}
  ];

  const els = {
    conn: document.getElementById("conn"),
    refresh: document.getElementById("refresh"),
    lastUpdated: document.getElementById("lastUpdated"),
    count: document.getElementById("count"),
    statCpi: document.getElementById("statCpi"),
    deltaCpi: document.getElementById("deltaCpi"),
    statUnemp: document.getElementById("statUnemp"),
    deltaUnemp: document.getElementById("deltaUnemp"),
    stat10y: document.getElementById("stat10y"),
    delta10y: document.getElementById("delta10y"),
    statStarts: document.getElementById("statStarts"),
    deltaStarts: document.getElementById("deltaStarts"),
    statMfStarts: document.getElementById("statMfStarts"),
    deltaMfStarts: document.getElementById("deltaMfStarts"),
    statPermits: document.getElementById("statPermits"),
    deltaPermits: document.getElementById("deltaPermits"),
    statUnderConst: document.getElementById("statUnderConst"),
    deltaUnderConst: document.getElementById("deltaUnderConst"),
    statCompletions: document.getElementById("statCompletions"),
    deltaCompletions: document.getElementById("deltaCompletions"),
    sec: {
      construction: document.getElementById("sec-construction"),
      housing: document.getElementById("sec-housing"),
      finance: document.getElementById("sec-finance"),
      labor: document.getElementById("sec-labor"),
    }
  };

  // count will be updated after indicators successfully render
  if (els.count) els.count.textContent = "…";
function getKey(){ return CONFIG_KEY || ""; }
    
  function fmtValue(v, fmt){
    const n = Number(v);
    if (!isFinite(n)) return "—";
    if (fmt === "pct") return n.toFixed(2).replace(/\.00$/,"") + "%";
    if (fmt === "usd") {
      // show no decimals for large numbers, two decimals for small
      const abs = Math.abs(n);
      const decimals = abs >= 100 ? 0 : 2;
      return n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:decimals});
    }
    if (fmt === "int") return Math.round(n).toLocaleString();
    return n.toLocaleString(undefined,{maximumFractionDigits:2});
  }

  function deltaClass(d){
    if (!isFinite(d)) return "flat";
    if (d > 0) return "up";
    if (d < 0) return "down";
    return "flat";
  }
  function arrow(d){
    if (!isFinite(d)) return "→";
    if (d > 0) return "↑";
    if (d < 0) return "↓";
    return "→";
  }

  // Data is pre-fetched daily by a GitHub Action (.github/workflows/fetch-fred-data.yml)
  // and stored in data/fred-data.json — no CORS issues, no API key needed in browser.
  let _fredCache = null;
  async function _loadFredData(){
    if (_fredCache) return _fredCache;
    _fredCache = await DataService.getJSON(DataService.baseData("fred-data.json"));
    return _fredCache;
  }

  async function fetchFRED(seriesId, apiKey, limit=84){
    const data = await _loadFredData();
    const entry = data.series && data.series[seriesId];

    // If the series isn't in cached data, report as unavailable.
    // Live FRED API calls are blocked by CORS when running on GitHub Pages.
    if (!entry || !entry.observations){
      throw new Error(seriesId + ": not available in cached FRED data (data/fred-data.json)");
    }
    const obs = entry.observations
      .filter(o => o && o.value !== "." && o.value !== null && o.date)
      .map(o => ({date: o.date, value: Number(o.value)}))
      .filter(o => isFinite(o.value));
    // Apply limit from tail (most recent)
    const sliced = obs.slice(-limit);
    if (!sliced.length) throw new Error(seriesId + " no observations");
    return sliced;
  }

  function buildMetricCard(ind){
    const idSafe = ind.id.replace(/[^a-zA-Z0-9_-]/g,"_");
    const wrap = document.createElement("div");
    wrap.className = "card metric";
    wrap.innerHTML = `
      <h3><a href="https://fred.stlouisfed.org/series/${encodeURIComponent(ind.id)}" target="_blank" rel="noopener">${ind.title}</a></h3>
      <p class="value" id="val-${idSafe}">Loading…</p>
      <div class="meta">
        <span id="date-${idSafe}">—</span>
        <span class="delta flat" id="delta-${idSafe}">—</span>
      </div>
      <div class="chart-wrap">
        <canvas id="ch-${idSafe}" aria-label="${ind.title} chart"></canvas>
        <div class="small" id="err-${idSafe}" style="margin-top:8px;"></div>
      </div>
    `;
    return wrap;
  }

  const charts = new Map();

  // Re-render charts when a collapsed <details> section is opened,
  // because Chart.js cannot measure a hidden (zero-size) canvas.
  document.querySelectorAll("details").forEach(det => {
    det.addEventListener("toggle", () => {
      if (!det.open) return;
      det.querySelectorAll("canvas").forEach(canvas => {
        const ch = charts.get(canvas.id);
        if (ch) { ch.resize(); ch.update(); }
      });
    });
  });

  function renderChart(canvas, labels, values){
    const ctx = canvas.getContext("2d");
    const existing = charts.get(canvas.id);
    if (existing) existing.destroy();

    const ch = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "",
          data: values,
          pointRadius: 0,
          borderWidth: 2,
          tension: 0.25
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { mode: "index", intersect: false, bodyFont: { size: 12 }, titleFont: { size: 12 } }
        },
        scales: {
          x: { ticks: { maxTicksLimit: 6, font: { size: 11 } }, grid: { display: false } },
          y: { ticks: { maxTicksLimit: 5, font: { size: 11 } }, grid: { color: "rgba(148,163,184,.22)" } }
        }
      }
    });

    charts.set(canvas.id, ch);
  }

  function monthLabel(iso){
    // "2026-01-01" -> "Jan 26"
    const d = new Date(iso + "T00:00:00");
    if (isNaN(d.getTime())) return iso;
    return d.toLocaleString(undefined, {month:"short", year:"2-digit"});
  }

  function pickChange(series){
    // Prefer YoY if enough history, else last period change
    if (series.length < 2) return {delta: NaN, label:"—"};
    const last = series[series.length - 1].value;
    // Find ~12 periods back if dates are monthly-ish. If not, use previous point.
    const idx = Math.max(0, series.length - 13);
    const prev = series[idx].value;
    const delta = last - prev;
    // If we likely used YoY, label it; else generic chg
    const label = (series.length >= 13) ? "YoY" : "chg";
    return {delta, label};
  }

  async function loadAll(){
    // Data served from data/fred-data.json — no API key needed in the browser
    const apiKey = true; // kept to avoid ReferenceError in calls below

    // Build metric cards
    for (const s of Object.values(els.sec)) s.innerHTML = "";
    const cardMap = new Map(); // seriesId -> card element
    for (const ind of INDICATORS){
      const card = buildMetricCard(ind);
      els.sec[ind.section].appendChild(card);
      cardMap.set(ind.id, card);
    }

    // Attempt to load the FRED cache; update conn pill accordingly
    let cacheLoaded = false;
    try {
      await _loadFredData();
      cacheLoaded = true;
      if (els.conn) els.conn.textContent = "Yes (cached)";
    } catch(e) {
      if (els.conn) els.conn.textContent = "No";
    }

    // Load headline stats (CPI YoY, UNRATE, DGS10, HOUST) — each independently
    await Promise.allSettled([
      fetchFRED("CPIAUCSL", apiKey, 90).then(cpi => {
        const last = cpi[cpi.length-1];
        const prev = cpi[Math.max(0, cpi.length-13)];
        const yoy = (last.value/prev.value - 1) * 100;
        els.statCpi.textContent = yoy.toFixed(1) + "%";

        // Show how the YoY rate has changed versus one year ago (in percentage points)
        if (els.deltaCpi) {
          let pp = NaN;
          if (cpi.length >= 25) {
            const last1y = cpi[cpi.length-13];
            const prev1y = cpi[cpi.length-25];
            const yoyPrev = (last1y.value/prev1y.value - 1) * 100;
            pp = yoy - yoyPrev;
          }
          els.deltaCpi.textContent = isFinite(pp)
            ? `Δ vs 1y ago: ${pp>=0?'+':''}${pp.toFixed(1)} pp`
            : "Δ vs 1y ago: —";
        }
      }).catch(e => { console.warn("Headline CPI failed:", e); els.statCpi.textContent = "—"; }),

      fetchFRED("UNRATE", apiKey, 90).then(unemp => {
        els.statUnemp.textContent = fmtValue(unemp[unemp.length-1].value, "pct");

        if (els.deltaUnemp) {
          const { delta, label } = pickChange(unemp);
          els.deltaUnemp.textContent = isFinite(delta)
            ? `${label}: ${delta>=0?'+':''}${delta.toFixed(1)} pp`
            : `${label}: —`;
        }
      }).catch(e => { console.warn("Headline UNRATE failed:", e); els.statUnemp.textContent = "—"; }),

      fetchFRED("DGS10", apiKey, 90).then(teny => {
        els.stat10y.textContent = fmtValue(teny[teny.length-1].value, "pct");

        if (els.delta10y) {
          const { delta, label } = pickChange(teny);
          els.delta10y.textContent = isFinite(delta)
            ? `${label}: ${delta>=0?'+':''}${delta.toFixed(2)} pp`
            : `${label}: —`;
        }
      }).catch(e => { console.warn("Headline DGS10 failed:", e); els.stat10y.textContent = "—"; }),

      fetchFRED("HOUST", apiKey, 90).then(starts => {
        els.statStarts.textContent = (Math.round(starts[starts.length-1].value) * 1000).toLocaleString() + " /yr";

        if (els.deltaStarts) {
          const last = starts[starts.length-1].value;
          const prev = starts[Math.max(0, starts.length-13)].value;
          const pct = (isFinite(prev) && prev !== 0) ? ((last/prev) - 1) * 100 : NaN;
          els.deltaStarts.textContent = isFinite(pct)
            ? `YoY: ${pct>=0?'+':''}${pct.toFixed(1)}%`
            : "YoY: —";
        }
      }).catch(e => { console.warn("Headline HOUST failed:", e); els.statStarts.textContent = "—"; }),

      // Construction activity stats for KPI strip
      fetchFRED("HOUST5F", apiKey, 90).then(mf => {
        if (els.statMfStarts) els.statMfStarts.textContent = (Math.round(mf[mf.length-1].value) * 1000).toLocaleString();
        if (els.deltaMfStarts) {
          const last = mf[mf.length-1].value, prev = mf[Math.max(0, mf.length-13)].value;
          const pct = (isFinite(prev) && prev !== 0) ? ((last/prev) - 1) * 100 : NaN;
          els.deltaMfStarts.textContent = isFinite(pct) ? `YoY: ${pct>=0?'+':''}${pct.toFixed(1)}%` : "YoY: —";
        }
      }).catch(e => { console.warn("Headline HOUST5F failed:", e); if (els.statMfStarts) els.statMfStarts.textContent = "—"; }),

      fetchFRED("PERMIT", apiKey, 90).then(permits => {
        if (els.statPermits) els.statPermits.textContent = (Math.round(permits[permits.length-1].value) * 1000).toLocaleString();
        if (els.deltaPermits) {
          const last = permits[permits.length-1].value, prev = permits[Math.max(0, permits.length-13)].value;
          const pct = (isFinite(prev) && prev !== 0) ? ((last/prev) - 1) * 100 : NaN;
          els.deltaPermits.textContent = isFinite(pct) ? `YoY: ${pct>=0?'+':''}${pct.toFixed(1)}%` : "YoY: —";
        }
      }).catch(e => { console.warn("Headline PERMIT failed:", e); if (els.statPermits) els.statPermits.textContent = "—"; }),

      fetchFRED("UNDCONTSA", apiKey, 90).then(uc => {
        if (els.statUnderConst) els.statUnderConst.textContent = (Math.round(uc[uc.length-1].value) * 1000).toLocaleString();
        if (els.deltaUnderConst) {
          const last = uc[uc.length-1].value, prev = uc[Math.max(0, uc.length-13)].value;
          const pct = (isFinite(prev) && prev !== 0) ? ((last/prev) - 1) * 100 : NaN;
          els.deltaUnderConst.textContent = isFinite(pct) ? `YoY: ${pct>=0?'+':''}${pct.toFixed(1)}%` : "YoY: —";
        }
      }).catch(e => { console.warn("Headline UNDCONTSA failed:", e); if (els.statUnderConst) els.statUnderConst.textContent = "—"; }),

      fetchFRED("COMPUTSA", apiKey, 90).then(comp => {
        if (els.statCompletions) els.statCompletions.textContent = (Math.round(comp[comp.length-1].value) * 1000).toLocaleString();
        if (els.deltaCompletions) {
          const last = comp[comp.length-1].value, prev = comp[Math.max(0, comp.length-13)].value;
          const pct = (isFinite(prev) && prev !== 0) ? ((last/prev) - 1) * 100 : NaN;
          els.deltaCompletions.textContent = isFinite(pct) ? `YoY: ${pct>=0?'+':''}${pct.toFixed(1)}%` : "YoY: —";
        }
      }).catch(e => { console.warn("Headline COMPUTSA failed:", e); if (els.statCompletions) els.statCompletions.textContent = "—"; }),
    ]);

    // Show when the cached FRED data was last fetched by the GitHub Action
    try {
      const meta = await _loadFredData();
      if (meta.updated && els.lastUpdated) {
        const updatedAt = new Date(meta.updated);
        els.lastUpdated.textContent = "Data as of " + updatedAt.toLocaleDateString(undefined,{year:"numeric",month:"short",day:"numeric"});
      }
    } catch(e) {}

    // Load and render all indicator series; hide card on failure
    let rendered = 0;
    const results = await Promise.allSettled(INDICATORS.map(async (ind) => {
      const idSafe = ind.id.replace(/[^a-zA-Z0-9_-]/g,"_");
      const valEl = document.getElementById(`val-${idSafe}`);
      const dateEl = document.getElementById(`date-${idSafe}`);
      const deltaEl = document.getElementById(`delta-${idSafe}`);
      const canvas = document.getElementById(`ch-${idSafe}`);
      const card = cardMap.get(ind.id);

      try{
        const series = await fetchFRED(ind.id, apiKey, 120);
        const last = series[series.length-1];
        valEl.textContent = fmtValue(last.value, ind.fmt);
        dateEl.textContent = monthLabel(last.date);

        const change = pickChange(series);
        const cls = deltaClass(change.delta);
        const arr = arrow(change.delta);

        let deltaText = "—";
        if (isFinite(change.delta)){
          if (ind.fmt === "pct") {
            deltaText = `${arr} ${change.delta.toFixed(2)} pts ${change.label}`;
          } else if (ind.fmt === "usd" || ind.fmt === "index" || ind.fmt === "int") {
            const base = series[Math.max(0, series.length-13)].value;
            const pct = base ? ((last.value/base - 1)*100) : NaN;
            if (isFinite(pct)) deltaText = `${arr} ${pct.toFixed(1)}% ${change.label}`;
            else deltaText = `${arr} ${change.delta.toFixed(2)} ${change.label}`;
          } else {
            deltaText = `${arr} ${change.delta.toFixed(2)} ${change.label}`;
          }
        }

        deltaEl.className = `delta ${cls}`;
        deltaEl.textContent = deltaText;

        const labels = series.map(p => monthLabel(p.date));
        const values = series.map(p => p.value);
        renderChart(canvas, labels, values);
        return true; // success
      } catch(e){
        console.warn("Indicator failed (hidden):", ind.id, e.message || e);
        // Hide the card — keep it in the DOM so IDs remain stable but remove from view
        if (card) { card.style.display = "none"; card.dataset.indicatorHidden = "1"; }
        return false; // failure
      }
    }));

    // Update count pill with number of successfully rendered indicators
    rendered = results.filter(r => r.status === "fulfilled" && r.value === true).length;
    if (els.count) els.count.textContent = String(rendered);

    // Update section pill counts to reflect visible cards
    document.querySelectorAll("details.card").forEach(det => {
      const grid = det.querySelector(".metric-grid");
      if (!grid) return;
      const visible = grid.querySelectorAll(".card.metric:not([data-indicator-hidden])").length;
      const pill = det.querySelector("summary .pill.small");
      if (pill && visible > 0) pill.textContent = visible + " indicator" + (visible !== 1 ? "s" : "");
      else if (pill && visible === 0) pill.textContent = "no data";
    });
  }

  // Init controls
  if (els.conn) els.conn.textContent = "…";
  if (els.lastUpdated) els.lastUpdated.textContent = "—";
  els.refresh.addEventListener("click", () => loadAll());

  // Load on start
  loadAll();
})();
</script>
<script src="js/contrast-guard.js"></script><script src="js/census-geo.js"></script><script src="js/fred-cards.js"></script>

<script defer src="js/housing-predictions.js"></script>
<script defer src="js/audit-hook.js"></script>

</body>
</html>
