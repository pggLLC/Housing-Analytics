
name: Update CAR Market Data

on:
  workflow_dispatch:
    inputs:
      month:
        description: 'Report month (YYYY-MM format, leave blank for current month)'
        required: false
        default: ''
      medianPrice:
        description: 'Statewide median sale price (e.g. 550000)'
        required: true
      inventory:
        description: 'Active listings count (e.g. 18500)'
        required: true
      daysOnMarket:
        description: 'Median days on market (e.g. 42)'
        required: true
      pricePerSqFt:
        description: 'Median price per sq ft (e.g. 265)'
        required: true

permissions:
  contents: write

jobs:
  generate-car-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve report month
        id: month
        run: |
          MONTH="${{ github.event.inputs.month }}"
          if [ -z "$MONTH" ]; then
            MONTH=$(date -u +'%Y-%m')
          fi
          echo "value=$MONTH" >> "$GITHUB_OUTPUT"

      - name: Generate CAR data JSON
        env:
          REPORT_MONTH: ${{ steps.month.outputs.value }}
          MEDIAN_PRICE: ${{ github.event.inputs.medianPrice }}
          INVENTORY: ${{ github.event.inputs.inventory }}
          DAYS_ON_MARKET: ${{ github.event.inputs.daysOnMarket }}
          PRICE_PER_SQFT: ${{ github.event.inputs.pricePerSqFt }}
        run: |
          python3 - <<'PY'
          import json, os, datetime

          month        = os.environ["REPORT_MONTH"]
          median_price = float(os.environ["MEDIAN_PRICE"])
          inventory    = int(os.environ["INVENTORY"])
          dom          = float(os.environ["DAYS_ON_MARKET"])
          ppsf         = float(os.environ["PRICE_PER_SQFT"])

          now = datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z"

          data = {
            "month": month,
            "generated_at": now,
            "source": "Colorado Association of REALTORS (CAR)",
            "source_url": "https://coloradorealtors.com/market-trends/",
            "version": "1.0",
            "statewide": {
              "median_sale_price": median_price,
              "active_listings": inventory,
              "median_days_on_market": dom,
              "median_price_per_sqft": ppsf
            },
            "metro_areas": {
              "denver": {
                "name": "Denver Metro",
                "median_sale_price": None,
                "active_listings": None,
                "median_days_on_market": None,
                "median_price_per_sqft": None
              },
              "colorado_springs": {
                "name": "Colorado Springs",
                "median_sale_price": None,
                "active_listings": None,
                "median_days_on_market": None,
                "median_price_per_sqft": None
              },
              "fort_collins": {
                "name": "Fort Collins / Greeley",
                "median_sale_price": None,
                "active_listings": None,
                "median_days_on_market": None,
                "median_price_per_sqft": None
              },
              "boulder": {
                "name": "Boulder",
                "median_sale_price": None,
                "active_listings": None,
                "median_days_on_market": None,
                "median_price_per_sqft": None
              },
              "pueblo": {
                "name": "Pueblo",
                "median_sale_price": None,
                "active_listings": None,
                "median_days_on_market": None,
                "median_price_per_sqft": None
              }
            },
            "notes": "Metro-level data not entered for this report. Update metro_areas manually or re-run workflow with metro inputs."
          }

          os.makedirs("data", exist_ok=True)
          path = f"data/car-market-report-{month}.json"
          with open(path, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=2)

          print(f"Wrote {path}")
          PY

      - name: Commit and push data file
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "data/car-market-report-${{ steps.month.outputs.value }}.json"
          git diff --cached --quiet || git commit -m "chore: add CAR market report ${{ steps.month.outputs.value }}"
          git push
