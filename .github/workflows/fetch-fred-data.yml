name: Fetch FRED Data

on:
  schedule:
    - cron: '0 6 * * *'   # daily at 06:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build data/fred-data.json from FRED API
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          python3 - <<'PY'
          import json, os, sys, datetime, urllib.request, urllib.parse

          api_key = os.environ.get("FRED_API_KEY", "").strip()
          if not api_key:
            print("ERROR: Missing FRED_API_KEY secret. Add it in GitHub repo settings: Settings → Secrets and variables → Actions.", file=sys.stderr)
            sys.exit(1)

          # Curated set used across dashboards (expand as needed)
          SERIES = {
            # Inflation / macro
            "CPIAUCSL": "CPI (All Urban Consumers)",
            "CUUR0000SAH1": "CPI: Shelter",
            "UNRATE": "Unemployment Rate",
            "PAYEMS": "Total Nonfarm Payrolls",
            "CIVPART": "Labor Force Participation Rate",
            "CES0500000003": "Average Hourly Earnings (All Private)",
            "JTSJOL": "Job Openings (JOLTS)",
            "ICSA": "Initial Jobless Claims",
            "DGS10": "10-Year Treasury Yield",
            "DGS2": "2-Year Treasury Yield",
            "DFF": "Effective Federal Funds Rate",
            "SOFR": "SOFR (Secured Overnight Financing Rate)",
            "MORTGAGE30US": "30-Year Fixed Mortgage Rate",
            "BAA10Y": "Moody's Baa - 10Y Treasury Spread",
            "T10Y2Y": "Yield Curve (10Y-2Y)",
            "HOUST": "Housing Starts",
            "HOUST5F": "Multifamily Starts (5+ units)",
            "PERMIT": "Building Permits",
            "PERMIT5": "Multifamily Permits (5+ units)",
            "UNDCONTSA": "Units Under Construction",
            "COMPUTSA": "Multifamily Completions (5+ units)",
            "CSUSHPISA": "Case-Shiller Home Price Index",
            "MSPUS": "Median Sales Price of Houses Sold",
            "RHORUSQ156N": "Homeownership Rate",
            "RRVRUSQ156N": "Rental Vacancy Rate",
            # Construction / commodities
            "WPUFD49207": "PPI: Inputs to construction",
            "WPUFD4": "PPI: Construction materials",
            "PCU236115236115": "PPI: New multifamily construction",
            "ECIALLCIV": "Employment Cost Index (Total comp)",
            "CES2000000008": "Construction Avg Hourly Earnings",
            "WPUSI012011": "PPI: Lumber & wood products",
            "WPU10170503": "Steel Reinforcing Bar",
            "PCU331111331111": "PPI: Iron and Steel Mills",
            "PCU3313153313153": "PPI: Aluminum",
            "PCU32731327313": "PPI: Cement and Concrete Product Manufacturing",
            "WPU0811": "PPI: Lumber",
            "WPU0812": "PPI: Plywood",
            
            "WPU057303": "PPI: Diesel Fuel",
            "CES2000000003": "Construction Avg Hourly Earnings",
          }

          def fetch_observations(series_id: str):
            base = "https://api.stlouisfed.org/fred/series/observations"
            params = {
              "series_id": series_id,
              "api_key": api_key,
              "file_type": "json",
              "sort_order": "asc",
              "observation_start": "2014-01-01",
              "limit": "5000"
            }
            url = base + "?" + urllib.parse.urlencode(params)
            with urllib.request.urlopen(url, timeout=30) as r:
              d = json.loads(r.read().decode("utf-8"))
            obs = []
            for o in d.get("observations", []):
              v = o.get("value")
              if v in (None, "", "."):
                continue
              obs.append({"date": o.get("date"), "value": v})
            return obs

          result = {}
          for sid, name in SERIES.items():
            try:
              obs = fetch_observations(sid)
              result[sid] = {"name": name, "observations": obs}
              print(f"✓ {sid}: {len(obs)} observations")
            except Exception as e:
              print(f"✗ {sid}: {e}", file=sys.stderr)
              result[sid] = {"name": name, "observations": []}

          output = {
            "updated": datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z",
            "series": result
          }

          os.makedirs("data", exist_ok=True)
          with open("data/fred-data.json", "w", encoding="utf-8") as f:
            json.dump(output, f)

          print("Wrote data/fred-data.json")
          PY

      - name: Commit and push updated data
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/fred-data.json
          git diff --cached --quiet || git commit -m "chore: update FRED data $(date -u +'%Y-%m-%d')"
          git push
