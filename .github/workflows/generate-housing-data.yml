name: Generate Housing Data (LIHTC Per-County Cache)

# Fetches HUD LIHTC data from the ArcGIS FeatureServer and splits it into
# per-county GeoJSON files under data/hna/lihtc/.  These files are used as
# the local-cache (Tier 1) fallback in housing-needs-assessment.js so that
# maps always have data even when the live API is slow or unreachable.
#
# Runs weekly alongside the existing cache-hud-gis-data.yml (QCT/DDA) and
# fetch-chfa-lihtc.yml workflows.

on:
  schedule:
    - cron: '0 6 * * 1'   # Every Monday at 06:00 UTC
  workflow_dispatch:        # Allow manual triggering from the Actions tab

permissions:
  contents: write

jobs:
  generate-lihtc-county-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install --omit=dev node-fetch@2

      - name: Fetch HUD LIHTC data and split by county
        run: |
          node - <<'EOF'
          const fetch = require('node-fetch');
          const fs    = require('fs');
          const path  = require('path');

          // Colorado FIPS codes for all 64 counties
          const CO_COUNTY_FIPS = [
            '08001','08003','08005','08007','08009','08011','08013','08014','08015','08017',
            '08019','08021','08023','08025','08027','08029','08031','08033','08035','08037',
            '08039','08041','08043','08045','08047','08049','08051','08053','08055','08057',
            '08059','08061','08063','08065','08067','08069','08071','08073','08075','08077',
            '08079','08081','08083','08085','08087','08089','08091','08093','08095','08097',
            '08099','08101','08103','08105','08107','08109','08111','08113','08115','08117',
            '08119','08121','08123','08125',
          ];

          const HUD_LIHTC_URL = 'https://services.arcgis.com/VTyQ9soqVukalItT/arcgis/rest/services/LIHTC_Properties/FeatureServer/0/query';
          const PAGE = 1000;

          async function fetchStatewide() {
            const all = { type: 'FeatureCollection', features: [] };
            let offset = 0;
            // Try multiple WHERE filters in order; the first that returns features wins.
            const WHERE_CANDIDATES = [
              "CNTY_FIPS LIKE '08%'",
              "PROJ_ST='CO'",
              "STATEFP='08'",
              "STATE='CO'",
              "1=1",
            ];
            for (const where of WHERE_CANDIDATES) {
              all.features = [];
              offset = 0;
              try {
                while (true) {
                  const p = new URLSearchParams({
                    where, outFields: '*',
                    returnGeometry: 'true', f: 'geojson',
                    outSR: '4326', resultRecordCount: String(PAGE), resultOffset: String(offset),
                  });
                  const res = await fetch(`${HUD_LIHTC_URL}?${p}`);
                  if (!res.ok) throw new Error(`HTTP ${res.status}`);
                  const gj = await res.json();
                  if (gj.error) throw new Error(JSON.stringify(gj.error));
                  const feats = gj.features || [];
                  all.features.push(...feats);
                  if (feats.length < PAGE) break;
                  offset += PAGE;
                  if (offset > 100000) break; // safety guard
                }
                if (all.features.length > 0) {
                  console.log(`Fetched ${all.features.length} LIHTC features (where: ${where})`);
                  return all;
                }
                console.warn(`LIHTC where="${where}" returned 0 features, trying next filter`);
              } catch (err) {
                console.warn(`LIHTC where="${where}" failed: ${err.message}`);
              }
            }
            return all; // empty if all filters failed
          }

          async function run() {
            const outDir = path.join('data', 'hna', 'lihtc');
            fs.mkdirSync(outDir, { recursive: true });

            // Initialize empty GeoJSON for every county so files always exist
            const countyMap = {};
            for (const fips5 of CO_COUNTY_FIPS) {
              countyMap[fips5] = { type: 'FeatureCollection', features: [] };
            }

            let statewide;
            try {
              statewide = await fetchStatewide();
            } catch (err) {
              console.error('LIHTC fetch failed entirely:', err.message);
              statewide = { type: 'FeatureCollection', features: [] };
            }

            // Split features by county
            for (const feat of statewide.features) {
              const p = feat.properties || {};
              // CNTY_FIPS is 5-digit (e.g. '08031'); fall back to constructing from STATEFP+COUNTYFP
              const fips5 = p.CNTY_FIPS ||
                (p.STATEFP && p.COUNTYFP ? p.STATEFP + p.COUNTYFP : null);
              if (fips5 && countyMap[fips5]) {
                countyMap[fips5].features.push(feat);
              }
            }

            // Write per-county files
            let written = 0;
            for (const [fips5, gj] of Object.entries(countyMap)) {
              const filePath = path.join(outDir, `${fips5}.json`);
              fs.writeFileSync(filePath, JSON.stringify(gj));
              written++;
            }
            console.log(`Wrote ${written} county LIHTC files to ${outDir}/`);
            if (statewide.features.length === 0) {
              console.warn('WARNING: No LIHTC features fetched â€” placeholder empty files were written.');
            }
          }

          run().catch(err => { console.error(err.message); process.exit(1); });
          EOF

      - name: Commit and push per-county LIHTC files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/hna/lihtc/
          if git diff --cached --quiet; then
            echo "No changes to LIHTC county files"
          else
            git commit -m "chore: update HUD LIHTC per-county cache [$(date -u '+%Y-%m-%d')]"
            git pull --rebase origin main
            git push
          fi
