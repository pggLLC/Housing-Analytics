name: Fetch Census ACS Data

on:
  schedule:
    - cron: '30 6 * * *'   # daily at 06:30 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-census:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build data/census-acs-state.json from Census API (ACS 5-year)
        env:
          CENSUS_API_KEY: ${{ secrets.CENSUS_API_KEY }}
        run: |
          python3 - <<'PY'
          import json, os, sys, datetime, urllib.request, urllib.parse

          api_key = os.environ.get("CENSUS_API_KEY", "").strip()
          if not api_key:
            print("ERROR: Missing CENSUS_API_KEY secret. Add it in GitHub repo settings: Settings → Secrets and variables → Actions.", file=sys.stderr)
            sys.exit(1)

          # We try several recent ACS 5-year vintages (newer to older) for robustness.
          # The Census API publishes new vintages on its own cadence; this avoids breakage.
          candidate_years = []
          now = datetime.datetime.utcnow()
          # Try current year-1 down to year-5 (e.g., 2025..2021 when now=2026)
          for y in range(now.year - 1, now.year - 6, -1):
            candidate_years.append(y)

          # State-level ACS 5-year variables (keep small + high-signal)
          # Codes are ACS table variables (E=estimate).
          VARS = {
            "B01001_001E": "population_total",
            "B19013_001E": "median_household_income",
            "B25064_001E": "median_gross_rent",
            "B25077_001E": "median_home_value",
            "B25003_001E": "housing_units_total",
            "B25003_002E": "owner_occupied",
            "B25003_003E": "renter_occupied",
            "B25034_001E": "housing_units_year_built_total",
            "B25034_010E": "built_2010_or_later",
          }

          def fetch_json(url: str):
            with urllib.request.urlopen(url, timeout=60) as r:
              return json.loads(r.read().decode("utf-8"))

          def build_url(year: int) -> str:
            base = f"https://api.census.gov/data/{year}/acs/acs5"
            get_vars = ",".join(["NAME"] + list(VARS.keys()))
            params = {
              "get": get_vars,
              "for": "state:*",
              "key": api_key,
            }
            return base + "?" + urllib.parse.urlencode(params)

          data = None
          used_year = None
          last_err = None
          for y in candidate_years:
            try:
              url = build_url(y)
              payload = fetch_json(url)
              # Expect header + rows
              if isinstance(payload, list) and len(payload) > 1:
                data = payload
                used_year = y
                break
            except Exception as e:
              last_err = str(e)

          if data is None or used_year is None:
            print("ERROR: Could not fetch ACS 5-year data for any candidate year.", file=sys.stderr)
            if last_err:
              print("Last error:", last_err, file=sys.stderr)
            sys.exit(1)

          header = data[0]
          rows = data[1:]

          # Map headers to indices
          idx = {h: i for i, h in enumerate(header)}

          def to_int(val):
            try:
              return int(val)
            except:
              return None

          out_rows = []
          for r in rows:
            name = r[idx["NAME"]]
            state_fips = r[idx["state"]]
            rec = {
              "state_name": name,
              "state_fips": state_fips,
              "year": used_year,
            }
            for k, friendly in VARS.items():
              rec[friendly] = to_int(r[idx[k]]) if k in idx else None
            # Derived: renter share (if denominators exist)
            hu = rec.get("housing_units_total") or 0
            renters = rec.get("renter_occupied") or 0
            rec["renter_share"] = (renters / hu) if hu else None
            out_rows.append(rec)

          out_obj = {
            "meta": {
              "source": "U.S. Census Bureau API (ACS 5-year)",
              "dataset": f"{used_year}/acs/acs5",
              "pulled_at_utc": datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z",
              "geography": "state",
              "variables": VARS,
              "notes": "State-level ACS 5-year estimates. Year is auto-selected from recent candidates for robustness.",
            },
            "data": out_rows,
          }

          os.makedirs("data", exist_ok=True)
          with open("data/census-acs-state.json", "w", encoding="utf-8") as f:
            json.dump(out_obj, f, ensure_ascii=False, indent=2)

          print(f"Wrote data/census-acs-state.json using ACS {used_year} 5-year.")
          PY

      - name: Commit and push updated Census data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/census-acs-state.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update Census ACS state data"
            git pull --rebase origin main
            git push
          fi
