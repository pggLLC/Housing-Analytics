<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2026 Federal LIHTC Information by State | Affordable Housing Intelligence</title>
  <meta name="description" content="Interactive map showing Low-Income Housing Tax Credit allocations across all 50 states.">
  <link rel="stylesheet" href="css/site-theme.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/pages.css">
    <script src="js/path-resolver.js"></script>
  <script src="js/config.js"></script>
  <script src="js/fetch-helper.js"></script>
  <script src="js/data-service-portable.js"></script>
  <script src="js/scroll-fix.js"></script>
<script src="js/vendor/d3.v7.min.js"></script>
  <script src="js/vendor/topojson.v3.min.js"></script>
  <script src="js/state-allocations-2026.js"></script>
  <script defer src="js/navigation.js"></script>
  <script defer src="js/dark-mode-toggle.js"></script>
  <script defer src="js/mobile-menu.js"></script>
  <style>
    /* Map tooltip */
    .map-tooltip {
      position: fixed;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--sp3);
      font-size: var(--small);
      box-shadow: var(--shadow);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      z-index: 100;
    }
    .map-tooltip.visible { opacity: 1; }
    .map-tooltip .tooltip-title { font-weight: 700; color: var(--text-strong); margin-bottom: 0.4rem; }
    .map-tooltip .tooltip-data { color: var(--muted); line-height: 1.7; }

    /* State paths */
    .state { cursor: pointer; transition: opacity 0.15s; }
    .state:hover { opacity: 0.8; }

    /* Stats grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--sp3); margin-bottom: var(--sp4); }
  </style>
</head>
<body>
  <a class="skip-link" href="#main-content">Skip to main content</a>

  <main id="main-content">
    <div class="dashboard-wrap">

      <div class="page-hero" style="border:none;padding-left:0;padding-right:0;">
        <span class="kicker">2026 Data</span>
        <h1>Federal LIHTC Allocations by State</h1>
        <p class="page-sub">Interactive map showing Low-Income Housing Tax Credit allocations across all 50 states and D.C.</p>
      </div>

      <!-- Statistics Cards -->
      <div class="stats-grid" id="statistics">
        <div class="stat-card"><div class="stat-value" id="total-allocation">—</div><div class="stat-label">Total Allocation</div></div>
        <div class="stat-card"><div class="stat-value" id="confirmed-states">—</div><div class="stat-label">Confirmed States</div></div>
        <div class="stat-card"><div class="stat-value" id="avg-per-capita">—</div><div class="stat-label">Average Per Capita</div></div>
        <div class="stat-card"><div class="stat-value" id="largest-state">—</div><div class="stat-label" id="largest-amount">Largest Allocation</div></div>
      </div>

      <!-- Map -->
      <section class="chart-card" id="map" aria-label="US state allocation map">
        <div class="chart-header">
          <h2 class="chart-title">Interactive US State Map</h2>
          <p class="chart-subtitle">Click any state to see detailed allocation information. Colors indicate per-capita allocation amounts.</p>
        </div>
        <div id="us-map-container" style="width:100%;overflow:hidden;">
          <svg id="us-map" style="width:100%;height:auto;"></svg>
        </div>

        <!-- Legend -->
        <div style="display:flex;flex-wrap:wrap;gap:var(--sp3);align-items:center;margin-top:var(--sp3);padding-top:var(--sp3);border-top:1px solid var(--border);">
          <span style="font-size:var(--tiny);font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);">Per Capita:</span>
          <div style="display:flex;gap:0.4rem;align-items:center;font-size:var(--tiny);color:var(--muted);">
            <span style="display:inline-block;width:32px;height:14px;border-radius:3px;background:#cfe2f3;"></span> Low
          </div>
          <div style="display:flex;gap:0.4rem;align-items:center;font-size:var(--tiny);color:var(--muted);">
            <span style="display:inline-block;width:32px;height:14px;border-radius:3px;background:#6aaed6;"></span> Mid
          </div>
          <div style="display:flex;gap:0.4rem;align-items:center;font-size:var(--tiny);color:var(--muted);">
            <span style="display:inline-block;width:32px;height:14px;border-radius:3px;background:#2171b5;"></span> High
          </div>
          <div style="display:flex;gap:0.4rem;align-items:center;font-size:var(--tiny);color:var(--muted);">
            <span style="display:inline-block;width:32px;height:14px;border-radius:3px;background:#08306b;"></span> Highest
          </div>
        </div>

        <!-- Source -->
        <div style="background:var(--bg2);border-left:3px solid var(--accent2);border-radius:0 var(--radius-sm) var(--radius-sm) 0;padding:var(--sp3);margin-top:var(--sp3);">
          <p style="margin:0 0 0.3rem;font-size:var(--small);"><strong>Data Source:</strong>
            <a href="https://www.novoco.com/resource-centers/affordable-housing-tax-credits/2026-federal-lihtc-information-by-state" rel="noopener" target="_blank" style="color:var(--link);">Novogradac — 2026 Federal LIHTC Information by State</a>
          </p>
          <p style="margin:0;font-size:var(--tiny);color:var(--faint);">Last Updated: February 2026 · Update Frequency: Quarterly · 27 states confirmed, 23 states estimated pending official confirmation.</p>
        </div>
      </section>

      <!-- Tables -->
      <section style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:var(--sp4);margin-top:var(--sp4);" aria-label="Allocation tables">
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Top 10 States by Total Allocation</h3>
          </div>
          <div class="data-table">
            <table>
              <thead><tr><th>#</th><th>State</th><th>Allocation</th><th>Per Capita</th></tr></thead>
              <tbody id="top-states-body"><tr><td colspan="4" style="text-align:center;padding:var(--sp4);color:var(--muted);">Loading data…</td></tr></tbody>
            </table>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Highest Per Capita Allocations</h3>
          </div>
          <div class="data-table">
            <table>
              <thead><tr><th>#</th><th>State</th><th>Per Capita</th><th>Total</th></tr></thead>
              <tbody id="per-capita-body"><tr><td colspan="4" style="text-align:center;padding:var(--sp4);color:var(--muted);">Loading data…</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Tooltip -->
  <div class="map-tooltip" id="map-tooltip">
    <div class="tooltip-title" id="tooltip-title"></div>
    <div class="tooltip-data" id="tooltip-data"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const fmt = n => '$' + (Number(n)||0).toLocaleString();
      const fmtN = (n, d=2) => (Number(n)||0).toFixed(d);

      const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };

      const waitForData = (tries = 0) => {
        const ds = window.StateAllocations2026;
        if (ds && ds.states) return init(ds);
        if (tries > 60) { console.error('StateAllocations2026 not found'); return; }
        setTimeout(() => waitForData(tries + 1), 120);
      };

      const init = (ds) => {
        const rows = Object.entries(ds.states).map(([abbr, s]) => ({ abbr, ...s }));
        const total = rows.reduce((sum, s) => sum + (Number(s.allocation) || 0), 0);
        const confirmed = rows.filter(s => Number(s.allocation || 0) > 0).length;
        const largest = rows.slice().sort((a, b) => (Number(b.allocation)||0) - (Number(a.allocation)||0))[0];
        const avgPerCap = rows.reduce((sum, s) => sum + (Number(s.perCapita)||0), 0) / (rows.length || 1);

        setText('total-allocation', fmt(total));
        setText('confirmed-states', String(confirmed));
        setText('largest-state', largest?.name || largest?.abbr || '—');
        setText('largest-amount', fmt(largest?.allocation || 0));
        setText('avg-per-capita', '$' + fmtN(avgPerCap));

        const topBody = document.getElementById('top-states-body');
        if (topBody) {
          const top10 = rows.slice().sort((a, b) => (Number(b.allocation)||0) - (Number(a.allocation)||0)).slice(0, 10);
          topBody.innerHTML = top10.map((s, i) => `<tr><td>${i+1}</td><td>${s.name||s.abbr}</td><td>${fmt(s.allocation||0)}</td><td>$${fmtN(s.perCapita||0)}</td></tr>`).join('');
        }
        const perCapBody = document.getElementById('per-capita-body');
        if (perCapBody) {
          const top = rows.slice().sort((a, b) => (Number(b.perCapita)||0) - (Number(a.perCapita)||0)).slice(0, 10);
          perCapBody.innerHTML = top.map((s, i) => `<tr><td>${i+1}</td><td>${s.name||s.abbr}</td><td>$${fmtN(s.perCapita||0)}</td><td>${fmt(s.allocation||0)}</td></tr>`).join('');
        }

        renderMap(ds, total);
      };

      const renderMap = (ds, total) => {
        const container = document.getElementById('us-map-container');
        const svg = document.getElementById('us-map');
        if (!container || !svg) return;

        svg.innerHTML = '';
        const width = container.clientWidth || 960;
        const height = Math.round(width * 0.55);
        svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

        const tip = document.getElementById('map-tooltip');
        const tipTitle = document.getElementById('tooltip-title');
        const tipData = document.getElementById('tooltip-data');
        const showTip = (x, y, title, html) => { if (tipTitle) tipTitle.textContent = title; if (tipData) tipData.innerHTML = html; if (tip) { tip.style.left = (x + 14) + 'px'; tip.style.top = (y + 14) + 'px'; tip.classList.add('visible'); } };
        const hideTip = () => { if (tip) tip.classList.remove('visible'); };

        const fipsToAbbr = {1:'AL',2:'AK',4:'AZ',5:'AR',6:'CA',8:'CO',9:'CT',10:'DE',11:'DC',12:'FL',13:'GA',15:'HI',16:'ID',17:'IL',18:'IN',19:'IA',20:'KS',21:'KY',22:'LA',23:'ME',24:'MD',25:'MA',26:'MI',27:'MN',28:'MS',29:'MO',30:'MT',31:'NE',32:'NV',33:'NH',34:'NJ',35:'NM',36:'NY',37:'NC',38:'ND',39:'OH',40:'OK',41:'OR',42:'PA',44:'RI',45:'SC',46:'SD',47:'TN',48:'TX',49:'UT',50:'VT',51:'VA',53:'WA',54:'WV',55:'WI',56:'WY'};
        const perCaps = Object.values(ds.states).map(s => Number(s.perCapita) || 0);
        const maxPerCap = Math.max(...perCaps, 1);
        const color = d3.scaleSequential(d3.interpolateBlues).domain([0, maxPerCap]);

        const svgEl = d3.select(svg);

        d3.json('data/states-10m.json').catch(() => d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json')).then(us => {
          const features = topojson.feature(us, us.objects.states).features;
          const proj = d3.geoAlbersUsa().fitSize([width, height], { type: 'FeatureCollection', features });
          const path = d3.geoPath(proj);

          svgEl.append('g').selectAll('path').data(features).join('path')
            .attr('class', 'state')
            .attr('d', path)
            .attr('fill', d => { const abbr = fipsToAbbr[Number(d.id)]; const s = abbr ? ds.states[abbr] : null; return s ? color(Number(s.perCapita)||0) : 'var(--bg3)'; })
            .attr('stroke', 'var(--bg)')
            .attr('stroke-width', 0.7)
            .on('mousemove', (event, d) => {
              const abbr = fipsToAbbr[Number(d.id)];
              const s = abbr ? ds.states[abbr] : null;
              if (!s) return;
              const alloc = Number(s.allocation) || 0;
              const pct = total ? (alloc / total * 100) : 0;
              showTip(event.pageX, event.pageY, `${s.name} (${abbr})`,
                `<div><strong>Total allocation:</strong> ${fmt(alloc)}</div><div><strong>Per-capita:</strong> $${fmtN(s.perCapita||0)}</div><div><strong>% of national:</strong> ${fmtN(pct, 2)}%</div>`);
            })
            .on('mouseleave', hideTip);

          svgEl.append('path').datum(topojson.mesh(us, us.objects.states, (a, b) => a !== b))
            .attr('fill', 'none').attr('stroke', 'var(--bg)').attr('stroke-width', 0.5).attr('d', path);
        }).catch(err => console.error('Map load failed', err));
      };

      waitForData();
    });
  </script>
  <script src="js/contrast-guard.js"></script>
</body>
</html>
