// scripts/deploy-preflight.js
//
// Pre-deployment validation script.  Verifies that all files required for
// GitHub Pages are present at the repository root, have the correct
// case-sensitive filenames, and are non-empty before the Pages artifact is
// assembled.
//
// Usage:
//   node scripts/deploy-preflight.js
//
// Exit code 0 = all checks passed; non-zero = one or more failures.

'use strict';

const fs   = require('fs');
const path = require('path');

const ROOT = path.resolve(__dirname, '..');

let passed = 0;
let failed = 0;

function check(condition, message) {
    if (condition) {
        console.log(`  ✅  ${message}`);
        passed++;
    } else {
        console.error(`  ❌  ${message}`);
        failed++;
    }
}

// Confirms a path exists AND the final path segment matches expected case
// exactly (avoids false-positives on case-insensitive macOS/Windows hosts).
function exists(relPath) {
    const full = path.join(ROOT, relPath);
    if (!fs.existsSync(full)) return false;
    const dir  = path.dirname(full);
    const base = path.basename(full);
    return fs.readdirSync(dir).includes(base);
}

function nonEmpty(relPath) {
    try {
        return fs.statSync(path.join(ROOT, relPath)).size > 0;
    } catch (_) {
        return false;
    }
}

console.log('=== deploy-preflight: checking deployment assets ===\n');

// ---------------------------------------------------------------------------
// Core HTML pages
// ---------------------------------------------------------------------------
console.log('--- HTML pages ---');
const HTML_PAGES = [
    'index.html',
    'housing-needs-assessment.html',
    'economic-dashboard.html',
    'LIHTC-dashboard.html',
    'colorado-deep-dive.html',
    'census-dashboard.html',
    'construction-commodities.html',
    'dashboard.html',
    'regional.html',
    'state-allocation-map.html',
    'housing-legislation-2026.html',
    'about.html',
    'insights.html',
];

for (const page of HTML_PAGES) {
    check(exists(page) && nonEmpty(page), page);
}

// ---------------------------------------------------------------------------
// JavaScript assets (config.js is generated by the workflow — only the
// template needs to be committed)
// ---------------------------------------------------------------------------
console.log('\n--- JavaScript assets ---');
const JS_FILES = [
    'js/config.js.template',
    'js/housing-needs-assessment.js',
    'js/app.js',
    'js/dashboard.js',
    'js/main.js',
    'js/path-resolver.js',
    'js/fetch-helper.js',
    'js/data-service-portable.js',
    'js/vendor/chart.umd.min.js',
    'js/vendor/d3.v7.min.js',
    'js/vendor/leaflet.js',
    'js/vendor/leaflet.css',
    'js/vendor/topojson.v3.min.js',
];

for (const f of JS_FILES) {
    check(exists(f) && nonEmpty(f), f);
}

// js/config.js is generated at deploy time from secrets; confirm it is present
// when this script is run inside the workflow (after the generation step).
if (exists('js/config.js')) {
    check(nonEmpty('js/config.js'), 'js/config.js (generated) is non-empty');
} else {
    console.log('  ℹ️   js/config.js not yet generated (expected before Pages upload)');
}

// ---------------------------------------------------------------------------
// Data files
// ---------------------------------------------------------------------------
console.log('\n--- Data files ---');
const DATA_FILES = [
    'data/allocations.json',
    'data/census-acs-state.json',
    'data/co_ami_gap_by_county.json',
    'data/fred-data.json',
    'data/states-10m.json',
    'data/hna/geo-config.json',
    'data/hna/local-resources.json',
    'data/hna/summary',
    'data/hna/lehd',
    'data/hna/dola_sya',
    'data/hna/projections',
    'data/hna/derived',
];

for (const f of DATA_FILES) {
    check(exists(f), f);
}

// ---------------------------------------------------------------------------
// CSS
// ---------------------------------------------------------------------------
console.log('\n--- CSS ---');
check(exists('css'), 'css/ directory');
if (exists('css')) {
    const cssFiles = fs.readdirSync(path.join(ROOT, 'css')).filter(f => f.endsWith('.css'));
    check(cssFiles.length > 0, `css/ contains ${cssFiles.length} stylesheet(s)`);
}

// ---------------------------------------------------------------------------
// Summary
// ---------------------------------------------------------------------------
console.log('\n' + '='.repeat(52));
console.log(`deploy-preflight: ${passed} passed, ${failed} failed`);

if (failed > 0) {
    console.error('\nPre-flight check FAILED. Fix the issues above before deploying.');
    process.exitCode = 1;
} else {
    console.log('\nPre-flight check PASSED ✅  — safe to proceed with deployment.');
}
