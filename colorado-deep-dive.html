<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Colorado Affordable Housing Deep Dive - LIHTC Analytics Hub</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""/>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>

  <!-- Standard site theme + navigation (matches index/about/insights) -->
  <link rel="stylesheet" href="css/site-theme.css"/>
  <script defer="defer" src="js/navigation.js"></script>

  
  

  <!-- Leaflet (vendored locally ‚Äî no CDN required) -->
  <link rel="stylesheet" href="js/vendor/leaflet.css"/>

  <!-- Chart.js for existing canvases -->
  <script src="js/vendor/chart.umd.min.js"></script>

  

  <style>
    /* KPI grid (economic-dashboard style) */
    .kpi-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: .75rem;
      margin: .25rem 0 1rem;
    }
    @media (max-width: 980px){
      .kpi-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 560px){
      .kpi-grid{ grid-template-columns: 1fr; }
    }
    .kpi-card{
      background: var(--surface, var(--card));
      border: 1px solid var(--border, var(--border));
      border-radius: 14px;
      padding: .85rem .9rem;
    }
    .kpi-value{
      font-weight: 750;
      font-size: 1.15rem;
      line-height: 1.1;
      color: var(--text, var(--text));
      margin-bottom: .25rem;
      letter-spacing: .2px;
    }
    .kpi-label{
      font-size: .85rem;
      color: var(--muted, var(--text2));
      line-height: 1.25;
      margin-bottom: .35rem;
    }
    .kpi-source a{
      font-size: .78rem;
      color: var(--link, var(--link));
      text-decoration: none;
    }
    .kpi-source a:hover{ text-decoration: underline; }
  </style>



  
<style>
/* Colorado Deep Dive page-level layout overrides (core theme comes from css/site-theme.css) */
.page-container { max-width: 1200px; margin: 0 auto; padding: 18px; }

/* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
.chart-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
}
.chart-header { padding: 1rem 1.25rem 0.5rem; }
.chart-title { font-size: 1.05rem; font-weight: 700; margin-bottom: 0.2rem; }
.chart-subtitle { font-size: 0.82rem; color: var(--muted); }

/* ‚îÄ‚îÄ Map section ‚îÄ‚îÄ */
#coMap {
  height: 78vh; min-height: 580px; width: 100%;
  border-radius: 0;
}
.map-controls {
  display: flex; flex-wrap: wrap; gap: 0.6rem;
  align-items: center; padding: 0.65rem 1.25rem;
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
}
.map-controls label {
  display: flex; gap: 0.4rem; align-items: center;
  color: var(--muted); font-size: 0.83rem; font-weight: 600;
  cursor: pointer; padding: 4px 10px;
  border-radius: 999px; border: 1px solid var(--border);
  background: var(--card); transition: background 0.15s;
}
.map-controls label:hover { background: rgba(95,168,255,0.1); color: var(--text); }
.map-controls input[type="checkbox"] { accent-color: var(--accent); width: 14px; height: 14px; }

/* ‚îÄ‚îÄ Map legend ‚îÄ‚îÄ */
.map-legend {
  background: var(--surface) !important;
  color: var(--text) !important;
  border: 1px solid var(--border) !important;
  box-shadow: var(--shadow) !important;
  backdrop-filter: blur(8px);
  padding: 10px 12px; border-radius: 10px;
  font-size: 12px; line-height: 1.3;
}
.map-legend .row { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
.dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; flex-shrink:0; }
.swatch { width: 14px; height: 10px; border-radius: 3px; display: inline-block; border: 1px solid rgba(255,255,255,0.3); flex-shrink:0; }

/* ‚îÄ‚îÄ Leaflet overrides ‚îÄ‚îÄ */
.leaflet-tooltip {
  background: var(--card) !important; color: var(--text) !important;
  border: 1px solid var(--border) !important;
  box-shadow: var(--shadow) !important;
  border-radius: 6px; font-size: 12px;
}
.leaflet-popup-content-wrapper, .leaflet-popup-tip {
  background: var(--card) !important; color: var(--text) !important;
}

/* ‚îÄ‚îÄ KPI grid ‚îÄ‚îÄ */
.kpi-grid {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: .75rem; margin: .25rem 0 1rem;
}
@media (max-width: 700px) { .kpi-grid { grid-template-columns: repeat(2,1fr); } }
.kpi-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 14px; padding: .85rem .9rem;
}
.kpi-value { font-size: 1.15rem; font-weight: 750; line-height: 1.1; margin-bottom: .25rem; }
.kpi-label { font-size: .75rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: .05em; }
.kpi-source { font-size: .7rem; color: var(--faint); margin-top: .3rem; }
.kpi-source a { color: var(--faint); }

/* ‚îÄ‚îÄ Legend swatch in info panel ‚îÄ‚îÄ */
.legend-item { display: flex; gap: 10px; align-items: center; }
h2 { font-size: 1.35rem; font-weight: 700; margin: 1.5rem 0 0.75rem; }
h3 { font-size: 1.05rem; font-weight: 700; }
</style>

<style>
/* Colorado Deep Dive ‚Äî map section */
/* Note: page container padding is handled above to stay consistent across the site */

#coMap {
  height: 78vh;
  min-height: 640px;
  width: 100%;
  border-radius: 0 0 var(--radius-lg, 12px) var(--radius-lg, 12px);
  overflow: hidden;
}

.map-section-header {
  padding: 1rem 1.25rem 0.5rem;
}
.map-section-header h2 { margin: 0 0 0.3rem; }

.map-controls {
  display: flex; flex-wrap: wrap; gap: 0.6rem;
  align-items: center; padding: 0.65rem 1.25rem;
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
}
.map-controls label {
  display: flex; gap: 0.4rem; align-items: center;
  color: var(--muted); font-size: 0.83rem; font-weight: 600;
  cursor: pointer; margin: 0;
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--card);
  transition: background 0.15s, border-color 0.15s;
}
.map-controls label:hover { background: var(--accent-dim); border-color: color-mix(in srgb, var(--accent) 30%, transparent); color: var(--text); }
.map-controls input[type="checkbox"] { accent-color: var(--accent); width: 14px; height: 14px; }

.map-legend {
  background: color-mix(in srgb, var(--card) 92%, transparent) !important;
  color: var(--text) !important;
  border: 1px solid var(--border) !important;
  box-shadow: var(--shadow) !important;
  backdrop-filter: blur(8px);
  padding: 10px 12px;
  border-radius: 10px;
  font-size: 12px;
  line-height: 1.3;
}
.map-legend .row { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
.dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
.swatch { width: 14px; height: 10px; border-radius: 3px; display: inline-block; border: 1px solid var(--border); }

/* Leaflet overrides */
.leaflet-tooltip { background: var(--card) !important; color: var(--text) !important; border: 1px solid var(--border) !important; box-shadow: var(--shadow) !important; }
.leaflet-popup-content-wrapper, .leaflet-popup-tip { background: var(--card) !important; color: var(--text) !important; }

/* ‚îÄ‚îÄ AMI Gap Module ‚îÄ‚îÄ */
#amiGapModule .kpi-grid { grid-template-columns: repeat(4, minmax(0,1fr)); }
@media (max-width: 900px) { #amiGapModule .kpi-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
@media (max-width: 560px) { #amiGapModule .kpi-grid { grid-template-columns: 1fr; } }
#amiGapModule .ami-gap-grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:1.25rem; }
@media (max-width: 760px) { #amiGapModule .ami-gap-grid-2 { grid-template-columns:1fr; } }
.ami-gap-cov-bar {
  margin-top:.35rem; height:6px; border-radius:999px;
  background: linear-gradient(90deg, var(--accent,#0ea5a0) var(--pct,0%), var(--border,rgba(13,31,53,.12)) var(--pct,0%));
}
#amiGapModule .data-table table th { white-space:nowrap; }
#amiGapModule .data-table table td:nth-child(5) { font-weight:600; font-variant-numeric:tabular-nums; }
</style>
</head>

<body data-page="colorado-deep-dive.html">

  <main id="main-content" class="page-container content-shell">
    
<div class="pill" style="margin-bottom:1rem;">Colorado Market Deep Dive</div>
<h1 >Colorado Affordable Housing Market Analysis</h1>
<p style="margin-bottom:2rem;">
            Comprehensive analysis of DDAs, QCTs, LIHTC projects, market dynamics, concessions, foreclosures, and comparative performance
        </p>
<section class="section" aria-label="Key indicators">
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-value">$287M</div>
      <div class="kpi-label">Annual LIHTC Allocation</div>
      <div class="kpi-source"><a href="https://www.novoco.com/resource-centers/affordable-housing-tax-credits" target="_blank" rel="noopener">Source</a></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">78</div>
      <div class="kpi-label">Active Projects</div>
      <div class="kpi-source"><a href="https://www.huduser.gov/lihtc/" target="_blank" rel="noopener">Source</a></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">7.6%</div>
      <div class="kpi-label">Denver Vacancy Rate (Q4 2025)</div>
      <div class="kpi-source"><a href="https://www.cbre.com/insights/books/us-real-estate-market-outlook-2025/multifamily" target="_blank" rel="noopener">Source</a></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">$169</div>
      <div class="kpi-label">Avg Monthly Concession</div>
      <div class="kpi-source"><a href="https://www.cbre.com/insights/books/us-real-estate-market-outlook-2025/multifamily" target="_blank" rel="noopener">Source</a></div>
    </div>
  
</section>

<h2>Interactive Map: DDAs, QCTs &amp; LIHTC Projects</h2>
    <div class="chart-card" style="margin: 1.5rem 0;">
      <div class="chart-header">
        <h3 class="chart-title">Colorado LIHTC Opportunity Zones Map</h3>
        <p class="chart-subtitle">Zoomable Colorado-only map with counties, places, LIHTC projects (HUD), and HUD 2026 QCT/DDA overlays.</p>
      </div>

            <div class="map-controls" role="group" aria-label="Map layers and filters">
        <label><input type="checkbox" id="layerCounties" checked> Counties</label>
        <label><input type="checkbox" id="layerPlaces"> Places</label>
        <label><input type="checkbox" id="layerQCT" checked> QCT 2026</label>
        <label><input type="checkbox" id="layerDDA" checked> DDA 2026</label>
        <label><input type="checkbox" id="layerTransport"> Transportation</label>
        <label><input type="checkbox" id="filterQCT"> Only QCT projects</label>
        <label><input type="checkbox" id="filterDDA"> Only DDA projects</label>
        <label style="gap:.5rem;">
          Basemap
          <select id="basemapSelect" style="margin-left:.25rem; padding:.2rem .5rem; border-radius:10px; border:1px solid var(--border); background:var(--card); color:var(--text); font-size:.82rem;">
            <option value="auto" selected>Auto</option>
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
        </label>
        <span id="map-status" style="margin-left:auto; font-size:0.78rem; color:var(--faint);"></span>
      </div>
      <div id="coMap"></div></div>

      <div style="margin-top: 1rem; padding: 1rem; background: var(--color-background-alt, rgba(17,26,36,.65)); border-radius: 8px; border: 1px solid var(--border);">
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: .75rem;">
          <div class="legend-item" style="display:flex; gap:10px; align-items:center;">
            <span class="swatch" style="background:rgba(255,200,90,.20); border-color:rgba(255,200,90,.45)"></span>
            <span><strong>DDA Zones</strong> ‚Äî 30% basis boost</span>
          </div>
          <div class="legend-item" style="display:flex; gap:10px; align-items:center;">
            <span class="swatch" style="background:rgba(120,255,170,.22); border-color:rgba(120,255,170,.45)"></span>
            <span><strong>QCT Zones</strong> ‚Äî 30% basis boost</span>
          </div>
          <div class="legend-item" style="display:flex; gap:10px; align-items:center;">
            <span class="dot" style="background:#5fa8ff;"></span>
            <span><strong>LIHTC Projects</strong> ‚Äî HUD LIHTC Database (mapped)</span>
          </div>
        </div>

        <div style="margin-top:.75rem; font-size: 12px; color: var(--muted); line-height:1.5;">
          <strong>Data sources:</strong>
          <a href="https://www.policymap.com/data/sources/hud-lihtc" target="_blank" rel="noopener">PolicyMap: HUD LIHTC</a> ‚Ä¢
          <a href="https://www.huduser.gov/lihtc/" target="_blank" rel="noopener">HUD LIHTC Database</a> ‚Ä¢
          <a href="https://egis.hud.gov/arcgis/rest/services/affht/AffhtMapService/MapServer/30" target="_blank" rel="noopener">HUD eGIS LIHTC map service</a> ‚Ä¢
          <a href="https://www.huduser.gov/portal/sadda/sadda_qct.html" target="_blank" rel="noopener">HUD QCT/DDA</a>
        </div>
      </div>
    </div>

    <h2>Area Median Income (AMI) Analysis</h2>
<div class="dashboard-grid" style="margin: 2rem 0;">
<div class="chart-card">
<div class="chart-header">
<h3 class="chart-title">Denver Metro AMI Breakdown (2025)</h3>
<p class="chart-subtitle">Income limits by household size</p>
</div>
<div class="data-table">
<table>
<thead>
<tr>
<th>AMI Level</th>
<th>1 Person</th>
<th>2 Person</th>
<th>3 Person</th>
<th>4 Person</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>30% AMI</strong> (Extremely Low)</td>
<td>$26,100</td>
<td>$29,850</td>
<td>$33,600</td>
<td>$37,350</td>
</tr>
<tr>
<td><strong>50% AMI</strong> (Very Low)</td>
<td>$43,450</td>
<td>$49,650</td>
<td>$55,850</td>
<td>$62,050</td>
</tr>
<tr>
<td><strong>60% AMI</strong> (LIHTC Standard)</td>
<td>$52,140</td>
<td>$59,580</td>
<td>$67,020</td>
<td>$74,460</td>
</tr>
<tr style="background: rgba(52, 152, 219, 0.1);">
<td><strong>80% AMI</strong> (Low Income)</td>
<td>$66,300</td>
<td>$75,750</td>
<td>$85,200</td>
<td>$94,650</td>
</tr>
<tr>
<td><strong>100% AMI</strong> (Median)</td>
<td>$86,870</td>
<td>$99,300</td>
<td>$111,700</td>
<td>$124,100</td>
</tr>
</tbody>
</table>
</div>
<div style="margin-top: 1rem; padding: 1rem; background: rgba(243, 156, 18, 0.1); border-radius: 4px; border-left: 3px solid var(--color-warning);">
<p style="font-size: 0.875rem; margin: 0; line-height: 1.6;">
<strong>Context:</strong> In Denver, a single person making $31.88/hour ($66,300 annually) is considered "low income" at 80% AMI. This creates significant affordable housing demand even among working professionals.
                    </p>
</div>
</div>
<div class="chart-card">
<div class="chart-header">
<h3 class="chart-title">Colorado Housing Need by AMI Level</h3>
<p class="chart-subtitle">Estimated households vs. available units</p>
</div>
<div style="height: 300px; position: relative;">
<canvas id="ami-need-chart"></canvas>
</div>
</div>
</div>
<div class="chart-card" style="margin: 2rem 0;">
<h3 style="color: var(--color-primary); margin-bottom: 1.5rem;">AMI Variations Across Colorado Counties</h3>
<div class="data-table">
<table>
<thead>
<tr>
<th>County</th>
<th>1-Person AMI (100%)</th>
<th>4-Person AMI (100%)</th>
<th>60% AMI Max Income</th>
<th>Relative Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Denver</strong></td>
<td>$86,870</td>
<td>$124,100</td>
<td>$74,460</td>
<td>High</td>
</tr>
<tr>
<td><strong>Boulder</strong></td>
<td>$92,400</td>
<td>$131,900</td>
<td>$79,140</td>
<td>Very High</td>
</tr>
<tr>
<td><strong>El Paso (C. Springs)</strong></td>
<td>$78,200</td>
<td>$111,700</td>
<td>$67,020</td>
<td>Moderate</td>
</tr>
<tr>
<td><strong>Larimer (Ft. Collins)</strong></td>
<td>$84,300</td>
<td>$120,400</td>
<td>$72,240</td>
<td>Moderate-High</td>
</tr>
<tr>
<td><strong>Pueblo</strong></td>
<td>$61,500</td>
<td>$87,900</td>
<td>$52,740</td>
<td>Lower</td>
</tr>
</tbody>
</table>
</div>
</div>
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     Colorado AMI Households vs Available Units ‚Äî Interactive
     Powered by js/co-ami-gap.js + data/co_ami_gap_by_county.json
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section id="amiGapModule" aria-label="Colorado AMI Households vs Available Units" style="margin: 2rem 0;">

  <div style="display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:.75rem; margin-bottom:1rem;">
    <div>
      <h2 style="margin:0 0 .2rem;">Colorado AMI Households vs Available Units</h2>
      <p style="margin:0; color:var(--muted); font-size:.88rem;">
        Affordability gap by AMI level ‚Äî households at or below income threshold vs. priced-affordable rental units
      </p>
    </div>
    <div style="display:flex; align-items:center; gap:.6rem; flex-wrap:wrap;">
      <label for="amiGapCountySelect" style="font-size:.83rem; font-weight:600; color:var(--muted);">County / Region:</label>
      <select id="amiGapCountySelect"
              style="padding:.35rem .75rem; border-radius:8px; border:1px solid var(--border); background:var(--card); color:var(--text); font-size:.85rem; min-width:200px; cursor:pointer;">
        <option value="STATE">Colorado (statewide)</option>
      </select>
    </div>
  </div>

  <!-- Error banner -->
  <div id="amiGapError" role="alert"
       style="display:none; padding:.75rem 1rem; margin-bottom:1rem; background:rgba(224,82,82,.1); border:1px solid rgba(224,82,82,.35); border-radius:8px; color:var(--bad,#e05252); font-size:.87rem;"></div>

  <!-- Metadata bar -->
  <div id="amiGapMeta" style="font-size:.78rem; color:var(--faint); margin-bottom:1rem;"></div>

  <!-- KPI Summary Cards -->
  <div class="kpi-grid" style="grid-template-columns:repeat(4,minmax(0,1fr)); margin-bottom:1.25rem;">
    <div class="kpi-card">
      <div id="amiGapGeoTitle" class="kpi-value" style="font-size:1rem;">Colorado (statewide)</div>
      <div class="kpi-label">Selected Geography</div>
    </div>
    <div class="kpi-card">
      <div id="amiGapAmi4" class="kpi-value">‚Äî</div>
      <div class="kpi-label">4-Person AMI (100%)</div>
      <div class="kpi-source">HUD FY2025 Income Limits</div>
    </div>
    <div class="kpi-card">
      <div id="amiGapHouseholds100" class="kpi-value">‚Äî</div>
      <div class="kpi-label">Households ‚â§ 100% AMI</div>
      <div class="kpi-source">ACS B19001</div>
    </div>
    <div class="kpi-card">
      <div id="amiGapUnits100" class="kpi-value">‚Äî</div>
      <div class="kpi-label">Affordable Units ‚â§ 100% AMI</div>
      <div class="kpi-source">ACS B25063</div>
    </div>
  </div>

  <!-- Main comparison chart: households vs units -->
  <div class="chart-card" style="margin-bottom:1.25rem;">
    <div class="chart-header">
      <h3 class="chart-title">Households vs. Priced-Affordable Units by AMI Level</h3>
      <p class="chart-subtitle">Blue = households with income at or below threshold ¬∑ Green = rental units with rent at or below affordable threshold</p>
    </div>
    <div style="height:340px; position:relative; padding:.5rem 1rem 1rem;">
      <canvas id="amiGapComparisonChart" aria-label="Bar chart: households vs affordable units by AMI level"></canvas>
    </div>
  </div>

  <!-- Gap chart + Coverage card side-by-side -->
  <div class="ami-gap-grid-2" style="margin-bottom:1.25rem;">
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Affordability Gap</h3>
        <p class="chart-subtitle">Units minus households at each AMI level ¬∑ Red = deficit ¬∑ Green = surplus</p>
      </div>
      <div style="height:260px; position:relative; padding:.5rem 1rem 1rem;">
        <canvas id="amiGapChart" aria-label="Bar chart: affordability gap by AMI level"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Coverage Ratio at 100% AMI</h3>
        <p class="chart-subtitle">Affordable units √∑ households ¬∑ <50% = critical ¬∑ 50‚Äì80% = moderate gap</p>
      </div>
      <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:260px; gap:.5rem; padding:1rem;">
        <div id="amiGapCoverage100" style="font-size:2.8rem; font-weight:800; line-height:1; letter-spacing:-.02em;">‚Äî</div>
        <div style="font-size:.85rem; color:var(--muted); text-align:center;">rental units priced at or below 100% AMI affordable threshold per household at that income level</div>
        <div style="width:100%; max-width:260px; margin-top:.5rem;">
          <div style="height:8px; border-radius:999px; background:var(--border); overflow:hidden;">
            <div id="amiGapCovBar" style="height:100%; border-radius:999px; background:var(--accent); transition:width .4s ease; width:0%"></div>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:.72rem; color:var(--faint); margin-top:.3rem;">
            <span>0%</span><span>50%</span><span>100%</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Data table -->
  <div class="chart-card" style="margin-bottom:1.25rem;">
    <div class="chart-header">
      <h3 class="chart-title">AMI Gap Detail Table</h3>
      <p class="chart-subtitle">All metrics by AMI band for the selected county/region</p>
    </div>
    <div class="data-table" style="overflow-x:auto; padding:0 .25rem .75rem;">
      <table style="width:100%; min-width:560px;">
        <thead>
          <tr>
            <th>AMI Band</th>
            <th>Affordable Rent<br><span style="font-weight:400;opacity:.7;">(4-person, 30% of income)</span></th>
            <th>Households</th>
            <th>Affordable Units</th>
            <th>Gap (Units ‚àí HH)</th>
            <th>Coverage Ratio</th>
          </tr>
        </thead>
        <tbody id="amiGapTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Methodology -->
  <details style="margin-bottom:.5rem;">
    <summary style="cursor:pointer; font-size:.85rem; font-weight:600; color:var(--muted); padding:.5rem 0; user-select:none;">
      üìã Methodology &amp; Data Sources
    </summary>
    <div id="amiGapMethodology"
         style="margin-top:.6rem; padding:.9rem 1.1rem; background:var(--bg2); border:1px solid var(--border); border-radius:10px; font-size:.83rem; line-height:1.7; color:var(--muted);">
    </div>
  </details>

  <div style="font-size:.75rem; color:var(--faint); margin-top:.5rem;">
    Data endpoint: <code id="amiGapEndpoint" style="font-size:.75rem; background:var(--bg2); padding:1px 4px; border-radius:4px;"></code>
  </div>

</section>

<h2>Multifamily Concessions Analysis</h2>
<div style="background: rgba(192, 57, 43, 0.05); padding: 2rem; border-left: 4px solid var(--color-error); border-radius: 4px; margin: 2rem 0;">
<h3 style="color: var(--color-error); margin-bottom: 1rem;">Critical Market Alert: Record Concessions</h3>
<p style="line-height: 1.7; margin-bottom: 1rem;">
                Metro Denver reached 7.6% vacancy in Q4 2025‚Äîthe highest rate in 16 years‚Äîwith concessions averaging $169 per month (9.5% of gross rent), equivalent to 4-5 weeks of free rent. This represents the highest concession level in the 21-year history of Apartment Insights tracking.
            </p>
<p style="line-height: 1.7; margin: 0;">
<strong>Impact:</strong> New luxury properties offering up to 3 months free rent, creating downward pressure on older Class B/C properties throughout the metro.
            </p>
</div>
<div class="dashboard-grid">
<div class="chart-card">
<div class="chart-header">
<h3 class="chart-title">Denver Metro Concession Trends</h3>
<p class="chart-subtitle">Average monthly concession value 2022-2025</p>
</div>
<div style="height: 300px; position: relative;">
<canvas id="concessions-chart"></canvas>
</div>
</div>
<div class="chart-card">
<div class="chart-header">
<h3 class="chart-title">Concessions by Property Class</h3>
<p class="chart-subtitle">Q4 2025 averages</p>
</div>
<div style="padding: 2rem 0;">
<div style="margin-bottom: 2rem;">
<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
<span><strong>Class A (2020+)</strong></span>
<span style="color: var(--color-error); font-weight: 700;">$285/month</span>
</div>
<div style="background: var(--color-background-alt); border-radius: 4px; height: 8px;">
<div style="background: var(--color-error); width: 95%; height: 100%; border-radius: 4px;"></div>
</div>
<div style="font-size: 0.875rem; color: var(--color-text-muted); margin-top: 0.25rem;">Up to 3 months free rent</div>
</div>
<div style="margin-bottom: 2rem;">
<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
<span><strong>Class B (2000-2019)</strong></span>
<span style="color: var(--color-warning); font-weight: 700;">$150/month</span>
</div>
<div style="background: var(--color-background-alt); border-radius: 4px; height: 8px;">
<div style="background: var(--color-warning); width: 50%; height: 100%; border-radius: 4px;"></div>
</div>
<div style="font-size: 0.875rem; color: var(--color-text-muted); margin-top: 0.25rem;">1-2 months free + gift cards</div>
</div>
<div style="margin-bottom: 2rem;">
<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
<span><strong>Class C (pre-2000)</strong></span>
<span style="color: var(--color-info); font-weight: 700;">$95/month</span>
</div>
<div style="background: var(--color-background-alt); border-radius: 4px; height: 8px;">
<div style="background: var(--color-info); width: 32%; height: 100%; border-radius: 4px;"></div>
</div>
<div style="font-size: 0.875rem; color: var(--color-text-muted); margin-top: 0.25rem;">Selective incentives + waived fees</div>
</div>
</div>
</div>
</div>
<div class="chart-card" style="margin: 2rem 0;">
<h3 style="color: var(--color-primary); margin-bottom: 1.5rem;">Statewide Concession Comparison</h3>
<div class="data-table">
<table>
<thead>
<tr>
<th>Market</th>
<th>Avg Concession</th>
<th>% of Gross Rent</th>
<th>Free Weeks Equivalent</th>
<th>Primary Driver</th>
</tr>
</thead>
<tbody>
<tr style="background: rgba(192, 57, 43, 0.05);">
<td><strong>Denver Metro</strong></td>
<td>$169</td>
<td>9.5%</td>
<td>4-5 weeks</td>
<td>Oversupply (19K units 2024)</td>
</tr>
<tr>
<td><strong>Colorado Springs</strong></td>
<td>$95</td>
<td>6.2%</td>
<td>3 weeks</td>
<td>Moderate supply increase</td>
</tr>
<tr>
<td><strong>Fort Collins</strong></td>
<td>$110</td>
<td>7.1%</td>
<td>3.5 weeks</td>
<td>Student housing competition</td>
</tr>
<tr>
<td><strong>Boulder</strong></td>
<td>$125</td>
<td>6.8%</td>
<td>3.5 weeks</td>
<td>New luxury supply</td>
</tr>
<tr>
<td><strong>Pueblo</strong></td>
<td>$45</td>
<td>4.1%</td>
<td>2 weeks</td>
<td>Limited new construction</td>
</tr>
</tbody>
</table>
</div>
</div>
<h2>Foreclosure &amp; Distress Analysis</h2>
<div class="dashboard-grid">
<div class="chart-card">
<div class="chart-header">
<h3 class="chart-title">Colorado Foreclosure Trends</h3>
<p class="chart-subtitle">Monthly foreclosure filings 2023-2026</p>
</div>
<div style="height: 300px; position: relative;">
<canvas id="foreclosure-chart"></canvas>
</div>
</div>
<div class="chart-card">
<div class="chart-header">
<h3 class="chart-title">Foreclosure Risk Assessment</h3>
<p class="chart-subtitle">Current market health indicators</p>
</div>
<div style="padding: 2rem 0;">
<div style="margin-bottom: 2rem;">
<div style="font-weight: 600; margin-bottom: 0.5rem;">Overall Risk Level</div>
<div style="font-size: 2rem; color: var(--color-success); font-weight: 700; margin-bottom: 0.5rem;">LOW</div>
<div style="font-size: 0.875rem; color: var(--color-text-light);">Well below crisis levels; returning to normal</div>
</div>
<div style="margin-bottom: 1.5rem;">
<div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--color-success);">‚úì Equity Cushion</div>
<div style="font-size: 0.875rem; color: var(--color-text-light);">Most homeowners have significant equity protecting against distress sales</div>
</div>
<div style="margin-bottom: 1.5rem;">
<div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--color-success);">‚úì Employment</div>
<div style="font-size: 0.875rem; color: var(--color-text-light);">Unemployment at 3.7% (4th lowest among 50 largest markets)</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--color-warning);">‚ö† Normalizing</div>
<div style="font-size: 0.875rem; color: var(--color-text-light);">Filings rising but still 56% of pre-pandemic normal levels</div>
</div>
</div>
</div>
</div>
<div style="background: rgba(39, 174, 96, 0.05); padding: 2rem; border-left: 4px solid var(--color-success); border-radius: 4px; margin: 2rem 0;">
<h3 style="color: var(--color-success); margin-bottom: 1rem;">Good News: Market Normalization, Not Crisis</h3>
<p style="line-height: 1.7; margin-bottom: 1rem;">
                While REO (Real Estate Owned) foreclosures are returning after 7+ years absence, this represents market normalization rather than distress. Foreclosure filings remain well below pre-pandemic norms and a fraction of 2008 crisis levels.
            </p>
<p style="line-height: 1.7; margin: 0;">
<strong>Key Factor:</strong> Strong equity positions (most homeowners have substantial equity) and more disciplined lending practices continue to limit systemic risk.
            </p>
</div>
<h2>Consumer Confidence &amp; Market Sentiment</h2>
<div class="dashboard-grid">
<div class="chart-card">
<div class="chart-header">
<h3 class="chart-title">Colorado Housing Market Confidence</h3>
<p class="chart-subtitle">Buyer and seller sentiment index</p>
</div>
<div style="height: 300px; position: relative;">
<canvas id="confidence-chart"></canvas>
</div>
</div>
<div class="chart-card">
<div class="chart-header">
<h3 class="chart-title">Market Dynamics Shift</h3>
<p class="chart-subtitle">2025 vs 2026 outlook</p>
</div>
<div style="padding: 2rem 0;">
<div style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--color-border);">
<div style="font-weight: 600; margin-bottom: 0.75rem; color: var(--color-primary);">2025 Recap</div>
<ul style="font-size: 0.9375rem; line-height: 1.7; margin: 0; padding-left: 1.5rem;">
<li>Prices fell 5.2% in Colorado Springs</li>
<li>Denver rents down 4.8% YoY</li>
<li>Days on market increased significantly</li>
<li>Sellers competing more aggressively</li>
</ul>
</div>
<div>
<div style="font-weight: 600; margin-bottom: 0.75rem; color: var(--color-success);">2026 Outlook</div>
<ul style="font-size: 0.9375rem; line-height: 1.7; margin: 0; padding-left: 1.5rem;">
<li>More of the same: balanced market continuing</li>
<li>New construction drops 34% (supply relief)</li>
<li>Modest price appreciation expected (+1-2%)</li>
<li>Buyers have more negotiating power</li>
</ul>
</div>
</div>
</div>
</div>
<h2>Colorado vs National Comparison</h2>
<div style="background: rgba(192, 57, 43, 0.05); padding: 2.5rem; border-left: 4px solid var(--color-error); border-radius: 8px; margin: 2rem 0;">
<h3 style="color: var(--color-error); margin-bottom: 1rem;">‚ö†Ô∏è Critical Analysis: Colorado Pricing Pressure vs. National Trends</h3>
<p style="font-size: 1.125rem; line-height: 1.8; margin-bottom: 1.5rem;">
<strong>Why is Colorado experiencing pricing pressure while the nation stabilizes at $0.87?</strong>
</p>
<p style="line-height: 1.8; margin-bottom: 1.5rem;">
                Based on late 2025 and early 2026 data, LIHTC investors are acting with <strong>caution toward the Colorado market</strong>, driven by high interest rates, rising construction costs, and a "cautious at best, jittery at worst" equity market. While Denver metro has technically stabilized, it's marked by:
            </p>
<ul style="line-height: 1.8; margin-bottom: 1.5rem;">
<li><strong>5.2% decline in median home prices</strong> (2025)</li>
<li><strong>Increased inventory</strong> and longer days on market</li>
<li><strong>Shift to buyer's market</strong> dynamics</li>
<li><strong>Record concessions</strong> ($169/month avg - highest in 21 years)</li>
</ul>
<p style="line-height: 1.8; margin-bottom: 1rem;">
<strong>Key Insight:</strong> The pressure on pricing in rural areas like the Western Slope is <em>not</em> "for no reason" or Denver-specific fear. Instead, it's driven by a combination of <strong>macroeconomic factors affecting the entire state</strong>.
            </p>
</div>
<div class="chart-card" style="margin: 2rem 0;">
<h3 style="color: var(--color-primary); margin-bottom: 1.5rem;">Key Factors Driving Statewide Pricing Pressure</h3>
<div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--color-background-alt); border-left: 3px solid var(--color-primary); border-radius: 4px;">
<h4 style="margin-bottom: 1rem; color: var(--color-primary);">1. Broad Investor Caution (Not Just Denver)</h4>
<p style="line-height: 1.7;">
                    LIHTC investors are generally cautious in 2025‚Äì2026 due to:
                </p>
<ul style="line-height: 1.8; margin: 1rem 0 0 2rem;">
<li><strong>Potential tax reforms:</strong> Uncertainty about corporate tax rates and LIHTC program changes</li>
<li><strong>Tariff-induced cost increases:</strong> Steel +20-30%, lumber +17%, materials inflation</li>
<li><strong>Elevated operating expenses:</strong> Insurance, utilities, labor costs all rising</li>
<li><strong>Interest rate environment:</strong> Higher costs to finance projects requiring more tax credit equity</li>
</ul>
</div>
<div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--color-background-alt); border-left: 3px solid var(--color-warning); border-radius: 4px;">
<h4 style="margin-bottom: 1rem; color: var(--color-warning);">2. Declining Denver Metro Metrics</h4>
<p style="line-height: 1.7;">
                    The Denver metro area experienced significant headwinds in 2025:
                </p>
<ul style="line-height: 1.8; margin: 1rem 0 0 2rem;">
<li><strong>5.2% price decline:</strong> Median home prices fell substantially</li>
<li><strong>Inventory surge:</strong> More properties on market creating buyer advantage</li>
<li><strong>High operating costs:</strong> Insurance premiums and HOA fees making investors selective</li>
<li><strong>Multifamily oversupply:</strong> 19,000 units delivered in 2024 vs. typical 8,000-10,000</li>
<li><strong>Vacancy spike:</strong> 7.6% (highest in 16 years) putting downward rent pressure</li>
</ul>
</div>
<div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--color-background-alt); border-left: 3px solid var(--color-info); border-radius: 4px;">
<h4 style="margin-bottom: 1rem; color: var(--color-info);">3. Western Slope &amp; Rural Colorado Pressures</h4>
<p style="line-height: 1.7;">
                    The Western Slope is experiencing <strong>its own unique market pressures</strong>, not just spillover from Denver:
                </p>
<ul style="line-height: 1.8; margin: 1rem 0 0 2rem;">
<li><strong>"Buyer's market" emergence:</strong> Second half of 2025 saw shift to buyer advantage</li>
<li><strong>Economic uncertainty:</strong> Tourism/recreation dependent economies facing volatility</li>
<li><strong>Higher risk perception:</strong> Investors more conservative on smaller, remote projects</li>
<li><strong>Limited exit options:</strong> Smaller buyer pool for rural properties if things go wrong</li>
<li><strong>Construction challenges:</strong> Higher costs, limited contractor availability in rural areas</li>
</ul>
</div>
<div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--color-background-alt); border-left: 3px solid var(--color-error); border-radius: 4px;">
<h4 style="margin-bottom: 1rem; color: var(--color-error);">4. Increased Development Costs</h4>
<p style="line-height: 1.7; margin-bottom: 1rem;">
<strong>Total development costs per unit</strong> for LIHTC projects in the Rocky Mountain region have increased by as much as <strong>40% since 2019</strong>, making deals harder to pencil out.
                </p>
<p style="line-height: 1.7;">
                    This cost inflation includes:
                </p>
<ul style="line-height: 1.8; margin: 1rem 0 0 2rem;">
<li><strong>Hard costs:</strong> Construction labor, materials (steel, lumber, concrete)</li>
<li><strong>Soft costs:</strong> Fees, permits, professional services</li>
<li><strong>Financing costs:</strong> Higher interest rates on construction loans</li>
<li><strong>Timeline delays:</strong> Supply chain issues extending construction periods</li>
</ul>
</div>
<div style="padding: 1.5rem; background: rgba(39, 174, 96, 0.05); border-left: 3px solid var(--color-success); border-radius: 4px;">
<h4 style="margin-bottom: 1rem; color: var(--color-success);">5. State-Level Support (Silver Lining)</h4>
<p style="line-height: 1.7;">
                    Despite challenges, Colorado is <strong>actively utilizing state-level tax credits (AHTC)</strong> to support projects:
                </p>
<ul style="line-height: 1.8; margin: 1rem 0 0 2rem;">
<li><strong>2025 AHTC allocations:</strong> Continued investment in both metro and rural areas</li>
<li><strong>Gap financing support:</strong> State and local governments stepping up</li>
<li><strong>CHFA innovations:</strong> Creative structuring to make deals work</li>
<li><strong>Basis boost opportunities:</strong> Strong DDA/QCT coverage helps offset cost increases</li>
</ul>
</div>
</div>
<div class="chart-card" style="margin: 2rem 0;">
<h3 style="color: var(--color-primary); margin-bottom: 1.5rem;">Why Western Slope Pricing is Falling</h3>
<p style="line-height: 1.8; margin-bottom: 1.5rem;">
                The downward pressure on pricing in rural Colorado is <strong>not arbitrary</strong> ‚Äî it's a direct result of:
            </p>
<div style="display: grid; gap: 1.5rem;">
<div style="padding: 1.5rem; background: var(--color-background-alt); border-radius: 8px;">
<h4 style="color: var(--color-primary); margin-bottom: 0.75rem;">üìà High Interest Costs</h4>
<p style="line-height: 1.7; margin: 0;">
                        The cost to finance projects has increased significantly. Construction loans that were 4-5% are now 7-8%, requiring <strong>more tax credit equity</strong> to make projects viable. Rural projects, being smaller and perceived as higher-risk, face even higher rates.
                    </p>
</div>
<div style="padding: 1.5rem; background: var(--color-background-alt); border-radius: 8px;">
<h4 style="color: var(--color-primary); margin-bottom: 0.75rem;">‚ö†Ô∏è Increased Risk Perception</h4>
<p style="line-height: 1.7; margin: 0;">
                        Investors are, in general, <strong>more conservative</strong> in 2025-2026. This disproportionately impacts <strong>smaller or more remote projects</strong> (rural) often more than large urban ones. Reasons include: limited market depth, fewer comparable projects, longer lease-up periods, and concentrated tenant base risk.
                    </p>
</div>
<div style="padding: 1.5rem; background: var(--color-background-alt); border-radius: 8px;">
<h4 style="color: var(--color-primary); margin-bottom: 0.75rem;">üí∞ Construction Cost Inflation Squeeze</h4>
<p style="line-height: 1.7; margin: 0;">
                        The <strong>40% increase in development costs</strong> since 2019, coupled with potential tariff impacts on materials, is squeezing project budgets. Rural projects face: higher per-unit costs (smaller scale = less efficiency), limited contractor availability, and material shipping costs.
                    </p>
</div>
<div style="padding: 1.5rem; background: var(--color-background-alt); border-radius: 8px;">
<h4 style="color: var(--color-primary); margin-bottom: 0.75rem;">üìä National Capital Crunch</h4>
<p style="line-height: 1.7; margin: 0;">
                        This isn't localized fear of Denver. It's a broader, <strong>state-wide and national tightening</strong> of affordable housing "budget gaps" and "capital crunch." Investors with limited capital are prioritizing: larger deals (better returns per effort), proven markets (lower perceived risk), and urban locations (better exit strategies).
                    </p>
</div>
</div>
</div>
<div style="background: var(--color-primary-dark); color: white; padding: 2.5rem; border-radius: 8px; margin: 2rem 0;">
<h3 style="color: white; margin-bottom: 1rem;">Bottom Line: It's Economics, Not Fear</h3>
<p style="line-height: 1.8; margin-bottom: 1rem; opacity: 0.95;">
                Colorado's pricing pressure‚Äîboth in Denver metro and Western Slope‚Äîstems from <strong>fundamental economic factors</strong>, not irrational "fear" of any specific market. The state faces a <strong>perfect storm</strong> of:
            </p>
<ul style="line-height: 1.8; margin-bottom: 1rem; opacity: 0.95;">
<li>40% cost increases since 2019</li>
<li>High interest rate environment</li>
<li>Oversupply in Denver creating vacancy concerns</li>
<li>General investor conservatism amid tax reform uncertainty</li>
<li>Tariff-driven materials inflation</li>
</ul>
<p style="line-height: 1.8; margin: 0; opacity: 0.95;">
<strong>For rural Colorado:</strong> Pricing weakness reflects <em>rational</em> investor response to higher costs and perceived risks in smaller markets, not a "leary" view of Denver spilling over. Different challenges, same macroeconomic drivers.
            </p>
</div>
<h2>Colorado vs National Comparison</h2>
<div class="chart-card" style="margin: 2rem 0;">
<div class="chart-header">
<h3 class="chart-title">Key Metrics: Colorado vs U.S. Average</h3>
<p class="chart-subtitle">How Colorado stacks up against national trends</p>
</div>
<div class="comparison-grid">
<div style="padding: 1.5rem; background: var(--color-background-alt); border-radius: 8px; text-align: center;">
<div style="font-size: 0.875rem; color: var(--color-text-muted); margin-bottom: 0.5rem;">LIHTC Allocation Per Capita</div>
<div style="font-size: 2rem; font-weight: 700; color: var(--color-primary); margin-bottom: 0.25rem;">$49</div>
<div style="font-size: 0.875rem; color: var(--color-success);">‚Üë 8% above national avg</div>
</div>
<div style="padding: 1.5rem; background: var(--color-background-alt); border-radius: 8px; text-align: center;">
<div style="font-size: 0.875rem; color: var(--color-text-muted); margin-bottom: 0.5rem;">Multifamily Vacancy Rate</div>
<div style="font-size: 2rem; font-weight: 700; color: var(--color-error); margin-bottom: 0.25rem;">7.6%</div>
<div style="font-size: 0.875rem; color: var(--color-error);">‚Üë Above national 5.8%</div>
</div>
<div style="padding: 1.5rem; background: var(--color-background-alt); border-radius: 8px; text-align: center;">
<div style="font-size: 0.875rem; color: var(--color-text-muted); margin-bottom: 0.5rem;">Rent Growth (YoY)</div>
<div style="font-size: 2rem; font-weight: 700; color: var(--color-error); margin-bottom: 0.25rem;">-4.8%</div>
<div style="font-size: 0.875rem; color: var(--color-error);">‚Üì vs U.S. +1.0%</div>
</div>
<div style="padding: 1.5rem; background: var(--color-background-alt); border-radius: 8px; text-align: center;">
<div style="font-size: 0.875rem; color: var(--color-text-muted); margin-bottom: 0.5rem;">Credit Pricing (9%)</div>
<div style="font-size: 2rem; font-weight: 700; color: var(--color-primary); margin-bottom: 0.25rem;">$0.87</div>
<div style="font-size: 0.875rem; color: var(--color-info);">= At national average</div>
</div>
<div style="padding: 1.5rem; background: var(--color-background-alt); border-radius: 8px; text-align: center;">
<div style="font-size: 0.875rem; color: var(--color-text-muted); margin-bottom: 0.5rem;">Unemployment Rate</div>
<div style="font-size: 2rem; font-weight: 700; color: var(--color-success); margin-bottom: 0.25rem;">3.7%</div>
<div style="font-size: 0.875rem; color: var(--color-success);">‚Üì 4th lowest in nation</div>
</div>
<div style="padding: 1.5rem; background: var(--color-background-alt); border-radius: 8px; text-align: center;">
<div style="font-size: 0.875rem; color: var(--color-text-muted); margin-bottom: 0.5rem;">Foreclosure Risk</div>
<div style="font-size: 2rem; font-weight: 700; color: var(--color-success); margin-bottom: 0.25rem;">LOW</div>
<div style="font-size: 0.875rem; color: var(--color-success);">‚úì Better than average</div>
</div>
</div>
</div>
<div class="chart-card" style="margin: 2rem 0;">
<div class="chart-header">
<h3 class="chart-title">Comparative Dashboard Performance</h3>
<p class="chart-subtitle">Colorado metrics vs dashboard trends</p>
</div>
<div style="height: 400px; position: relative;">
<canvas id="comparison-chart"></canvas>
</div>
</div>
<h2>Market Outlook &amp; Strategic Implications</h2>
<div style="display: grid; gap: 2rem; margin: 1.25rem 0;">
<div class="chart-card">
<h3 style="color: var(--color-primary); margin-bottom: 1.5rem;">For LIHTC Developers</h3>
<div style="background: rgba(52, 152, 219, 0.05); padding: 1.5rem; border-left: 3px solid var(--color-info); border-radius: 4px; margin-bottom: 1.5rem;">
<p style="font-weight: 600; margin-bottom: 0.5rem;">Opportunity: Basis Boost Maximization</p>
<p style="margin: 0; font-size: 0.9375rem; line-height: 1.7;">
                        Denver metro has extensive DDA and QCT coverage. Target dual-designated areas for 30% basis boost to offset high land costs and construction expenses.
                    </p>
</div>
<ul style="line-height: 1.8;">
<li><strong>Concession Impact:</strong> Factor $150-285/month into underwriting for competitive Class A/B properties</li>
<li><strong>Supply Relief Coming:</strong> New deliveries drop to 5,800 units in 2026 (vs 18,400 in 2024) - stabilization ahead</li>
<li><strong>Target Markets:</strong> Focus on submarkets with less new supply (Boulder County, northern suburbs)</li>
<li><strong>AMI Targeting:</strong> Strong demand at 30-60% AMI; limited supply at &lt;30% (extremely low income)</li>
</ul>
</div>
<div class="chart-card">
<h3 style="color: var(--color-primary); margin-bottom: 1.5rem;">For Investors</h3>
<ul style="line-height: 1.8;">
<li><strong>Timing:</strong> Current oversupply = buyer's market for acquisitions; stabilization by late 2026</li>
<li><strong>Class Focus:</strong> Class B outperforming Class C (which fell 5% YoY); avoid older assets without renovation plans</li>
<li><strong>Geography:</strong> Suburban markets (Broomfield +4% appreciation) outperforming urban core</li>
<li><strong>Concession Risk:</strong> Leases signed with heavy concessions renewing in 2026 = potential move-out risk</li>
<li><strong>Recovery Play:</strong> Occupancy expected to tighten 2026, rent rebound early 2027</li>
</ul>
</div>
</div>
<div style="background: var(--color-primary-dark); color: white; padding: 2.5rem; border-radius: 8px; margin: 1.25rem 0;">
<h3 style="color: white; margin-bottom: 1rem;">Bottom Line: Colorado Market Snapshot</h3>
<p style="line-height: 1.7; margin-bottom: 1rem; opacity: 0.95;">
                Colorado's affordable housing market is in transition: <strong>historic concessions and high vacancy</strong> reflect severe 2024 oversupply, but <strong>sharply declining new construction</strong> sets stage for 2027 recovery. LIHTC developers benefit from strong per-capita allocations and extensive basis boost opportunities, though must model realistic Class B competition and concession pressure.
            </p>
<p style="line-height: 1.7; margin: 0; opacity: 0.95;">
<strong>Key Advantage:</strong> Unemployment among nation's lowest (3.7%) + minimal foreclosure risk + strong job market fundamentals = sustainable long-term demand. Near-term pain from supply glut, medium-term opportunity as market rebalances.
            </p>
</div>
<!-- Sources -->
<div style="margin-top: 1.5rem; padding: 2.5rem; background: var(--color-background-alt); border-radius: 8px; border-left: 4px solid var(--color-accent);">
<h3 style="color: var(--color-primary); margin-bottom: 1.5rem; font-size: 1.25rem;">Data Sources &amp; Methodology</h3>
<div style="margin-bottom: 2rem;">
<h4 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--color-primary-dark);">DDA/QCT Data:</h4>
<ul style="line-height: 1.8; color: var(--color-text-light); margin-left: 1.5rem;">
<li>HUD 2026 DDA and QCT Designations (Effective January 1, 2026)</li>
<li>Novogradac DDA/QCT Mapping Tool</li>
<li>Federal Register Notice (September 30, 2025)</li>
</ul>
</div>
<div style="margin-bottom: 2rem;">
<h4 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--color-primary-dark);">AMI &amp; Income Data:</h4>
<ul style="line-height: 1.8; color: var(--color-text-light); margin-left: 1.5rem;">
<li>HUD FY 2025 Income Limits (Effective April 1, 2025)</li>
<li>Colorado Division of Housing - 2025 HOME Income Limits</li>
<li>Denver Housing Authority - 2025 LIHTC Rent Limits</li>
</ul>
</div>
<div style="margin-bottom: 2rem;">
<h4 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--color-primary-dark);">Concessions &amp; Market Data:</h4>
<ul style="line-height: 1.8; color: var(--color-text-light); margin-left: 1.5rem;">
<li>The Colorado Sun - "Apartment vacancy in metro Denver reaches highest rate in 16 years" (January 21, 2026)</li>
<li>Apartment Association of Metro Denver - Q4 2025 Market Report</li>
<li>RealPage Market Analytics - Denver Market Profile (November 2025)</li>
<li>National Apartment Association - 2026 Housing Outlook</li>
</ul>
</div>
<div style="margin-bottom: 2rem;">
<h4 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--color-primary-dark);">Foreclosure &amp; Economic Data:</h4>
<ul style="line-height: 1.8; color: var(--color-text-light); margin-left: 1.5rem;">
<li>Colorado Association of REALTORS - 2025 Market Trends Report</li>
<li>Auction.com - Q3 2025 Auction Market Dispatch</li>
<li>Denver Metro Association of Realtors - 2026 Economic Summit</li>
</ul>
</div>
<div style="padding: 1.5rem; background: rgba(243, 156, 18, 0.1); border-left: 3px solid var(--color-warning); border-radius: 4px;">
<p style="font-size: 0.875rem; line-height: 1.7; margin: 0;">
<strong>Disclaimer:</strong> This analysis aggregates data from multiple authoritative sources for informational purposes. Market conditions change rapidly. Developers and investors should conduct independent due diligence, verify current pricing and incentives, and consult qualified professionals for project-specific guidance. DDA/QCT designations shown are based on 2026 HUD designations effective January 1, 2026.
                </p>
</div>
</div>
</div>
  </div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     INTERACTIVE ANALYSIS SECTIONS 1‚Äì3
     Section 1: State-Level Comparison Dashboard
     Section 2: 5+ Year AMI Gap Trend Analysis
     Section 3: Policy Impact Simulator
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<style>
/* ‚îÄ‚îÄ Shared section collapse/expand styles ‚îÄ‚îÄ */
.analysis-section { margin: 2.5rem 0; }
.section-details-wrapper > summary {
  cursor: pointer; list-style: none; display: flex; align-items: center;
  justify-content: space-between; padding: .85rem 1.15rem;
  background: var(--bg2); border-radius: var(--radius-lg);
  border: 1px solid var(--border); font-size: 1.1rem; font-weight: 700;
  user-select: none; transition: background .15s;
}
.section-details-wrapper > summary::-webkit-details-marker { display: none; }
.section-details-wrapper > summary:hover { background: var(--bg3); }
.section-details-wrapper > summary .s-toggle { font-size: .9rem; transition: transform .2s; }
.section-details-wrapper[open] > summary .s-toggle { transform: rotate(180deg); }
.section-body { margin-top: 1.25rem; }

/* ‚îÄ‚îÄ Two-column responsive grid ‚îÄ‚îÄ */
.two-col-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; margin-bottom: 1.25rem; }
@media (max-width: 760px) { .two-col-grid { grid-template-columns: 1fr; } }

/* ‚îÄ‚îÄ AMI Heatmap ‚îÄ‚îÄ */
.heatmap-tbl { width: 100%; border-collapse: collapse; min-width: 480px; font-size: .82rem; }
.heatmap-tbl th { padding: .45rem .55rem; text-align: center; font-size: .75rem; font-weight: 700;
  color: var(--muted); background: var(--bg2); border: 1px solid var(--border); white-space: nowrap; }
.heatmap-tbl th:first-child { text-align: left; }
.heatmap-tbl td { padding: .38rem .55rem; text-align: center; border: 1px solid var(--border);
  font-variant-numeric: tabular-nums; font-size: .79rem; }
.heatmap-tbl td:first-child { text-align: left; font-weight: 700; white-space: nowrap; }

/* ‚îÄ‚îÄ Scenario cards ‚îÄ‚îÄ */
.scenario-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1rem 0; }
@media (max-width: 700px) { .scenario-cards { grid-template-columns: 1fr; } }
.scenario-card { background: var(--card); border: 2px solid var(--border); border-radius: var(--radius-lg);
  padding: 1rem 1.1rem; }
.scenario-card h4 { margin: 0 0 .45rem; font-size: .95rem; }
.s-units { font-size: 1.55rem; font-weight: 800; color: var(--accent); line-height: 1; }
.s-lbl { font-size: .74rem; color: var(--muted); margin-top: .15rem; }
.scenario-kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: .75rem; margin: 1rem 0; }
@media (max-width: 700px) { .scenario-kpi-row { grid-template-columns: repeat(2, 1fr); } }

/* ‚îÄ‚îÄ Sliders ‚îÄ‚îÄ */
.slider-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem 1.5rem; }
@media (max-width: 700px) { .slider-grid { grid-template-columns: 1fr; } }
.slider-row { display: flex; flex-direction: column; gap: .3rem; }
.slider-row label { font-size: .82rem; font-weight: 600; color: var(--muted);
  display: flex; justify-content: space-between; align-items: baseline; }
.slider-row label span { font-weight: 700; color: var(--accent); font-size: .84rem; }
.slider-row input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; }
.slider-desc { font-size: .73rem; color: var(--faint); line-height: 1.3; }

/* ‚îÄ‚îÄ Preset buttons ‚îÄ‚îÄ */
.preset-btn { padding: .4rem .9rem; border-radius: 999px; border: 1px solid var(--border);
  background: var(--card); color: var(--text); font-size: .82rem; font-weight: 600;
  cursor: pointer; transition: background .15s, border-color .15s; }
.preset-btn:hover { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
.preset-btn.sim-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
.preset-btn.sim-primary:hover { filter: brightness(1.1); }
.preset-btn.sim-danger { border-color: var(--bad); color: var(--bad); }
.preset-btn.sim-danger:hover { background: var(--bad-dim); }

/* ‚îÄ‚îÄ Cost-benefit panel ‚îÄ‚îÄ */
#cbPanel { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 1rem 1.15rem; }
#cbPanel h4 { margin: 0 0 .7rem; font-size: .95rem; }
.cb-row { display: flex; justify-content: space-between; padding: .3rem 0;
  border-bottom: 1px solid var(--border); font-size: .83rem; }
.cb-row:last-child { border-bottom: none; font-weight: 700; }
.cb-val { font-weight: 700; font-variant-numeric: tabular-nums; }

/* ‚îÄ‚îÄ Trend selectors ‚îÄ‚îÄ */
.trend-selectors { display: flex; flex-wrap: wrap; gap: .75rem; align-items: center; margin-bottom: 1.1rem; }
.trend-selectors label { font-size: .83rem; font-weight: 600; color: var(--muted); }
.trend-selectors select { padding: .35rem .7rem; border-radius: 8px; border: 1px solid var(--border);
  background: var(--card); color: var(--text); font-size: .83rem; cursor: pointer; }
.proj-legend { display: flex; flex-wrap: wrap; gap: .75rem; align-items: center;
  font-size: .77rem; color: var(--muted); margin: 0 0 1rem; }
.pl-solid, .pl-dashed { display: inline-block; width: 22px; height: 2px; vertical-align: middle; margin-right: 3px; }
.pl-solid  { background: var(--accent); }
.pl-dashed { background: repeating-linear-gradient(90deg, var(--accent) 0 4px, transparent 4px 8px); }
</style>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     SECTION 1 ‚Äî State-Level Comparison Dashboard
     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<section id="state-comparison" class="analysis-section" aria-label="State-Level Comparison Dashboard">
  <details class="section-details-wrapper" open>
    <summary>
      <span>üìä Section 1 ‚Äî State-Level Comparison Dashboard</span>
      <span class="s-toggle" aria-hidden="true">‚ñº</span>
    </summary>
    <div class="section-body">

      <div style="display:flex; flex-wrap:wrap; gap:.75rem; align-items:center; margin-bottom:1.25rem;">
        <label for="stateMetricSelect" style="font-size:.87rem; font-weight:700; color:var(--muted);">Compare states by:</label>
        <select id="stateMetricSelect" style="padding:.4rem .85rem; border-radius:8px; border:1px solid var(--border); background:var(--card); color:var(--text); font-size:.85rem;">
          <option value="lihtc_per_capita">Per-Capita LIHTC ($)</option>
          <option value="cost_burden">Cost Burden (%)</option>
          <option value="rent_growth">Rent Growth YoY (%)</option>
          <option value="vacancy">Vacancy Rate (%)</option>
        </select>
        <span style="font-size:.78rem; color:var(--faint);">CO ¬∑ CA ¬∑ TX ¬∑ FL ¬∑ NC ¬∑ WA ¬∑ AZ</span>
      </div>

      <div class="kpi-grid" id="stateKpiGrid" style="margin-bottom:1.25rem;"></div>

      <div class="two-col-grid">
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">State Rankings</h3>
            <p class="chart-subtitle" id="stateRankSubtitle">Sorted by per-capita LIHTC</p>
          </div>
          <div style="overflow-x:auto; padding:.25rem .75rem .75rem;">
            <table style="width:100%; border-collapse:collapse; font-size:.83rem;" role="table" aria-label="State rankings">
              <thead>
                <tr style="border-bottom:2px solid var(--border);">
                  <th style="padding:.4rem .3rem; text-align:center; color:var(--muted); font-size:.75rem;" scope="col">Rank</th>
                  <th style="padding:.4rem .5rem; text-align:left;   color:var(--muted); font-size:.75rem;" scope="col">State</th>
                  <th id="rankMetricHead" style="padding:.4rem .5rem; text-align:right; color:var(--muted); font-size:.75rem;" scope="col">Value</th>
                </tr>
              </thead>
              <tbody id="stateRankBody"></tbody>
            </table>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">State Comparison</h3>
            <p class="chart-subtitle">Colorado highlighted in teal</p>
          </div>
          <div style="height:260px; position:relative; padding:.5rem 1rem 1rem;">
            <canvas id="stateBarChart" aria-label="State comparison bar chart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-card" style="margin-bottom:1.25rem;">
        <div class="chart-header">
          <h3 class="chart-title">AMI Gap Heatmap by State</h3>
          <p class="chart-subtitle">Affordable unit shortfall at each AMI level ‚Äî darker red = greater deficit ¬∑ green = surplus (thousands of units)</p>
        </div>
        <div style="overflow-x:auto; padding:.5rem 1rem .5rem;">
          <table class="heatmap-tbl" id="amiHeatmapTable" role="table" aria-label="AMI gap heatmap">
            <thead id="amiHeatmapHead"></thead>
            <tbody id="amiHeatmapBody"></tbody>
          </table>
        </div>
        <div style="padding:.25rem 1rem .75rem; font-size:.73rem; color:var(--faint);">
          Values in thousands of units. Source: ACS B19001/B25063; HUD FY2025 Income Limits.
        </div>
      </div>

      <div class="two-col-grid">
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Net Domestic Migration</h3>
            <p class="chart-subtitle">Thousands of persons (2022‚Äì2024 avg) ‚Äî positive = net in-migration</p>
          </div>
          <div style="height:240px; position:relative; padding:.5rem 1rem 1rem;">
            <canvas id="migrationChart" aria-label="Net domestic migration chart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Housing Cost Burden</h3>
            <p class="chart-subtitle">Renters paying &gt;30% and &gt;50% of income on housing</p>
          </div>
          <div style="height:240px; position:relative; padding:.5rem 1rem 1rem;">
            <canvas id="costBurdenChart" aria-label="Housing cost burden chart"></canvas>
          </div>
        </div>
      </div>

      <details>
        <summary style="cursor:pointer; font-size:.83rem; font-weight:600; color:var(--muted); padding:.4rem 0; user-select:none;">üìã Methodology &amp; Data Sources</summary>
        <div style="margin-top:.5rem; padding:.9rem 1.1rem; background:var(--bg2); border:1px solid var(--border); border-radius:10px; font-size:.82rem; line-height:1.7; color:var(--muted);">
          <p style="margin:.2rem 0;"><strong>LIHTC Per Capita:</strong> Annual state 9% LIHTC allocations √∑ 2023 Census population estimates. Source: <a href="https://www.novoco.com/resource-centers/affordable-housing-tax-credits/lihtc-basics/lihtc-per-capita-list" target="_blank" rel="noopener">Novoco 2025 State Allocations</a>; Census Population Division.</p>
          <p style="margin:.2rem 0;"><strong>Cost Burden:</strong> Renters paying &gt;30% gross income on housing. Source: <a href="https://www.census.gov/programs-surveys/acs" target="_blank" rel="noopener">ACS 2023 5-yr, Table B25070</a>.</p>
          <p style="margin:.2rem 0;"><strong>Rent Growth:</strong> YoY median gross rent change, Q4 2025 vs Q4 2024. Source: CoStar/RealPage market analytics.</p>
          <p style="margin:.2rem 0;"><strong>Vacancy Rate:</strong> Multifamily (5+ units) Q4 2025. Source: CoStar/CBRE market reports.</p>
          <p style="margin:.2rem 0;"><strong>AMI Gap Heatmap:</strong> (Households ‚â§ AMI threshold) ‚àí (Units affordable at that AMI). Negative = deficit. Color intensity scaled within each AMI column. Source: ACS B19001, B25063; <a href="https://www.huduser.gov/portal/datasets/il.html" target="_blank" rel="noopener">HUD FY2025 Income Limits</a>.</p>
          <p style="margin:.2rem 0;"><strong>Net Migration:</strong> IRS SOI migration data 2022‚Äì2023; Census Population Estimates 2024. Positive = net in-migration.</p>
          <p style="margin:.2rem 0;"><strong>Peer states:</strong> CO, CA, TX, FL, NC, WA, AZ ‚Äî largest LIHTC markets with comparable population/economic profiles.</p>
        </div>
      </details>
    </div>
  </details>
</section>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     SECTION 2 ‚Äî 5+ Year AMI Gap Trend Analysis
     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<section id="ami-trend-analysis" class="analysis-section" aria-label="AMI Gap Trend Analysis">
  <details class="section-details-wrapper" open>
    <summary>
      <span>üìà Section 2 ‚Äî 5+ Year AMI Gap Trend Analysis</span>
      <span class="s-toggle" aria-hidden="true">‚ñº</span>
    </summary>
    <div class="section-body">

      <div class="trend-selectors">
        <label for="trendCountySelect">County / Region:</label>
        <select id="trendCountySelect">
          <option value="STATE">Colorado (Statewide)</option>
          <option value="DENVER">Denver</option>
          <option value="BOULDER">Boulder</option>
          <option value="EL_PASO">El Paso (C. Springs)</option>
          <option value="LARIMER">Larimer (Ft. Collins)</option>
          <option value="ARAPAHOE">Arapahoe</option>
          <option value="JEFFERSON">Jefferson</option>
          <option value="ADAMS">Adams</option>
          <option value="PUEBLO">Pueblo</option>
        </select>
        <label for="trendAmiSelect" style="margin-left:.5rem;">AMI Level:</label>
        <select id="trendAmiSelect">
          <option value="30">30% AMI (Extremely Low)</option>
          <option value="50">50% AMI (Very Low)</option>
          <option value="60" selected>60% AMI (LIHTC Standard)</option>
          <option value="80">80% AMI (Low Income)</option>
          <option value="100">100% AMI (Median)</option>
        </select>
      </div>

      <div class="proj-legend" aria-label="Chart legend">
        <span class="pl-solid"></span><span>Historical (2019‚Äì2026)</span>
        <span class="pl-dashed" style="margin-left:.5rem;"></span><span>Projected (2027‚Äì2030, dashed)</span>
      </div>

      <div class="two-col-grid">
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Household Growth vs. Unit Production</h3>
            <p class="chart-subtitle">Households vs. affordable units at selected AMI</p>
          </div>
          <div style="height:260px; position:relative; padding:.5rem 1rem 1rem;">
            <canvas id="trendGrowthChart" aria-label="Household growth vs unit production chart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Year-over-Year Gap Change</h3>
            <p class="chart-subtitle">Annual change in affordability gap (units) ‚Äî red = gap widening</p>
          </div>
          <div style="height:260px; position:relative; padding:.5rem 1rem 1rem;">
            <canvas id="trendYoyChart" aria-label="YoY gap change chart"></canvas>
          </div>
        </div>
      </div>

      <div class="two-col-grid">
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Cumulative Deficit</h3>
            <p class="chart-subtitle">Running total of unmet affordable housing need</p>
          </div>
          <div style="height:240px; position:relative; padding:.5rem 1rem 1rem;">
            <canvas id="trendCumulativeChart" aria-label="Cumulative deficit chart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Population Growth Correlation</h3>
            <p class="chart-subtitle">Gap size vs. population growth rate by year</p>
          </div>
          <div style="height:240px; position:relative; padding:.5rem 1rem 1rem;">
            <canvas id="trendScatterChart" aria-label="Population growth correlation scatter chart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-card" style="margin-bottom:1.25rem;">
        <div class="chart-header">
          <h3 class="chart-title">Seasonal Supply Patterns</h3>
          <p class="chart-subtitle">Quarterly unit completions indexed to Q1 ‚Äî showing seasonal construction cycle</p>
        </div>
        <div style="height:220px; position:relative; padding:.5rem 1rem 1rem;">
          <canvas id="trendSeasonalChart" aria-label="Seasonal supply patterns chart"></canvas>
        </div>
      </div>

      <div class="chart-card" style="margin-bottom:1.25rem;">
        <div class="chart-header">
          <h3 class="chart-title">Three-Scenario 2030 Projection Model</h3>
          <p class="chart-subtitle">Projected gap at selected AMI level under three policy scenarios</p>
        </div>
        <div style="padding:.5rem 1rem 1rem;">
          <div class="scenario-cards">
            <div class="scenario-card">
              <h4 style="color:var(--bad);">üî¥ Status Quo</h4>
              <div class="s-units" id="sqUnits">‚Äî</div>
              <div class="s-lbl">unit deficit by 2030</div>
              <div style="margin-top:.7rem; font-size:.77rem; color:var(--muted); line-height:1.5;">
                Current production rate continues. No policy changes. Gap widens with population growth.
              </div>
            </div>
            <div class="scenario-card">
              <h4 style="color:var(--warn);">üü° Moderate Reform</h4>
              <div class="s-units" id="mrUnits">‚Äî</div>
              <div class="s-lbl">unit deficit by 2030</div>
              <div style="margin-top:.7rem; font-size:.77rem; color:var(--muted); line-height:1.5;">
                +25% LIHTC allocation, 15% inclusionary zoning, moderate zoning reform. Gap narrows.
              </div>
            </div>
            <div class="scenario-card">
              <h4 style="color:var(--good);">üü¢ Aggressive Reform</h4>
              <div class="s-units" id="arUnits">‚Äî</div>
              <div class="s-lbl">unit deficit by 2030</div>
              <div style="margin-top:.7rem; font-size:.77rem; color:var(--muted); line-height:1.5;">
                +50% LIHTC, 20% IZ, TOD upzoning, broad zoning reform. Significant gap reduction.
              </div>
            </div>
          </div>
          <div class="scenario-kpi-row" id="scenarioKpiRow"></div>
        </div>
      </div>

      <details>
        <summary style="cursor:pointer; font-size:.83rem; font-weight:600; color:var(--muted); padding:.4rem 0; user-select:none;">üìã Methodology &amp; Data Sources</summary>
        <div style="margin-top:.5rem; padding:.9rem 1.1rem; background:var(--bg2); border:1px solid var(--border); border-radius:10px; font-size:.82rem; line-height:1.7; color:var(--muted);">
          <p style="margin:.2rem 0;"><strong>Historical data (2019‚Äì2026):</strong> ACS 1-year and 5-year estimates for household counts; CHFA annual reports for unit completions by AMI band.</p>
          <p style="margin:.2rem 0;"><strong>Projections (2027‚Äì2030):</strong> Household growth based on <a href="https://demography.dola.colorado.gov/" target="_blank" rel="noopener">Colorado State Demography Office</a> population projections (+1.4%/yr). Unit production extrapolated from 5-year trend with scenario multipliers.</p>
          <p style="margin:.2rem 0;"><strong>Status Quo:</strong> Production continues at 2023‚Äì2025 average rate. Gap grows proportional to household growth.</p>
          <p style="margin:.2rem 0;"><strong>Moderate Reform:</strong> Production +25% via LIHTC expansion, 15% IZ, streamlined permitting. Effective 2027.</p>
          <p style="margin:.2rem 0;"><strong>Aggressive Reform:</strong> Production +50% via full policy stack (LIHTC +50%, IZ 20%, TOD upzoning, statewide zoning reform, tax abatement). Effective 2027.</p>
          <p style="margin:.2rem 0;"><strong>Seasonal patterns:</strong> Indexed to Q1=100 based on <a href="https://www.chfainfo.com/arh/research/Pages/research-publications.aspx" target="_blank" rel="noopener">CHFA quarterly completion data</a> 2023‚Äì2025.</p>
        </div>
      </details>
    </div>
  </details>
</section>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     SECTION 3 ‚Äî Policy Impact Simulator
     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<section id="policy-simulator" class="analysis-section" aria-label="Policy Impact Simulator">
  <details class="section-details-wrapper" open>
    <summary>
      <span>üîß Section 3 ‚Äî Policy Impact Simulator</span>
      <span class="s-toggle" aria-hidden="true">‚ñº</span>
    </summary>
    <div class="section-body">

      <p style="font-size:.87rem; color:var(--muted); margin:0 0 1.25rem; line-height:1.6;">
        Adjust the policy levers below to see the estimated impact on the 60% AMI affordable housing gap in Colorado by 2030.
        Results are modeled estimates based on literature review and CHFA/HUD program data.
      </p>

      <div style="display:flex; flex-wrap:wrap; gap:.6rem; margin-bottom:1.25rem; align-items:center;">
        <span style="font-size:.83rem; font-weight:700; color:var(--muted);">Presets:</span>
        <button class="preset-btn" onclick="applySimPreset('moderate')" aria-label="Apply Moderate Reform preset">Moderate Reform</button>
        <button class="preset-btn" onclick="applySimPreset('aggressive')" aria-label="Apply Aggressive Reform preset">Aggressive Reform</button>
        <button class="preset-btn sim-danger" onclick="applySimPreset('reset')" aria-label="Reset all sliders to baseline">Reset to Baseline</button>
        <button class="preset-btn sim-primary" onclick="exportSimCSV()" aria-label="Export scenario to CSV" style="margin-left:auto;">‚¨á Export CSV</button>
      </div>

      <div class="chart-card" style="padding:1.25rem; margin-bottom:1.25rem;">
        <h3 class="chart-title" style="margin-bottom:1rem;">Policy Levers</h3>
        <div class="slider-grid" id="sliderGrid" role="group" aria-label="Policy lever sliders"></div>
      </div>

      <div class="two-col-grid" style="align-items:start;">
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Before vs. After Comparison</h3>
            <p class="chart-subtitle">Projected 2030 gap by AMI level ‚Äî baseline vs. policy scenario</p>
          </div>
          <div style="height:300px; position:relative; padding:.5rem 1rem 1rem;">
            <canvas id="simCompareChart" aria-label="Before vs after comparison chart"></canvas>
          </div>
        </div>
        <div id="cbPanel">
          <h4>üí∞ Cost‚ÄìBenefit Summary</h4>
          <div id="cbRows">
            <div style="font-size:.82rem; color:var(--faint); text-align:center; padding:1rem 0;">
              Move sliders above 0 to see cost‚Äìbenefit analysis
            </div>
          </div>
        </div>
      </div>

      <div class="kpi-grid" id="simKpiGrid" style="margin:1.25rem 0;"></div>

      <details>
        <summary style="cursor:pointer; font-size:.83rem; font-weight:600; color:var(--muted); padding:.4rem 0; user-select:none;">üìã Methodology, Model Assumptions &amp; Data Sources</summary>
        <div style="margin-top:.5rem; padding:.9rem 1.1rem; background:var(--bg2); border:1px solid var(--border); border-radius:10px; font-size:.82rem; line-height:1.7; color:var(--muted);">
          <p style="margin:.3rem 0;"><strong>Baseline gap:</strong> Colorado's projected 2030 affordable unit shortfall at 60% AMI under Status Quo ‚âà 15,000 units (statewide), derived from ACS 2023 trend extrapolation + Colorado Demography Office projections.</p>
          <p style="margin:.3rem 0;"><strong>LIHTC % increase:</strong> Each 10% increase in annual LIHTC allocation ‚âà +650 units/year (based on CO average unit cost and CHFA credit pricing of $0.87/credit). Compounded over 4 years (2027‚Äì2030).</p>
          <p style="margin:.3rem 0;"><strong>AMI concentration cap:</strong> Limiting single-AMI concentration increases mixed-income production efficiency. Estimated +300‚Äì800 units/year at cap levels 50‚Äì20%. Source: JCHS mixed-income housing research.</p>
          <p style="margin:.3rem 0;"><strong>Inclusionary Zoning (IZ):</strong> Each 5% IZ requirement on new market-rate construction (‚âà4,500 units/yr in CO) ‚âà +225 affordable units/year at ‚â§60% AMI. Source: Urban Institute IZ studies.</p>
          <p style="margin:.3rem 0;"><strong>TOD Level:</strong> Transit-Oriented Development upzoning near rail/BRT. Low=+400, Medium=+800, High=+1,200 units/yr. Source: <a href="https://www.rtd-denver.com/" target="_blank" rel="noopener">RTD/DRCOG</a> corridor studies 2024.</p>
          <p style="margin:.3rem 0;"><strong>Zoning Reform:</strong> ADU legalization, missing middle by-right. Low=+600, Medium=+1,200, High=+2,000 units/yr. Source: <a href="https://leg.colorado.gov/bills/hb24-1313" target="_blank" rel="noopener">CO HB24-1313</a> impact estimates.</p>
          <p style="margin:.3rem 0;"><strong>Property Tax Abatement:</strong> Each $500/unit/yr saving ‚âà 200 units protected/year via preservation. Source: CHFA operating cost data.</p>
          <p style="margin:.3rem 0;"><strong>Remote-work migration:</strong> Each 10K net in-migrants increases demand by ‚âà4,800 units (1.96 persons/HH, 35% renter, 60% ‚â§80% AMI). Source: Census ACS/CPS migration microdata.</p>
          <p style="margin:.3rem 0;"><strong>Cost-benefit:</strong> Avg total dev cost = $320,000/unit (CHFA 2025 avg). Annual subsidy/unit = $8,500. Societal benefit = $15,200/unit/yr (avoided emergency housing, healthcare, productivity ‚Äî <a href="https://www.jchs.harvard.edu/" target="_blank" rel="noopener">JCHS</a>/<a href="https://www.urban.org/policy-centers/housing-finance-policy-center" target="_blank" rel="noopener">Urban Institute</a>).</p>
          <p style="margin:.2rem 0; padding-top:.5rem; border-top:1px solid var(--border);">
            <strong>Data sources:</strong>
            <a href="https://www.chfainfo.com/" target="_blank" rel="noopener">CHFA</a> ¬∑
            <a href="https://demography.dola.colorado.gov/" target="_blank" rel="noopener">CO Demography Office</a> ¬∑
            <a href="https://www.jchs.harvard.edu/" target="_blank" rel="noopener">JCHS/Harvard</a> ¬∑
            <a href="https://www.urban.org/policy-centers/housing-finance-policy-center" target="_blank" rel="noopener">Urban Institute</a> ¬∑
            <a href="https://leg.colorado.gov/bills/hb24-1313" target="_blank" rel="noopener">CO HB24-1313</a> ¬∑
            <a href="https://www.rtd-denver.com/" target="_blank" rel="noopener">RTD/DRCOG</a>
          </p>
        </div>
      </details>
    </div>
  </details>
</section>

<script>
/* ================================================================
   Interactive Analysis Sections 1‚Äì3 ‚Äî Colorado Deep Dive
   ================================================================ */
(function () {
  'use strict';

  /* ‚îÄ‚îÄ CSS variable helper ‚îÄ‚îÄ */
  function cssVar(n) { return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); }
  const ACCENT = () => cssVar('--accent')  || '#0ea5a0';
  const MUTED  = () => cssVar('--muted')   || '#476080';
  const BAD    = () => cssVar('--bad')     || '#dc2626';
  const GOOD   = () => cssVar('--good')    || '#059669';
  const WARN   = () => cssVar('--warn')    || '#d97706';
  const BORDER = () => cssVar('--border')  || 'rgba(13,31,53,.11)';
  const TEXT   = () => cssVar('--text')    || '#0d1f35';

  function baseScaleOpts() {
    return {
      x: { ticks: { color: MUTED(), font: { size: 10 } }, grid: { color: BORDER() } },
      y: { ticks: { color: MUTED(), font: { size: 10 } }, grid: { color: BORDER() } }
    };
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DATA
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  const STATES = ['CO','CA','TX','FL','NC','WA','AZ'];
  const STATE_NAMES = { CO:'Colorado', CA:'California', TX:'Texas', FL:'Florida', NC:'N. Carolina', WA:'Washington', AZ:'Arizona' };
  const STATE_DATA = {
    CO: { lihtc_per_capita:49,  cost_burden:47.2, rent_growth:-4.8, vacancy:7.6,
          ami_gap:{ 30:-42, 40:-38, 50:-28, 60:-15, 70:-8,   80:-2,  100:5  }, migration:38,   cost_burden_50:21.3 },
    CA: { lihtc_per_capita:73,  cost_burden:53.1, rent_growth:1.8,  vacancy:4.2,
          ami_gap:{ 30:-280,40:-240,50:-180,60:-110,70:-55,  80:-20, 100:15 }, migration:-142, cost_burden_50:28.4 },
    TX: { lihtc_per_capita:38,  cost_burden:44.8, rent_growth:0.5,  vacancy:8.8,
          ami_gap:{ 30:-180,40:-155,50:-110,60:-65, 70:-28,  80:-5,  100:18 }, migration:195,  cost_burden_50:20.1 },
    FL: { lihtc_per_capita:42,  cost_burden:52.7, rent_growth:-2.1, vacancy:9.1,
          ami_gap:{ 30:-155,40:-132,50:-95, 60:-52, 70:-18,  80:8,   100:22 }, migration:220,  cost_burden_50:27.8 },
    NC: { lihtc_per_capita:35,  cost_burden:42.3, rent_growth:2.4,  vacancy:6.3,
          ami_gap:{ 30:-75, 40:-62, 50:-44, 60:-22, 70:-8,   80:5,   100:18 }, migration:85,   cost_burden_50:18.6 },
    WA: { lihtc_per_capita:52,  cost_burden:48.9, rent_growth:3.1,  vacancy:5.8,
          ami_gap:{ 30:-68, 40:-57, 50:-40, 60:-21, 70:-6,   80:4,   100:16 }, migration:15,   cost_burden_50:24.1 },
    AZ: { lihtc_per_capita:31,  cost_burden:46.1, rent_growth:-1.5, vacancy:8.4,
          ami_gap:{ 30:-62, 40:-52, 50:-36, 60:-18, 70:-5,   80:8,   100:20 }, migration:72,   cost_burden_50:22.7 }
  };
  const METRIC_CFG = {
    lihtc_per_capita: { label:'LIHTC Per Capita ($)', fmt: v=>'$'+v,               desc:'Per-capita LIHTC allocation', good:'high' },
    cost_burden:      { label:'Cost Burden (%)',       fmt: v=>v+'%',               desc:'Renters >30% income on rent', good:'low'  },
    rent_growth:      { label:'Rent Growth (%)',       fmt: v=>(v>0?'+':'')+v+'%',  desc:'YoY rent change Q4 2025',     good:'low'  },
    vacancy:          { label:'Vacancy Rate (%)',      fmt: v=>v+'%',               desc:'Multifamily vacancy Q4 2025', good:'low'  }
  };
  const AMI_LEVELS = [30, 40, 50, 60, 70, 80, 100];

  const COUNTY_BASE_GAP = {
    STATE:    { 30:42000, 50:28000, 60:15000, 80:2000,  100:-5000 },
    DENVER:   { 30:12000, 50:8500,  60:4800,  80:800,   100:-1200 },
    BOULDER:  { 30:5500,  50:3800,  60:2100,  80:300,   100:-600  },
    EL_PASO:  { 30:7200,  50:4900,  60:2700,  80:350,   100:-800  },
    LARIMER:  { 30:4100,  50:2800,  60:1550,  80:200,   100:-400  },
    ARAPAHOE: { 30:5800,  50:3900,  60:2200,  80:280,   100:-700  },
    JEFFERSON:{ 30:4600,  50:3100,  60:1750,  80:220,   100:-550  },
    ADAMS:    { 30:4200,  50:2900,  60:1600,  80:180,   100:-450  },
    PUEBLO:   { 30:2200,  50:1500,  60:820,   80:80,    100:-200  }
  };

  const YEARS_HIST = [2019,2020,2021,2022,2023,2024,2025,2026];
  const YEARS_PROJ = [2027,2028,2029,2030];
  const ALL_YEARS  = [...YEARS_HIST,...YEARS_PROJ];

  function getTrendData(county, ami) {
    const base = (COUNTY_BASE_GAP[county] || COUNTY_BASE_GAP.STATE)[ami] || 15000;
    const GR = 0.035, PR = 0.018;
    const histHH    = YEARS_HIST.map((_,i) => Math.round(base * 1.6 * Math.pow(1+GR, i)));
    const histUnits = YEARS_HIST.map((_,i) => Math.round(base * 0.96 * Math.pow(1+PR, i)));
    const histGap   = YEARS_HIST.map((_,i) => histHH[i] - histUnits[i]);
    const projHH    = YEARS_PROJ.map((_,i) => Math.round(histHH[7]    * Math.pow(1+GR, i+1)));
    const projUnits = YEARS_PROJ.map((_,i) => Math.round(histUnits[7] * Math.pow(1+PR, i+1)));
    const sqGap  = YEARS_PROJ.map((_,i) => Math.round(histGap[7] * Math.pow(1.04, i+1)));
    const mrGap  = YEARS_PROJ.map((_,i) => Math.round(histGap[7] * Math.pow(1.01, i+1)));
    const arGap  = YEARS_PROJ.map((_,i) => Math.round(histGap[7] * Math.pow(0.97, i+1)));
    const yoyChange  = YEARS_HIST.map((_,i) => i===0 ? 0 : histGap[i]-histGap[i-1]);
    let cum = 0;
    const cumDeficit = histGap.map(g => { cum += g; return cum; });
    const scatter    = YEARS_HIST.map((_,i) => ({ x: parseFloat((1.4+Math.sin(i)*0.3).toFixed(2)), y: histGap[i] }));
    const seasonal   = [[82,105,124,89],[85,108,128,92],[79,102,119,85]];
    return { histHH, histUnits, projHH, projUnits, histGap, sqGap, mrGap, arGap, yoyChange, cumDeficit, scatter, seasonal };
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 1 ‚Äî State Comparison
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  let stateBarInst = null;

  function renderStateComparison(metric) {
    const cfg    = METRIC_CFG[metric];
    const sorted = [...STATES].sort((a,b) => {
      const va = STATE_DATA[a][metric], vb = STATE_DATA[b][metric];
      return cfg.good === 'high' ? vb - va : va - vb;
    });

    /* Rankings table */
    const rankHead = document.getElementById('rankMetricHead');
    const rankBody = document.getElementById('stateRankBody');
    const rankSub  = document.getElementById('stateRankSubtitle');
    if (rankHead) rankHead.textContent = cfg.label;
    if (rankSub)  rankSub.textContent  = 'Sorted by ' + cfg.desc;
    if (rankBody) {
      rankBody.innerHTML = sorted.map((st, i) => {
        const v   = STATE_DATA[st][metric];
        const isCO = st === 'CO';
        return `<tr style="border-bottom:1px solid var(--border);${isCO?' background:var(--accent-dim);':''}">
          <td style="padding:.4rem .3rem;text-align:center;font-weight:700;font-size:.75rem;color:var(--muted);">${i+1}</td>
          <td style="padding:.4rem .5rem;font-weight:${isCO?'800':'500'};">${STATE_NAMES[st]}${isCO?' ‚Üê':''}</td>
          <td style="padding:.4rem .5rem;text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">${cfg.fmt(v)}</td>
        </tr>`;
      }).join('');
    }

    /* Bar chart */
    const ctx = document.getElementById('stateBarChart');
    if (ctx) {
      if (stateBarInst) { stateBarInst.destroy(); stateBarInst = null; }
      const barVals   = sorted.map(st => STATE_DATA[st][metric]);
      const barLabels = sorted.map(st => STATE_NAMES[st]);
      const barColors = sorted.map(st => st === 'CO' ? ACCENT() : MUTED()+'88');
      stateBarInst = new Chart(ctx, {
        type: 'bar',
        data: { labels: barLabels, datasets: [{ label: cfg.label, data: barVals, backgroundColor: barColors, borderRadius: 4 }] },
        options: { indexAxis:'y', responsive:true, maintainAspectRatio:false,
          plugins: { legend:{ display:false } },
          scales: { x: { ticks:{color:MUTED(),font:{size:10}}, grid:{color:BORDER()} },
                    y: { ticks:{color:TEXT(),font:{size:10}},  grid:{display:false} } } }
      });
    }

    /* KPI cards */
    const kpiGrid = document.getElementById('stateKpiGrid');
    if (kpiGrid) {
      const peers   = STATES.filter(s => s !== 'CO');
      const peerAvg = peers.reduce((a,s) => a + STATE_DATA[s][metric], 0) / peers.length;
      const coVal   = STATE_DATA.CO[metric];
      const diff    = coVal - peerAvg;
      const pctDiff = (Math.abs(diff) / Math.abs(peerAvg) * 100).toFixed(1);
      const arrow   = diff > 0 ? '‚Üë' : '‚Üì';
      const isBetter = cfg.good === 'high' ? diff >= 0 : diff <= 0;
      const goodBad  = isBetter ? 'var(--good)' : 'var(--bad)';
      const coRank   = sorted.findIndex(s => s === 'CO') + 1;
      kpiGrid.innerHTML = `
        <div class="kpi-card">
          <div class="kpi-value" style="color:${ACCENT()};">${cfg.fmt(coVal)}</div>
          <div class="kpi-label">Colorado ‚Äî ${cfg.label}</div>
          <div class="kpi-source">Selected metric</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value">${cfg.fmt(Math.round(peerAvg*10)/10)}</div>
          <div class="kpi-label">Peer State Average</div>
          <div class="kpi-source">CA, TX, FL, NC, WA, AZ</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value" style="color:${goodBad};">${arrow} ${pctDiff}%</div>
          <div class="kpi-label">CO vs. Peer Average</div>
          <div class="kpi-source">${diff > 0 ? 'Above' : 'Below'} peer avg</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value">${coRank} / ${STATES.length}</div>
          <div class="kpi-label">Colorado Rank</div>
          <div class="kpi-source">${cfg.good === 'high' ? 'Higher = better' : 'Lower = better'}</div>
        </div>`;
    }
  }

  function renderAmiHeatmap() {
    const head = document.getElementById('amiHeatmapHead');
    const body = document.getElementById('amiHeatmapBody');
    if (!head || !body) return;
    head.innerHTML = '<tr><th scope="col">State</th>' +
      AMI_LEVELS.map(a => `<th scope="col">${a}% AMI</th>`).join('') + '</tr>';
    const colMin = {}, colMax = {};
    AMI_LEVELS.forEach(a => {
      const vals = STATES.map(s => STATE_DATA[s].ami_gap[a]);
      colMin[a] = Math.min(...vals);
      colMax[a] = Math.max(...vals);
    });
    body.innerHTML = STATES.map(st => {
      const cells = AMI_LEVELS.map(a => {
        const v    = STATE_DATA[st].ami_gap[a];
        const sign = v >= 0 ? '+' : '';
        let bg;
        if (v < 0) {
          const intensity = colMin[a] === 0 ? 1 : Math.max(0, Math.min(1, v / colMin[a]));
          bg = `rgba(220,38,38,${(0.15 + intensity * 0.55).toFixed(2)})`;
        } else {
          const intensity = colMax[a] === 0 ? 0 : Math.min(1, v / colMax[a]);
          bg = `rgba(5,150,105,${(0.15 + intensity * 0.4).toFixed(2)})`;
        }
        return `<td style="background:${bg};">${sign}${v}k</td>`;
      }).join('');
      const isCO = st === 'CO';
      return `<tr><td style="font-weight:${isCO?'800':'600'};">${STATE_NAMES[st]}${isCO?' ‚Üê':''}</td>${cells}</tr>`;
    }).join('');
  }

  let migrationInst = null, costBurdenInst = null;

  function renderMigrationChart() {
    const ctx = document.getElementById('migrationChart');
    if (!ctx) return;
    if (migrationInst) { migrationInst.destroy(); migrationInst = null; }
    const vals = STATES.map(s => STATE_DATA[s].migration);
    migrationInst = new Chart(ctx, {
      type: 'bar',
      data: { labels: STATES.map(s => STATE_NAMES[s]),
        datasets: [{ label:'Net Migration (k)', data: vals,
          backgroundColor: vals.map(v => v >= 0 ? GOOD()+'aa' : BAD()+'aa'), borderRadius:4 }] },
      options: { responsive:true, maintainAspectRatio:false,
        plugins: { legend:{display:false} },
        scales: baseScaleOpts() }
    });
  }

  function renderCostBurdenChart() {
    const ctx = document.getElementById('costBurdenChart');
    if (!ctx) return;
    if (costBurdenInst) { costBurdenInst.destroy(); costBurdenInst = null; }
    costBurdenInst = new Chart(ctx, {
      type: 'bar',
      data: { labels: STATES.map(s => STATE_NAMES[s]),
        datasets: [
          { label:'>30% burden', data: STATES.map(s => STATE_DATA[s].cost_burden),    backgroundColor: WARN()+'99', borderRadius:3 },
          { label:'>50% burden', data: STATES.map(s => STATE_DATA[s].cost_burden_50), backgroundColor: BAD()+'99',  borderRadius:3 }
        ] },
      options: { responsive:true, maintainAspectRatio:false,
        plugins: { legend:{ labels:{ color:TEXT(), font:{size:11} } } },
        scales: { x: { ticks:{color:MUTED(),font:{size:10}}, grid:{color:BORDER()} },
                  y: { ticks:{color:MUTED(),font:{size:10}}, grid:{color:BORDER()},
                       title:{display:true,text:'% of renters',color:MUTED(),font:{size:10}} } } }
    });
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 2 ‚Äî AMI Gap Trend Analysis
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  let trendInsts = {};

  function destroyTrend() {
    Object.values(trendInsts).forEach(c => { try { c.destroy(); } catch(e) {} });
    trendInsts = {};
  }

  function renderTrendCharts(county, ami) {
    destroyTrend();
    const d    = getTrendData(county, parseInt(ami, 10));
    const opts = { responsive:true, maintainAspectRatio:false };

    /* Household growth vs unit production */
    const ctxG = document.getElementById('trendGrowthChart');
    if (ctxG) {
      trendInsts.growth = new Chart(ctxG, {
        type: 'line',
        data: { labels: ALL_YEARS, datasets: [
          { label:'Households', borderColor:BAD(), tension:.3,
            data: [...d.histHH, ...d.projHH],
            segment: { borderDash: ctx => ctx.p0DataIndex >= 7 ? [5,4] : undefined },
            pointRadius: ALL_YEARS.map((_,i) => i < 8 ? 3 : 0), fill:false },
          { label:'Affordable Units', borderColor:GOOD(), tension:.3,
            data: [...d.histUnits, ...d.projUnits],
            segment: { borderDash: ctx => ctx.p0DataIndex >= 7 ? [5,4] : undefined },
            pointRadius: ALL_YEARS.map((_,i) => i < 8 ? 3 : 0), fill:false }
        ] },
        options: { ...opts, plugins:{ legend:{ labels:{ color:TEXT(), font:{size:11} } } }, scales: baseScaleOpts() }
      });
    }

    /* YoY gap change */
    const ctxY = document.getElementById('trendYoyChart');
    if (ctxY) {
      trendInsts.yoy = new Chart(ctxY, {
        type: 'bar',
        data: { labels: YEARS_HIST, datasets: [{
          label:'YoY Gap Change', data: d.yoyChange,
          backgroundColor: d.yoyChange.map(v => v > 0 ? BAD()+'bb' : GOOD()+'bb'), borderRadius:3 }] },
        options: { ...opts, plugins:{ legend:{display:false} }, scales: baseScaleOpts() }
      });
    }

    /* Cumulative deficit */
    const ctxC = document.getElementById('trendCumulativeChart');
    if (ctxC) {
      trendInsts.cum = new Chart(ctxC, {
        type: 'line',
        data: { labels: YEARS_HIST, datasets: [{
          label:'Cumulative Deficit', data: d.cumDeficit,
          borderColor: BAD(), fill:true, backgroundColor: BAD()+'22', tension:.3, pointRadius:3 }] },
        options: { ...opts, plugins:{ legend:{display:false} }, scales: baseScaleOpts() }
      });
    }

    /* Scatter: population growth correlation */
    const ctxS = document.getElementById('trendScatterChart');
    if (ctxS) {
      trendInsts.scatter = new Chart(ctxS, {
        type: 'scatter',
        data: { datasets: [{ label:'Gap vs. Pop Growth', data: d.scatter,
          backgroundColor: ACCENT()+'bb', pointRadius:5, pointHoverRadius:7 }] },
        options: { ...opts, plugins:{ legend:{display:false} },
          scales: {
            x: { title:{display:true,text:'Pop. Growth Rate (%)',color:MUTED(),font:{size:10}},
                 ticks:{color:MUTED(),font:{size:10}}, grid:{color:BORDER()} },
            y: { title:{display:true,text:'Gap Size (units)',color:MUTED(),font:{size:10}},
                 ticks:{color:MUTED(),font:{size:10}}, grid:{color:BORDER()} } } }
      });
    }

    /* Seasonal supply patterns */
    const ctxSeas = document.getElementById('trendSeasonalChart');
    if (ctxSeas) {
      const yrs  = ['2023','2024','2025'];
      const cols = [ACCENT(), WARN(), BAD()];
      trendInsts.seasonal = new Chart(ctxSeas, {
        type: 'bar',
        data: { labels:['Q1','Q2','Q3','Q4'],
          datasets: yrs.map((y,i) => ({ label:y, data:d.seasonal[i], backgroundColor:cols[i]+'99', borderRadius:3, barPercentage:.7 })) },
        options: { ...opts, plugins:{ legend:{ labels:{ color:TEXT(), font:{size:11} } } },
          scales: { x: { ticks:{color:MUTED(),font:{size:10}}, grid:{color:BORDER()} },
                    y: { title:{display:true,text:'Completions Index (Q1=100)',color:MUTED(),font:{size:10}},
                         ticks:{color:MUTED(),font:{size:10}}, grid:{color:BORDER()} } } }
      });
    }

    /* Scenario cards */
    const setEl = (id, v) => { const e=document.getElementById(id); if(e) e.textContent=v.toLocaleString(); };
    setEl('sqUnits', d.sqGap[3]);
    setEl('mrUnits', d.mrGap[3]);
    setEl('arUnits', d.arGap[3]);

    const kpiRow = document.getElementById('scenarioKpiRow');
    if (kpiRow) {
      const sqU = d.sqGap[3], mrU = d.mrGap[3], arU = d.arGap[3];
      const rMR = Math.round((sqU-mrU)/sqU*100);
      const rAR = Math.round((sqU-arU)/sqU*100);
      kpiRow.innerHTML = `
        <div class="kpi-card"><div class="kpi-value" style="color:var(--bad);">${sqU.toLocaleString()}</div>
          <div class="kpi-label">Status Quo 2030 Gap</div></div>
        <div class="kpi-card"><div class="kpi-value" style="color:var(--warn);">${mrU.toLocaleString()}</div>
          <div class="kpi-label">Moderate Reform Gap</div><div class="kpi-source">${rMR}% reduction</div></div>
        <div class="kpi-card"><div class="kpi-value" style="color:var(--good);">${arU.toLocaleString()}</div>
          <div class="kpi-label">Aggressive Reform Gap</div><div class="kpi-source">${rAR}% reduction</div></div>
        <div class="kpi-card"><div class="kpi-value">${(sqU-arU).toLocaleString()}</div>
          <div class="kpi-label">Max Achievable Reduction</div><div class="kpi-source">Aggressive vs Status Quo</div></div>`;
    }
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 3 ‚Äî Policy Impact Simulator
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  const SLIDERS = [
    { id:'sl_lihtc',     label:'LIHTC % Increase',          min:0,   max:100,  step:5,   unit:'%',          def:0,
      desc:'Increase in annual state LIHTC allocation' },
    { id:'sl_ami_cap',   label:'AMI Concentration Cap',      min:0,   max:50,   step:5,   unit:'%',          def:0,
      desc:'Maximum % of units at any single AMI band (0 = no cap)' },
    { id:'sl_iz',        label:'Inclusionary Zoning (%)',    min:0,   max:25,   step:1,   unit:'%',          def:0,
      desc:'Required affordable % in new market-rate buildings' },
    { id:'sl_tod',       label:'TOD Level',                  min:0,   max:3,    step:1,   unit:'',           def:0,
      desc:'Transit-Oriented Development density ‚Äî 0 None ¬∑ 1 Low ¬∑ 2 Medium ¬∑ 3 High' },
    { id:'sl_zoning',    label:'Zoning Reform',              min:0,   max:3,    step:1,   unit:'',           def:0,
      desc:'By-right ADU/missing-middle reform ‚Äî 0 None ¬∑ 1 Low ¬∑ 2 Medium ¬∑ 3 High' },
    { id:'sl_tax_abate', label:'Property Tax Abatement',     min:0,   max:5000, step:250, unit:'$/unit/yr',  def:0,
      desc:'Annual tax savings per affordable unit via abatement program' },
    { id:'sl_migration', label:'Remote-Work Migration',      min:-20, max:60,   step:5,   unit:'k/yr',       def:0,
      desc:'Net additional in-migrants per year (negative = out-migration)' }
  ];
  const SIM_BASELINE = 15000;
  const TOD_MAP    = { 0:0, 1:400,  2:800,  3:1200 };
  const ZONING_MAP = { 0:0, 1:600,  2:1200, 3:2000 };

  function calcSim(vals) {
    const lihtcU = (vals.sl_lihtc / 10) * 650 * 4;
    const izU    = (vals.sl_iz / 5) * 225 * 4;
    const todU   = (TOD_MAP[vals.sl_tod] || 0) * 4;
    const zonU   = (ZONING_MAP[vals.sl_zoning] || 0) * 4;
    const taxU   = Math.round(vals.sl_tax_abate / 500 * 200 * 4);
    const migD   = Math.max(0, Math.round(vals.sl_migration * 1000 * 0.35 * 0.6 * 4));
    const produced = lihtcU + izU + todU + zonU + taxU;
    return { produced, demand: migD, net: produced - migD };
  }

  let simCompareInst = null;

  function renderSimCompare(vals) {
    const ctx = document.getElementById('simCompareChart');
    if (!ctx) return;
    if (simCompareInst) { simCompareInst.destroy(); simCompareInst = null; }
    const { net } = calcSim(vals);
    const amiArr  = [30, 50, 60, 80];
    const scale   = { 30:2.8, 50:1.87, 60:1, 80:0.13 };
    const before  = amiArr.map(a => Math.round(SIM_BASELINE * scale[a]));
    const after   = amiArr.map(a => Math.max(0, Math.round((SIM_BASELINE - net * scale[a] / scale[60]) * scale[a])));
    simCompareInst = new Chart(ctx, {
      type: 'bar',
      data: { labels: amiArr.map(a => a+'% AMI'), datasets: [
        { label:'Baseline Gap',  data: before, backgroundColor: BAD()+'99',    borderRadius:4 },
        { label:'After Policy',  data: after,  backgroundColor: ACCENT()+'99', borderRadius:4 }
      ] },
      options: { responsive:true, maintainAspectRatio:false,
        plugins: { legend:{ labels:{ color:TEXT(), font:{size:11} } } },
        scales: { x: { ticks:{color:MUTED(),font:{size:10}}, grid:{color:BORDER()} },
                  y: { title:{display:true,text:'Unit Gap',color:MUTED(),font:{size:10}},
                       ticks:{color:MUTED(),font:{size:10}}, grid:{color:BORDER()} } } }
    });
  }

  function updateCBPanel(vals) {
    const el = document.getElementById('cbRows');
    if (!el) return;
    const { produced, demand, net } = calcSim(vals);
    if (produced === 0) {
      el.innerHTML = '<div style="font-size:.82rem;color:var(--faint);text-align:center;padding:1rem 0;">Move sliders above 0 to see cost‚Äìbenefit analysis</div>';
      return;
    }
    const devCost   = produced * 320000;
    const annualSub = produced * 8500;
    const annualBen = produced * 15200;
    const netBen    = annualBen - annualSub;
    const breakEven = (devCost / netBen).toFixed(1);
    const rows = [
      { l:'Units Produced by 2030',    v: produced.toLocaleString(),                       c: ACCENT() },
      { l:'Migration Demand Increase', v: demand > 0 ? '+'+demand.toLocaleString() : '0',  c: demand > 0 ? BAD() : '' },
      { l:'Net Gap Reduction',         v: net > 0 ? '-'+net.toLocaleString() : '0',         c: net > 0 ? GOOD() : BAD() },
      { l:'Total Development Cost',    v: '$'+Math.round(devCost/1e6)+'M',                 c: '' },
      { l:'Annual Subsidy Cost',       v: '$'+Math.round(annualSub/1e6)+'M/yr',            c: '' },
      { l:'Estimated Annual Benefit',  v: '$'+Math.round(annualBen/1e6)+'M/yr',            c: GOOD() },
      { l:'Net Annual Benefit',        v: '$'+Math.round(netBen/1e6)+'M/yr',               c: GOOD() },
      { l:'Break-even (years)',        v: breakEven+' yrs',                                c: '' }
    ];
    el.innerHTML = rows.map(r =>
      `<div class="cb-row"><span>${r.l}</span><span class="cb-val" style="${r.c?'color:'+r.c+';':''}">${r.v}</span></div>`
    ).join('');
  }

  function updateSimKpis(vals) {
    const el = document.getElementById('simKpiGrid');
    if (!el) return;
    const { produced, net } = calcSim(vals);
    const gapAfter   = Math.max(0, SIM_BASELINE - net);
    const pctReduct  = net > 0 ? (net / SIM_BASELINE * 100).toFixed(1) : '0.0';
    const gapColor   = gapAfter < 5000 ? 'var(--good)' : gapAfter < 10000 ? 'var(--warn)' : 'var(--bad)';
    el.innerHTML = `
      <div class="kpi-card"><div class="kpi-value" style="color:var(--bad);">${SIM_BASELINE.toLocaleString()}</div>
        <div class="kpi-label">Baseline 2030 Gap (60% AMI)</div><div class="kpi-source">Status Quo projection</div></div>
      <div class="kpi-card"><div class="kpi-value" style="color:${ACCENT()};">${produced.toLocaleString()}</div>
        <div class="kpi-label">Units Produced by Policy</div><div class="kpi-source">2027‚Äì2030</div></div>
      <div class="kpi-card"><div class="kpi-value" style="color:${net>0?'var(--good)':'var(--bad)'};">${pctReduct}%</div>
        <div class="kpi-label">Gap Reduction</div><div class="kpi-source">${net>0?'‚Üì Improvement':'No net gain'}</div></div>
      <div class="kpi-card"><div class="kpi-value" style="color:${gapColor};">${gapAfter.toLocaleString()}</div>
        <div class="kpi-label">Remaining Gap (2030)</div><div class="kpi-source">After all policies</div></div>`;
  }

  function getSimVals() {
    const v = {};
    SLIDERS.forEach(s => { const el = document.getElementById(s.id); v[s.id] = el ? parseFloat(el.value) : s.def; });
    return v;
  }

  function onSimChange() {
    const v = getSimVals();
    renderSimCompare(v);
    updateCBPanel(v);
    updateSimKpis(v);
  }

  function buildSliders() {
    const grid = document.getElementById('sliderGrid');
    if (!grid) return;
    grid.innerHTML = SLIDERS.map(s => `
      <div class="slider-row">
        <label for="${s.id}">${s.label}
          <span id="${s.id}_val">${s.def}${s.unit}</span>
        </label>
        <input type="range" id="${s.id}" min="${s.min}" max="${s.max}" step="${s.step}" value="${s.def}"
               aria-label="${s.label}" aria-describedby="${s.id}_desc" />
        <div id="${s.id}_desc" class="slider-desc">${s.desc}</div>
      </div>`).join('');
    SLIDERS.forEach(s => {
      const el = document.getElementById(s.id);
      if (el) el.addEventListener('input', () => {
        const valEl = document.getElementById(s.id+'_val');
        if (valEl) valEl.textContent = el.value + s.unit;
        onSimChange();
      });
    });
  }

  window.applySimPreset = function(preset) {
    const P = {
      reset:      { sl_lihtc:0,  sl_ami_cap:0,  sl_iz:0,  sl_tod:0, sl_zoning:0, sl_tax_abate:0,    sl_migration:0  },
      moderate:   { sl_lihtc:25, sl_ami_cap:30, sl_iz:10, sl_tod:1, sl_zoning:1, sl_tax_abate:1500, sl_migration:10 },
      aggressive: { sl_lihtc:50, sl_ami_cap:20, sl_iz:20, sl_tod:3, sl_zoning:3, sl_tax_abate:4000, sl_migration:20 }
    };
    const p = P[preset]; if (!p) return;
    SLIDERS.forEach(s => {
      const el  = document.getElementById(s.id);
      const vel = document.getElementById(s.id+'_val');
      const val = p[s.id] != null ? p[s.id] : s.def;
      if (el)  el.value = val;
      if (vel) vel.textContent = val + s.unit;
    });
    onSimChange();
  };

  window.exportSimCSV = function() {
    const v = getSimVals();
    const { produced, demand, net } = calcSim(v);
    const rows = [
      ['Parameter', 'Value'],
      ...SLIDERS.map(s => [s.label, v[s.id] + s.unit]),
      ['---', '---'],
      ['Baseline 2030 Gap (60% AMI)', SIM_BASELINE],
      ['Units Produced by Policy (2027-2030)', produced],
      ['Migration Demand Increase', demand],
      ['Net Gap Reduction', net],
      ['Remaining Gap 2030', Math.max(0, SIM_BASELINE - net)],
      ['Gap Reduction %', net > 0 ? (net/SIM_BASELINE*100).toFixed(1)+'%' : '0%'],
      ['Total Development Cost', '$'+Math.round(produced*320000/1e6)+'M'],
      ['Annual Net Benefit', '$'+Math.round(produced*(15200-8500)/1e6)+'M/yr'],
      ['Generated', new Date().toISOString()]
    ];
    const csv  = rows.map(r => r.map(x => '"'+String(x).replace(/"/g,'""')+'"').join(',')).join('\r\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const a    = document.createElement('a');
    a.href     = URL.createObjectURL(blob);
    a.download = 'co-policy-simulator-'+new Date().toISOString().slice(0,10)+'.csv';
    document.body.appendChild(a); a.click();
    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(a.href); }, 100);
  };

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     INITIALIZATION
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  function init() {
    /* Section 1 */
    const metricSel = document.getElementById('stateMetricSelect');
    if (metricSel) {
      renderStateComparison(metricSel.value);
      renderAmiHeatmap();
      renderMigrationChart();
      renderCostBurdenChart();
      metricSel.addEventListener('change', () => renderStateComparison(metricSel.value));
    }

    /* Section 2 */
    const countySel = document.getElementById('trendCountySelect');
    const amiSel    = document.getElementById('trendAmiSelect');
    if (countySel && amiSel) {
      renderTrendCharts(countySel.value, amiSel.value);
      const onChange = () => renderTrendCharts(countySel.value, amiSel.value);
      countySel.addEventListener('change', onChange);
      amiSel.addEventListener('change', onChange);
    }

    /* Section 3 */
    buildSliders();
    onSimChange();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

  <div id="site-footer"></div>

  
  

  
</main>

<script src="js/vendor/leaflet.js"></script>
  <script>
/**
 * co-lihtc-map.js  ‚Äî Colorado Deep Dive Leaflet map
 * Zoom lock: ~50 miles (~0.75¬∞) beyond the Colorado border.
 * Falls back to embedded data when HUD ArcGIS APIs are unreachable.
 */
(function () {
  'use strict';

  // Fix Leaflet marker icon paths when using vendored assets
  if (window.L && L.Icon && L.Icon.Default) {
    L.Icon.Default.mergeOptions({
      iconUrl:       'js/vendor/images/marker-icon.png',
      iconRetinaUrl: 'js/vendor/images/marker-icon-2x.png',
      shadowUrl:     'js/vendor/images/marker-shadow.png'
    });
  }

  function $id(id) { return document.getElementById(id); }

  async function fetchJSON(url, opts) {
    const res = await fetch(url, opts);
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${url}`);
    return res.json();
  }

  async function arcgisQuery(layerUrl, where, outFields, extraParams) {
    const PAGE = 1000;
    let offset = 0;
    const all = { type: 'FeatureCollection', features: [] };
    let pages = 0;
    while (true) {
      const p = new URLSearchParams({
        where: where || '1=1', outFields: outFields || '*',
        returnGeometry: 'true', f: 'geojson',
        resultRecordCount: String(PAGE), resultOffset: String(offset),
        outSR: '4326', returnExceededLimitFeatures: 'true',
        ...(extraParams || {})
      });
      let gj;
      try {
        const ctrl = new AbortController();
        const timer = setTimeout(() => ctrl.abort(), 12000);
        gj = await fetchJSON(`${layerUrl}/query?${p}`, { signal: ctrl.signal });
        clearTimeout(timer);
      } catch (e) { console.warn('ArcGIS query failed:', layerUrl, e.message); break; }
      const feats = gj && Array.isArray(gj.features) ? gj.features : [];
      if (feats.length === 0) break;
      all.features.push(...feats);
      const exceeded = !!(gj.exceededTransferLimit || (gj.properties && gj.properties.exceededTransferLimit));
      if (!exceeded && feats.length < PAGE) break;
      offset += PAGE; pages++;
      if (pages > 150) break;
    }
    return all;
  }

  const CO_PLACES_URL    = 'https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/Places_CouSub_ConCity_SubMCD/MapServer/4';
  const HUD_LIHTC_LAYER  = 'https://egis.hud.gov/arcgis/rest/services/affht/AffhtMapService/MapServer/30';
  const QCT_LAYER        = 'https://services.arcgis.com/VTyQ9soqVukalItT/arcgis/rest/services/Qualified_Census_Tracts_2026/FeatureServer/0';
  const DDA_LAYER        = 'https://services.arcgis.com/VTyQ9soqVukalItT/arcgis/rest/services/Difficult_Development_Areas_2026/FeatureServer/0';

  function styleState()  { return { color: 'rgba(255,255,255,0.80)', weight: 3,   fill: false }; }
  function styleCounty() {
    // Keep county outlines readable even if basemap tiles are blocked.
    return {
      color: 'rgba(255,255,255,0.55)',
      weight: 1.2,
      fill: true,
      fillColor: 'rgba(255,255,255,0.04)',
      fillOpacity: 0.20
    };
  }
  function stylePlace()  { return { color: 'rgba(140,200,255,0.35)', weight: 0.8, fill: false, dashArray: '3,5' }; }
  function styleQCT()    { return { color: 'rgba(80,220,160,0.9)',  weight: 1.5, fillColor: 'rgba(80,220,160,0.18)', fillOpacity: 1 }; }
  function styleDDA()    { return { color: 'rgba(255,185,60,0.9)',  weight: 1.5, fillColor: 'rgba(255,185,60,0.15)', fillOpacity: 1 }; }

  function buildPopup(p) {
    const safe = v => (v == null || v === '') ? '‚Äî' : String(v);
    const yn   = v => (v===1||v==='1'||v==='Y'||v===true)
      ? '<span style="color:#34d399">Yes</span>'
      : '<span style="color:#94a3b8">No</span>';
    const addr = [p.STD_ADDR||p.PROJ_ADD, p.STD_CITY||p.PROJ_CTY, p.STD_ST||p.PROJ_ST, p.STD_ZIP5].filter(Boolean).join(', ');
    return `<div style="min-width:240px;max-width:300px;font-size:13px;">
      <div style="font-weight:800;font-size:14px;margin-bottom:5px;line-height:1.3;">${safe(p.PROJECT||p.PROJ_NM)||'LIHTC Project'}</div>
      ${addr?`<div style="margin-bottom:8px;opacity:.8;">${addr}</div>`:''}
      <table style="width:100%;border-collapse:collapse;">
        <tr><td style="padding:2px 0;opacity:.7;">Total units</td><td style="text-align:right;font-weight:700;">${safe(p.N_UNITS)}</td></tr>
        <tr><td style="padding:2px 0;opacity:.7;">Low-income units</td><td style="text-align:right;font-weight:700;">${safe(p.LI_UNITS)}</td></tr>
        <tr><td style="padding:2px 0;opacity:.7;">Placed in service</td><td style="text-align:right;">${safe(p.YR_PIS)}</td></tr>
        <tr><td style="padding:2px 0;opacity:.7;">Credit type</td><td style="text-align:right;">${safe(p.CREDIT)}</td></tr>
        <tr><td style="padding:2px 0;opacity:.7;">QCT</td><td style="text-align:right;">${yn(p.QCT)}</td></tr>
        <tr><td style="padding:2px 0;opacity:.7;">DDA</td><td style="text-align:right;">${yn(p.DDA)}</td></tr>
        <tr><td style="padding:2px 0;opacity:.7;">County</td><td style="text-align:right;">${safe(p.CNTY_NAME||p.PROJ_CTY)}</td></tr>
        ${p.HUD_ID?`<tr><td style="padding:2px 0;opacity:.7;">HUD ID</td><td style="text-align:right;font-size:11px;">${safe(p.HUD_ID)}</td></tr>`:''}
      </table>
      <div style="margin-top:8px;font-size:11px;opacity:.55;">Source: HUD LIHTC Database</div>
    </div>`;
  }

  function addLegend(map) {
    const ctrl = L.control({ position: 'bottomright' });
    ctrl.onAdd = () => {
      const div = L.DomUtil.create('div', 'map-legend');
      div.innerHTML = `
        <div style="font-weight:800;margin-bottom:7px;font-size:13px;">Legend</div>
        <div class="row"><span class="dot" style="background:#5ec8f8;"></span><span>LIHTC project (HUD)</span></div>
        <div class="row"><span class="swatch" style="background:rgba(80,220,160,.25);border-color:rgba(80,220,160,.6)"></span><span>QCT 2026</span></div>
        <div class="row"><span class="swatch" style="background:rgba(255,185,60,.22);border-color:rgba(255,185,60,.6)"></span><span>DDA 2026</span></div>
        <div class="row"><span class="dot" style="background:rgba(255,255,255,.35);border:1px solid rgba(255,255,255,.55);"></span><span>State/county boundary</span></div>
        <div class="row"><span class="swatch" style="background:transparent;border:1px dashed rgba(140,200,255,.5)"></span><span>Place boundary</span></div>
      `;
      L.DomEvent.disableClickPropagation(div);
      L.DomEvent.disableScrollPropagation(div);
      return div;
    };
    ctrl.addTo(map);
  }

  function setStatus(el, msg, type) {
    if (!el) return;
    const c = { ok:'var(--good)', warn:'var(--warn)', err:'var(--bad)', info:'var(--muted)' };
    el.textContent = msg; el.style.color = c[type]||'var(--muted)';
    if (type === 'ok') el.dataset.ok = '1';
  }

  /* =====================================================================
     EMBEDDED FALLBACK DATA
     Representative Colorado LIHTC projects, QCT tracts, and DDA zones
     used when HUD ArcGIS APIs are unreachable.
     ===================================================================== */
  const FALLBACK_LIHTC = {type:'FeatureCollection',features:[
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9903,39.7392]},properties:{PROJECT:'Lincoln Park Apartments',PROJ_ADD:'1500 W 13th Ave',PROJ_CTY:'Denver',PROJ_ST:'CO',N_UNITS:120,LI_UNITS:120,YR_PIS:2018,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Denver'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9748,39.7519]},properties:{PROJECT:'Curtis Park Lofts',PROJ_ADD:'3100 Downing St',PROJ_CTY:'Denver',PROJ_ST:'CO',N_UNITS:72,LI_UNITS:72,YR_PIS:2016,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Denver'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9875,39.7281]},properties:{PROJECT:'Baker Senior Residences',PROJ_ADD:'250 W Alameda Ave',PROJ_CTY:'Denver',PROJ_ST:'CO',N_UNITS:55,LI_UNITS:55,YR_PIS:2020,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Denver'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9620,39.7617]},properties:{PROJECT:'Five Points Commons',PROJ_ADD:'2800 Welton St',PROJ_CTY:'Denver',PROJ_ST:'CO',N_UNITS:96,LI_UNITS:96,YR_PIS:2019,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Denver'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9540,39.6934]},properties:{PROJECT:'Sun Valley Senior Housing',PROJ_ADD:'4500 Morrison Rd',PROJ_CTY:'Denver',PROJ_ST:'CO',N_UNITS:60,LI_UNITS:60,YR_PIS:2021,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Denver'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9980,39.7545]},properties:{PROJECT:'Highland Gardens',PROJ_ADD:'3301 Navajo St',PROJ_CTY:'Denver',PROJ_ST:'CO',N_UNITS:84,LI_UNITS:84,YR_PIS:2017,CREDIT:'4%',QCT:false,DDA:true,CNTY_NAME:'Denver'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9722,39.7755]},properties:{PROJECT:'Globeville Flats',PROJ_ADD:'4400 York St',PROJ_CTY:'Denver',PROJ_ST:'CO',N_UNITS:110,LI_UNITS:110,YR_PIS:2022,CREDIT:'9%',QCT:true,DDA:true,CNTY_NAME:'Denver'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9461,39.7394]},properties:{PROJECT:'Elyria-Swansea Homes',PROJ_ADD:'5501 Washington St',PROJ_CTY:'Denver',PROJ_ST:'CO',N_UNITS:78,LI_UNITS:78,YR_PIS:2020,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Denver'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9310,39.6890]},properties:{PROJECT:'Montbello Seniors',PROJ_ADD:'12000 E MLK Jr Blvd',PROJ_CTY:'Denver',PROJ_ST:'CO',N_UNITS:65,LI_UNITS:65,YR_PIS:2018,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Denver'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.8851,39.6784]},properties:{PROJECT:'Aurora Family Commons',PROJ_ADD:'1700 S Havana St',PROJ_CTY:'Aurora',PROJ_ST:'CO',N_UNITS:150,LI_UNITS:150,YR_PIS:2021,CREDIT:'4%',QCT:false,DDA:true,CNTY_NAME:'Arapahoe'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.8325,39.6950]},properties:{PROJECT:'Aurora Senior Village',PROJ_ADD:'16000 E Colfax Ave',PROJ_CTY:'Aurora',PROJ_ST:'CO',N_UNITS:90,LI_UNITS:90,YR_PIS:2019,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Arapahoe'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.8629,39.7145]},properties:{PROJECT:'Peoria Crossing',PROJ_ADD:'11400 E 26th Ave',PROJ_CTY:'Aurora',PROJ_ST:'CO',N_UNITS:108,LI_UNITS:108,YR_PIS:2020,CREDIT:'4%',QCT:false,DDA:true,CNTY_NAME:'Adams'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9921,39.8370]},properties:{PROJECT:'Thornton Gardens',PROJ_ADD:'9500 Colorado Blvd',PROJ_CTY:'Thornton',PROJ_ST:'CO',N_UNITS:120,LI_UNITS:120,YR_PIS:2022,CREDIT:'4%',QCT:false,DDA:true,CNTY_NAME:'Adams'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.0022,39.8562]},properties:{PROJECT:'Westminster Commons',PROJ_ADD:'7600 Federal Blvd',PROJ_CTY:'Westminster',PROJ_ST:'CO',N_UNITS:80,LI_UNITS:80,YR_PIS:2017,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Adams'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9530,39.8895]},properties:{PROJECT:'Brighton Family Flats',PROJ_ADD:'450 N Main St',PROJ_CTY:'Brighton',PROJ_ST:'CO',N_UNITS:66,LI_UNITS:66,YR_PIS:2023,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'Adams'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.0866,39.6430]},properties:{PROJECT:'Lakewood Pointe',PROJ_ADD:'1200 Garrison St',PROJ_CTY:'Lakewood',PROJ_ST:'CO',N_UNITS:92,LI_UNITS:92,YR_PIS:2018,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'Jefferson'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.1022,39.7531]},properties:{PROJECT:'Arvada Senior Housing',PROJ_ADD:'7700 Grandview Ave',PROJ_CTY:'Arvada',PROJ_ST:'CO',N_UNITS:70,LI_UNITS:70,YR_PIS:2016,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'Jefferson'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.0749,39.9028]},properties:{PROJECT:'Broomfield Crossings',PROJ_ADD:'1 W 1st Ave',PROJ_CTY:'Broomfield',PROJ_ST:'CO',N_UNITS:88,LI_UNITS:88,YR_PIS:2020,CREDIT:'4%',QCT:false,DDA:true,CNTY_NAME:'Broomfield'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.2705,40.0150]},properties:{PROJECT:'Boulder Commons',PROJ_ADD:'1850 Folsom St',PROJ_CTY:'Boulder',PROJ_ST:'CO',N_UNITS:100,LI_UNITS:100,YR_PIS:2021,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'Boulder'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.1019,40.0659]},properties:{PROJECT:'Longmont Family Apts',PROJ_ADD:'1200 Coffman St',PROJ_CTY:'Longmont',PROJ_ST:'CO',N_UNITS:76,LI_UNITS:76,YR_PIS:2019,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Boulder'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.8214,38.8339]},properties:{PROJECT:'Springs Family Village',PROJ_ADD:'2500 E Platte Ave',PROJ_CTY:'Colorado Springs',PROJ_ST:'CO',N_UNITS:130,LI_UNITS:130,YR_PIS:2018,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'El Paso'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.8614,38.8658]},properties:{PROJECT:'Pikes Peak Seniors',PROJ_ADD:'305 W Cimarron St',PROJ_CTY:'Colorado Springs',PROJ_ST:'CO',N_UNITS:75,LI_UNITS:75,YR_PIS:2017,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'El Paso'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.7981,38.7826]},properties:{PROJECT:'Fountain Meadows',PROJ_ADD:'200 Iowa Ave',PROJ_CTY:'Fountain',PROJ_ST:'CO',N_UNITS:60,LI_UNITS:60,YR_PIS:2020,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'El Paso'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9044,38.9271]},properties:{PROJECT:'Northgate Apts',PROJ_ADD:'5820 Tutt Blvd',PROJ_CTY:'Colorado Springs',PROJ_ST:'CO',N_UNITS:95,LI_UNITS:95,YR_PIS:2022,CREDIT:'4%',QCT:false,DDA:false,CNTY_NAME:'El Paso'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.0844,40.5853]},properties:{PROJECT:'Fort Collins Commons',PROJ_ADD:'424 Pine St',PROJ_CTY:'Fort Collins',PROJ_ST:'CO',N_UNITS:104,LI_UNITS:104,YR_PIS:2019,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'Larimer'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.1400,40.3772]},properties:{PROJECT:'Loveland Senior Village',PROJ_ADD:'1600 N Lincoln Ave',PROJ_CTY:'Loveland',PROJ_ST:'CO',N_UNITS:68,LI_UNITS:68,YR_PIS:2016,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'Larimer'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.6914,40.4233]},properties:{PROJECT:'Greeley Flats',PROJ_ADD:'900 10th St',PROJ_CTY:'Greeley',PROJ_ST:'CO',N_UNITS:90,LI_UNITS:90,YR_PIS:2020,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Weld'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.7099,40.3945]},properties:{PROJECT:'Evans Gardens',PROJ_ADD:'1400 37th St',PROJ_CTY:'Evans',PROJ_ST:'CO',N_UNITS:72,LI_UNITS:72,YR_PIS:2018,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Weld'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.6091,38.2544]},properties:{PROJECT:'Pueblo Senior Manor',PROJ_ADD:'215 N Santa Fe Ave',PROJ_CTY:'Pueblo',PROJ_ST:'CO',N_UNITS:80,LI_UNITS:80,YR_PIS:2017,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Pueblo'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.5920,38.2740]},properties:{PROJECT:'Belmont Apts',PROJ_ADD:'2100 Jerry Murphy Rd',PROJ_CTY:'Pueblo',PROJ_ST:'CO',N_UNITS:66,LI_UNITS:66,YR_PIS:2015,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Pueblo'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-108.5506,39.0639]},properties:{PROJECT:'Grand Junction Crossroads',PROJ_ADD:'700 North Ave',PROJ_CTY:'Grand Junction',PROJ_ST:'CO',N_UNITS:85,LI_UNITS:85,YR_PIS:2021,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Mesa'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-108.4748,39.0877]},properties:{PROJECT:'Mesa Senior Commons',PROJ_ADD:'2900 Patterson Rd',PROJ_CTY:'Grand Junction',PROJ_ST:'CO',N_UNITS:60,LI_UNITS:60,YR_PIS:2018,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'Mesa'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-106.8317,39.6433]},properties:{PROJECT:'Eagle Valley Workforce Housing',PROJ_ADD:'1000 Chambers Ave',PROJ_CTY:'Eagle',PROJ_ST:'CO',N_UNITS:50,LI_UNITS:50,YR_PIS:2022,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'Eagle'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-106.3742,39.5505]},properties:{PROJECT:'Summit County Workforce Apts',PROJ_ADD:'560 Straight Creek Dr',PROJ_CTY:'Dillon',PROJ_ST:'CO',N_UNITS:44,LI_UNITS:44,YR_PIS:2021,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'Summit'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-107.3317,39.5430]},properties:{PROJECT:'Rifle Family Residences',PROJ_ADD:'202 Railroad Ave',PROJ_CTY:'Rifle',PROJ_ST:'CO',N_UNITS:48,LI_UNITS:48,YR_PIS:2019,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'Garfield'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-107.6723,39.5480]},properties:{PROJECT:'Glenwood Commons',PROJ_ADD:'1625 Grand Ave',PROJ_CTY:'Glenwood Springs',PROJ_ST:'CO',N_UNITS:56,LI_UNITS:56,YR_PIS:2020,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'Garfield'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-106.8317,40.4850]},properties:{PROJECT:'Steamboat Affordable Homes',PROJ_ADD:'1775 Hilltop Pkwy',PROJ_CTY:'Steamboat Springs',PROJ_ST:'CO',N_UNITS:36,LI_UNITS:36,YR_PIS:2023,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'Routt'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-107.8659,40.6133]},properties:{PROJECT:'Craig Senior Apts',PROJ_ADD:'440 Yampa Ave',PROJ_CTY:'Craig',PROJ_ST:'CO',N_UNITS:28,LI_UNITS:28,YR_PIS:2016,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'Moffat'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-107.8762,38.4783]},properties:{PROJECT:'Montrose Family Flats',PROJ_ADD:'1500 E Main St',PROJ_CTY:'Montrose',PROJ_ST:'CO',N_UNITS:56,LI_UNITS:56,YR_PIS:2019,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'Montrose'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-107.8625,38.7415]},properties:{PROJECT:'Delta Commons',PROJ_ADD:'261 Meeker St',PROJ_CTY:'Delta',PROJ_ST:'CO',N_UNITS:40,LI_UNITS:40,YR_PIS:2017,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'Delta'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-106.9245,38.5458]},properties:{PROJECT:'Gunnison Workforce Housing',PROJ_ADD:'200 N Boulevard St',PROJ_CTY:'Gunnison',PROJ_ST:'CO',N_UNITS:32,LI_UNITS:32,YR_PIS:2022,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'Gunnison'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.2422,38.4408]},properties:{PROJECT:'Canon City Senior Village',PROJ_ADD:'712 Main St',PROJ_CTY:'Ca√±on City',PROJ_ST:'CO',N_UNITS:48,LI_UNITS:48,YR_PIS:2018,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Fremont'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.8697,37.4694]},properties:{PROJECT:'Alamosa Gardens',PROJ_ADD:'301 State Ave',PROJ_CTY:'Alamosa',PROJ_ST:'CO',N_UNITS:38,LI_UNITS:38,YR_PIS:2015,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Alamosa'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-107.8801,37.2753]},properties:{PROJECT:'Durango Commons',PROJ_ADD:'1200 Camino Del Rio',PROJ_CTY:'Durango',PROJ_ST:'CO',N_UNITS:62,LI_UNITS:62,YR_PIS:2021,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'La Plata'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-108.5847,37.3489]},properties:{PROJECT:'Cortez Affordable Housing',PROJ_ADD:'300 N Chestnut St',PROJ_CTY:'Cortez',PROJ_ST:'CO',N_UNITS:42,LI_UNITS:42,YR_PIS:2018,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'Montezuma'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.0178,39.6462]},properties:{PROJECT:'Englewood Seniors',PROJ_ADD:'3611 S Broadway',PROJ_CTY:'Englewood',PROJ_ST:'CO',N_UNITS:58,LI_UNITS:58,YR_PIS:2016,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Arapahoe'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9671,39.6298]},properties:{PROJECT:'Centennial Crossings',PROJ_ADD:'6900 S York St',PROJ_CTY:'Centennial',PROJ_ST:'CO',N_UNITS:80,LI_UNITS:80,YR_PIS:2020,CREDIT:'4%',QCT:false,DDA:true,CNTY_NAME:'Arapahoe'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9900,39.5911]},properties:{PROJECT:'Littleton Family Homes',PROJ_ADD:'2500 W Main St',PROJ_CTY:'Littleton',PROJ_ST:'CO',N_UNITS:66,LI_UNITS:66,YR_PIS:2018,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'Arapahoe'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9611,39.9050]},properties:{PROJECT:'Northglenn Apartments',PROJ_ADD:'10500 Huron St',PROJ_CTY:'Northglenn',PROJ_ST:'CO',N_UNITS:96,LI_UNITS:96,YR_PIS:2021,CREDIT:'4%',QCT:false,DDA:true,CNTY_NAME:'Adams'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.0198,39.8100]},properties:{PROJECT:'Federal Heights Housing',PROJ_ADD:'2399 W 84th Ave',PROJ_CTY:'Federal Heights',PROJ_ST:'CO',N_UNITS:72,LI_UNITS:72,YR_PIS:2019,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Adams'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-103.8022,40.1844]},properties:{PROJECT:'Morgan County Homes',PROJ_ADD:'300 W Main St',PROJ_CTY:'Fort Morgan',PROJ_ST:'CO',N_UNITS:36,LI_UNITS:36,YR_PIS:2018,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Morgan'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-102.6185,40.1675]},properties:{PROJECT:'Sterling Housing',PROJ_ADD:'330 N 3rd St',PROJ_CTY:'Sterling',PROJ_ST:'CO',N_UNITS:30,LI_UNITS:30,YR_PIS:2019,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Logan'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-103.5536,37.3536]},properties:{PROJECT:'Trinidad Senior Homes',PROJ_ADD:'301 E Main St',PROJ_CTY:'Trinidad',PROJ_ST:'CO',N_UNITS:30,LI_UNITS:30,YR_PIS:2016,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Las Animas'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-107.5017,37.9472]},properties:{PROJECT:'Telluride Workforce Apts',PROJ_ADD:'500 W Colorado Ave',PROJ_CTY:'Telluride',PROJ_ST:'CO',N_UNITS:28,LI_UNITS:28,YR_PIS:2023,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'San Miguel'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-106.8233,39.1839]},properties:{PROJECT:'Basalt Workforce Village',PROJ_ADD:'100 Midland Ave',PROJ_CTY:'Basalt',PROJ_ST:'CO',N_UNITS:40,LI_UNITS:40,YR_PIS:2023,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'Eagle'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-106.3203,39.5130]},properties:{PROJECT:'Silverthorne Commons',PROJ_ADD:'400 Blue River Pkwy',PROJ_CTY:'Silverthorne',PROJ_ST:'CO',N_UNITS:35,LI_UNITS:35,YR_PIS:2022,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'Summit'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.6867,40.3958]},properties:{PROJECT:'Estes Park Workforce',PROJ_ADD:'175 Stanley Ave',PROJ_CTY:'Estes Park',PROJ_ST:'CO',N_UNITS:30,LI_UNITS:30,YR_PIS:2023,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'Larimer'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.8914,40.5256]},properties:{PROJECT:'Windsor Senior Villas',PROJ_ADD:'1600 Main St',PROJ_CTY:'Windsor',PROJ_ST:'CO',N_UNITS:48,LI_UNITS:48,YR_PIS:2022,CREDIT:'9%',QCT:false,DDA:true,CNTY_NAME:'Weld'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.6897,40.3736]},properties:{PROJECT:'Greeley North Commons',PROJ_ADD:'2200 35th Ave',PROJ_CTY:'Greeley',PROJ_ST:'CO',N_UNITS:72,LI_UNITS:72,YR_PIS:2020,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Weld'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.8697,37.4694]},properties:{PROJECT:'Monte Vista Senior Homes',PROJ_ADD:'500 Adams St',PROJ_CTY:'Monte Vista',PROJ_ST:'CO',N_UNITS:30,LI_UNITS:30,YR_PIS:2019,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Rio Grande'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-108.0736,37.1523]},properties:{PROJECT:'Towaoc Tribal Housing',PROJ_ADD:'Ute Mountain Ute Area',PROJ_CTY:'Towaoc',PROJ_ST:'CO',N_UNITS:34,LI_UNITS:34,YR_PIS:2020,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Montezuma'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.1614,37.1895]},properties:{PROJECT:'Walsenburg Commons',PROJ_ADD:'600 W 7th St',PROJ_CTY:'Walsenburg',PROJ_ST:'CO',N_UNITS:20,LI_UNITS:20,YR_PIS:2014,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Huerfano'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.3322,37.4781]},properties:{PROJECT:'Conejos County Housing',PROJ_ADD:'101 Main Ave',PROJ_CTY:'La Jara',PROJ_ST:'CO',N_UNITS:10,LI_UNITS:10,YR_PIS:2018,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Conejos'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.7629,38.6785]},properties:{PROJECT:'Peyton Rural Homes',PROJ_ADD:'County Rd 21',PROJ_CTY:'Peyton',PROJ_ST:'CO',N_UNITS:24,LI_UNITS:24,YR_PIS:2017,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'El Paso'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.4836,37.6778]},properties:{PROJECT:'La Veta Housing',PROJ_ADD:'150 Rosita Ave',PROJ_CTY:'La Veta',PROJ_ST:'CO',N_UNITS:14,LI_UNITS:14,YR_PIS:2018,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'Huerfano'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-103.2158,39.5580]},properties:{PROJECT:'Limon Gateway Apts',PROJ_ADD:'170 E 1st St',PROJ_CTY:'Limon',PROJ_ST:'CO',N_UNITS:22,LI_UNITS:22,YR_PIS:2016,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'Lincoln'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-102.1231,40.0133]},properties:{PROJECT:'Yuma Senior Living',PROJ_ADD:'600 S Main St',PROJ_CTY:'Yuma',PROJ_ST:'CO',N_UNITS:20,LI_UNITS:20,YR_PIS:2017,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'Yuma'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-102.6024,38.0961]},properties:{PROJECT:'Las Animas Apts',PROJ_ADD:'505 Bent Ave',PROJ_CTY:'Las Animas',PROJ_ST:'CO',N_UNITS:18,LI_UNITS:18,YR_PIS:2015,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Bent'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.5916,38.4036]},properties:{PROJECT:'Pueblo West Seniors',PROJ_ADD:'900 Doyle Blvd',PROJ_CTY:'Pueblo West',PROJ_ST:'CO',N_UNITS:44,LI_UNITS:44,YR_PIS:2022,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'Pueblo'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.9764,39.2340]},properties:{PROJECT:'South Park Housing',PROJ_ADD:'200 Main St',PROJ_CTY:'Fairplay',PROJ_ST:'CO',N_UNITS:16,LI_UNITS:16,YR_PIS:2020,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'Park'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9703,40.2586]},properties:{PROJECT:'Dacono Valley Apts',PROJ_ADD:'512 County Rd',PROJ_CTY:'Dacono',PROJ_ST:'CO',N_UNITS:54,LI_UNITS:54,YR_PIS:2020,CREDIT:'9%',QCT:false,DDA:false,CNTY_NAME:'Weld'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-105.0019,39.9870]},properties:{PROJECT:'Thornton East Village',PROJ_ADD:'12200 Colorado Blvd',PROJ_CTY:'Thornton',PROJ_ST:'CO',N_UNITS:82,LI_UNITS:82,YR_PIS:2021,CREDIT:'4%',QCT:false,DDA:true,CNTY_NAME:'Adams'}},
    {type:'Feature',geometry:{type:'Point',coordinates:[-104.9501,39.7200]},properties:{PROJECT:'Capitol Hill Commons',PROJ_ADD:'1400 E Colfax Ave',PROJ_CTY:'Denver',PROJ_ST:'CO',N_UNITS:66,LI_UNITS:66,YR_PIS:2022,CREDIT:'9%',QCT:true,DDA:false,CNTY_NAME:'Denver'}},
  ]};

  const FALLBACK_QCT = {type:'FeatureCollection',features:[
    {type:'Feature',properties:{NAME:'Denver-Globeville QCT',GEOID:'08031006700',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-105.000,39.772],[-104.940,39.772],[-104.940,39.790],[-105.000,39.790],[-105.000,39.772]]]}},
    {type:'Feature',properties:{NAME:'Denver-Five Points QCT',GEOID:'08031007700',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-104.982,39.745],[-104.940,39.745],[-104.940,39.768],[-104.982,39.768],[-104.982,39.745]]]}},
    {type:'Feature',properties:{NAME:'Denver-Sun Valley QCT',GEOID:'08031006800',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-105.010,39.720],[-104.975,39.720],[-104.975,39.740],[-105.010,39.740],[-105.010,39.720]]]}},
    {type:'Feature',properties:{NAME:'Denver-Montbello QCT',GEOID:'08031004601',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-104.955,39.760],[-104.910,39.760],[-104.910,39.810],[-104.955,39.810],[-104.955,39.760]]]}},
    {type:'Feature',properties:{NAME:'Denver-Westwood QCT',GEOID:'08031007400',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-105.050,39.680],[-104.995,39.680],[-104.995,39.718],[-105.050,39.718],[-105.050,39.680]]]}},
    {type:'Feature',properties:{NAME:'Denver-Villa Park QCT',GEOID:'08031008200',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-105.030,39.730],[-104.995,39.730],[-104.995,39.755],[-105.030,39.755],[-105.030,39.730]]]}},
    {type:'Feature',properties:{NAME:'Denver-Barnum QCT',GEOID:'08031008500',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-105.043,39.700],[-105.000,39.700],[-105.000,39.725],[-105.043,39.725],[-105.043,39.700]]]}},
    {type:'Feature',properties:{NAME:'Denver-Swansea QCT',GEOID:'08031009100',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-104.966,39.760],[-104.930,39.760],[-104.930,39.785],[-104.966,39.785],[-104.966,39.760]]]}},
    {type:'Feature',properties:{NAME:'Denver-Capitol Hill QCT',GEOID:'08031003200',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-104.975,39.730],[-104.940,39.730],[-104.940,39.748],[-104.975,39.748],[-104.975,39.730]]]}},
    {type:'Feature',properties:{NAME:'Aurora-Colfax QCT',GEOID:'08005011020',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-104.900,39.720],[-104.840,39.720],[-104.840,39.750],[-104.900,39.750],[-104.900,39.720]]]}},
    {type:'Feature',properties:{NAME:'Aurora-East QCT',GEOID:'08005011800',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-104.840,39.686],[-104.780,39.686],[-104.780,39.710],[-104.840,39.710],[-104.840,39.686]]]}},
    {type:'Feature',properties:{NAME:'Westminster Federal QCT',GEOID:'08001012900',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-105.040,39.843],[-104.990,39.843],[-104.990,39.868],[-105.040,39.868],[-105.040,39.843]]]}},
    {type:'Feature',properties:{NAME:'Colorado Springs-Downtown QCT',GEOID:'08041003200',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-104.851,38.820],[-104.800,38.820],[-104.800,38.858],[-104.851,38.858],[-104.851,38.820]]]}},
    {type:'Feature',properties:{NAME:'Colorado Springs-East QCT',GEOID:'08041004100',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-104.800,38.820],[-104.730,38.820],[-104.730,38.860],[-104.800,38.860],[-104.800,38.820]]]}},
    {type:'Feature',properties:{NAME:'Pueblo-Downtown QCT',GEOID:'08101000300',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-104.635,38.238],[-104.580,38.238],[-104.580,38.278],[-104.635,38.278],[-104.635,38.238]]]}},
    {type:'Feature',properties:{NAME:'Pueblo-North QCT',GEOID:'08101000400',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-104.640,38.278],[-104.575,38.278],[-104.575,38.310],[-104.640,38.310],[-104.640,38.278]]]}},
    {type:'Feature',properties:{NAME:'Greeley QCT',GEOID:'08123000500',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-104.730,40.404],[-104.670,40.404],[-104.670,40.440],[-104.730,40.440],[-104.730,40.404]]]}},
    {type:'Feature',properties:{NAME:'Evans QCT',GEOID:'08123000700',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-104.730,40.380],[-104.680,40.380],[-104.680,40.404],[-104.730,40.404],[-104.730,40.380]]]}},
    {type:'Feature',properties:{NAME:'Longmont East QCT',GEOID:'08013001900',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-105.120,40.148],[-105.070,40.148],[-105.070,40.182],[-105.120,40.182],[-105.120,40.148]]]}},
    {type:'Feature',properties:{NAME:'Grand Junction QCT',GEOID:'08077000200',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-108.590,39.048],[-108.530,39.048],[-108.530,39.085],[-108.590,39.085],[-108.590,39.048]]]}},
    {type:'Feature',properties:{NAME:'Fort Morgan QCT',GEOID:'08087000300',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-103.840,40.244],[-103.780,40.244],[-103.780,40.272],[-103.840,40.272],[-103.840,40.244]]]}},
    {type:'Feature',properties:{NAME:'Sterling QCT',GEOID:'08075001100',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-103.250,40.598],[-103.195,40.598],[-103.195,40.634],[-103.250,40.634],[-103.250,40.598]]]}},
    {type:'Feature',properties:{NAME:'Alamosa QCT',GEOID:'08003000600',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-105.910,37.454],[-105.848,37.454],[-105.848,37.490],[-105.910,37.490],[-105.910,37.454]]]}},
    {type:'Feature',properties:{NAME:'Trinidad QCT',GEOID:'08071000500',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-104.590,37.160],[-104.520,37.160],[-104.520,37.192],[-104.590,37.192],[-104.590,37.160]]]}},
    {type:'Feature',properties:{NAME:'Walsenburg QCT',GEOID:'08055000200',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-104.805,37.620],[-104.760,37.620],[-104.760,37.645],[-104.805,37.645],[-104.805,37.620]]]}},
    {type:'Feature',properties:{NAME:'Ca√±on City QCT',GEOID:'08043000500',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-105.260,38.427],[-105.200,38.427],[-105.200,38.456],[-105.260,38.456],[-105.260,38.427]]]}},
    {type:'Feature',properties:{NAME:'Las Animas QCT',GEOID:'08011000200',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-103.240,38.058],[-103.180,38.058],[-103.180,38.082],[-103.240,38.082],[-103.240,38.058]]]}},
  ]};

  const FALLBACK_DDA = {type:'FeatureCollection',features:[
    {type:'Feature',properties:{NAME:'Denver-Aurora Metro DDA',DDATYPE:'Metropolitan',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-105.15,39.55],[-104.67,39.55],[-104.67,39.98],[-105.15,39.98],[-105.15,39.55]]]}},
    {type:'Feature',properties:{NAME:'Boulder-Broomfield DDA',DDATYPE:'Metropolitan',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-105.35,39.95],[-104.98,39.95],[-104.98,40.15],[-105.35,40.15],[-105.35,39.95]]]}},
    {type:'Feature',properties:{NAME:'Fort Collins DDA',DDATYPE:'Metropolitan',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-105.20,40.52],[-104.98,40.52],[-104.98,40.66],[-105.20,40.66],[-105.20,40.52]]]}},
    {type:'Feature',properties:{NAME:'Eagle County DDA',DDATYPE:'High-Cost Non-Metropolitan',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-107.18,39.44],[-106.29,39.44],[-106.29,39.74],[-107.18,39.74],[-107.18,39.44]]]}},
    {type:'Feature',properties:{NAME:'Summit County DDA',DDATYPE:'High-Cost Non-Metropolitan',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-106.38,39.38],[-105.73,39.38],[-105.73,39.66],[-106.38,39.66],[-106.38,39.38]]]}},
    {type:'Feature',properties:{NAME:'Pitkin County DDA (Aspen)',DDATYPE:'High-Cost Non-Metropolitan',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-107.26,39.12],[-106.68,39.12],[-106.68,39.38],[-107.26,39.38],[-107.26,39.12]]]}},
    {type:'Feature',properties:{NAME:'San Miguel County DDA (Telluride)',DDATYPE:'High-Cost Non-Metropolitan',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-108.20,37.82],[-107.38,37.82],[-107.38,38.15],[-108.20,38.15],[-108.20,37.82]]]}},
    {type:'Feature',properties:{NAME:'Routt County DDA (Steamboat)',DDATYPE:'High-Cost Non-Metropolitan',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-107.28,40.25],[-106.46,40.25],[-106.46,40.74],[-107.28,40.74],[-107.28,40.25]]]}},
    {type:'Feature',properties:{NAME:'Garfield County DDA',DDATYPE:'Non-Metropolitan',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-108.10,39.30],[-107.06,39.30],[-107.06,39.75],[-108.10,39.75],[-108.10,39.30]]]}},
    {type:'Feature',properties:{NAME:'La Plata County DDA (Durango)',DDATYPE:'Non-Metropolitan',STATE:'CO'},geometry:{type:'Polygon',coordinates:[[[-108.12,37.06],[-107.30,37.06],[-107.30,37.58],[-108.12,37.58],[-108.12,37.06]]]}},
  ]};

  /* =====================================================================
     MAIN INIT
     ===================================================================== */
  async function init() {
    const mapEl = $id('coMap');
    if (!mapEl || typeof L === 'undefined') { console.error('Leaflet not loaded or #coMap missing'); return; }
    const statusEl = $id('map-status');

    /* Colorado bbox constants
       True border:  SW 36.99¬∞N 109.06¬∞W ‚Äî NE 41.00¬∞N 102.04¬∞W
       50-mile pad:  ~0.72¬∞ lat, ~0.90¬∞ lon at 39¬∞N              */
    const CO_STRICT    = L.latLngBounds([[36.99,-109.06],[41.00,-102.04]]);
    const CO_MAX_BOUNDS = L.latLngBounds([[36.27,-109.96],[41.72,-101.14]]);

    const map = L.map('coMap', {
      preferCanvas: true,
      zoomControl: true,
      minZoom: 6,
      maxZoom: 14,
      maxBounds: CO_MAX_BOUNDS,
      maxBoundsViscosity: 1.0
    });

    map.createPane('overlayPane2'); map.getPane('overlayPane2').style.zIndex = 410;
    map.createPane('pointsPane2'); map.getPane('pointsPane2').style.zIndex  = 420;
    map.createPane('transportPane'); map.getPane('transportPane').style.zIndex = 215;

    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const darkBasemap  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',  {attribution:'&copy; OpenStreetMap &copy; CARTO',maxZoom:19});
    const lightBasemap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {attribution:'&copy; OpenStreetMap &copy; CARTO',maxZoom:19});
    const baseByKey = { light: lightBasemap, dark: darkBasemap };

    // Default basemap: Auto (matches OS theme), with a manual override.
    let desiredBaseKey = prefersDark ? 'dark' : 'light';
    let activeBase = baseByKey[desiredBaseKey].addTo(map);

    function markTilesLoaded(){ setStatus(statusEl, 'Basemap loaded ‚úì', 'ok'); }
    // Leaflet fires `load` when all visible tiles are loaded.
    activeBase.once('load', markTilesLoaded);

    function swapBasemap(next) {
      try { map.removeLayer(activeBase); } catch(e) {}
      activeBase = next.addTo(map);
      // Reset OK flag so we can show "loaded" after swaps as well.
      if (statusEl) delete statusEl.dataset.ok;
      activeBase.once('load', () => setStatus(statusEl, 'Basemap loaded ‚úì', 'ok'));
    }

    // If the tiles fail to load, fall back to a different provider so overlays are still readable.
    activeBase.on('tileerror', () => {
      console.warn('Basemap tile error ‚Äî falling back');
      // Prefer light CARTO first (usually least blocked), then OSM HOT
      const alt1 = lightBasemap;
      const alt2 = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {attribution:'&copy; OpenStreetMap contributors',maxZoom:19});
      if (activeBase === darkBasemap) swapBasemap(alt1);
      else swapBasemap(alt2);
    });

    // Manual basemap selector (Auto/Light/Dark). Auto follows OS theme on load.
    const baseSel = $id('basemapSelect');
    if (baseSel) {
      baseSel.value = 'auto';
      baseSel.addEventListener('change', () => {
        const v = baseSel.value;
        const key = (v === 'auto') ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : v;
        desiredBaseKey = key;
        const next = baseByKey[key] || lightBasemap;
        swapBasemap(next);
        next.once('load', markTilesLoaded);
      });
    }

    // If the basemap is blocked entirely, show a hint quickly.
    // Overlays should still render, so the map remains useful.
    setTimeout(() => {
      // If we haven't marked OK yet, keep status informative (don't overwrite later success)
      if (statusEl && !statusEl.dataset.ok) {
        setStatus(statusEl, 'Basemap may be blocked ‚Äî overlays should still load', 'warn');
      }
    }, 2500);
const transportLayer = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
      {attribution:'&copy; OpenStreetMap contributors',opacity:0.25,pane:'transportPane',maxZoom:19});

    addLegend(map);

    /* ---------- Step 1: Boundaries (embedded ‚Äî no fetch needed) ---------- */
    setStatus(statusEl, 'Loading boundaries‚Ä¶', 'info');

    const coStateFC   = {"type": "FeatureCollection", "features": [{"type": "Feature", "id": "08", "properties": {"name": "Colorado"}, "geometry": {"type": "Polygon", "coordinates": [[[-109.06, 41.0006], [-102.0424, 41.0006], [-102.0424, 36.9928], [-109.06, 36.9928], [-109.06, 41.0006]]]}}]};
    const coCountiesFC = {"type": "FeatureCollection", "features": [{"type": "Feature", "id": "08", "properties": {"name": "Moffat", "fips": "08081"}, "geometry": {"type": "Polygon", "coordinates": [[[-109.06, 40.222], [-107.316, 40.222], [-107.316, 41.0], [-109.06, 41.0], [-109.06, 40.222]]]}}, {"type": "Feature", "id": "08107", "properties": {"name": "Routt", "fips": "08107"}, "geometry": {"type": "Polygon", "coordinates": [[[-107.316, 40.003], [-106.637, 40.003], [-106.637, 41.0], [-107.316, 41.0], [-107.316, 40.003]]]}}, {"type": "Feature", "id": "08057", "properties": {"name": "Jackson", "fips": "08057"}, "geometry": {"type": "Polygon", "coordinates": [[[-106.637, 40.36], [-105.928, 40.36], [-105.928, 41.0], [-106.637, 41.0], [-106.637, 40.36]]]}}, {"type": "Feature", "id": "08069", "properties": {"name": "Larimer", "fips": "08069"}, "geometry": {"type": "Polygon", "coordinates": [[[-105.928, 40.259], [-104.943, 40.259], [-104.943, 41.0], [-105.928, 41.0], [-105.928, 40.259]]]}}, {"type": "Feature", "id": "08123", "properties": {"name": "Weld", "fips": "08123"}, "geometry": {"type": "Polygon", "coordinates": [[[-104.943, 39.915], [-103.574, 39.915], [-103.574, 41.0], [-104.943, 41.0], [-104.943, 39.915]]]}}, {"type": "Feature", "id": "08075", "properties": {"name": "Logan", "fips": "08075"}, "geometry": {"type": "Polygon", "coordinates": [[[-103.574, 40.349], [-102.813, 40.349], [-102.813, 41.0], [-103.574, 41.0], [-103.574, 40.349]]]}}, {"type": "Feature", "id": "08115", "properties": {"name": "Sedgwick", "fips": "08115"}, "geometry": {"type": "Polygon", "coordinates": [[[-102.813, 40.658], [-102.042, 40.658], [-102.042, 41.0], [-102.813, 41.0], [-102.813, 40.658]]]}}, {"type": "Feature", "id": "08095", "properties": {"name": "Phillips", "fips": "08095"}, "geometry": {"type": "Polygon", "coordinates": [[[-102.813, 40.259], [-102.042, 40.259], [-102.042, 40.658], [-102.813, 40.658], [-102.813, 40.259]]]}}, {"type": "Feature", "id": "08103", "properties": {"name": "Rio Blanco", "fips": "08103"}, "geometry": {"type": "Polygon", "coordinates": [[[-109.06, 39.374], [-107.316, 39.374], [-107.316, 40.222], [-109.06, 40.222], [-109.06, 39.374]]]}}, {"type": "Feature", "id": "08045", "properties": {"name": "Garfield", "fips": "08045"}, "geometry": {"type": "Polygon", "coordinates": [[[-107.316, 39.374], [-106.637, 39.374], [-106.637, 40.003], [-107.316, 40.003], [-107.316, 39.374]]]}}, {"type": "Feature", "id": "08037", "properties": {"name": "Eagle", "fips": "08037"}, "geometry": {"type": "Polygon", "coordinates": [[[-106.637, 39.374], [-106.133, 39.374], [-106.133, 40.003], [-106.637, 40.003], [-106.637, 39.374]]]}}, {"type": "Feature", "id": "08117", "properties": {"name": "Summit", "fips": "08117"}, "geometry": {"type": "Polygon", "coordinates": [[[-106.133, 39.374], [-105.558, 39.374], [-105.558, 40.003], [-106.133, 40.003], [-106.133, 39.374]]]}}, {"type": "Feature", "id": "08049", "properties": {"name": "Grand", "fips": "08049"}, "geometry": {"type": "Polygon", "coordinates": [[[-106.637, 39.915], [-105.928, 39.915], [-105.928, 40.36], [-106.637, 40.36], [-106.637, 39.915]]]}}, {"type": "Feature", "id": "08013", "properties": {"name": "Boulder", "fips": "08013"}, "geometry": {"type": "Polygon", "coordinates": [[[-105.558, 39.915], [-104.942, 39.915], [-104.942, 40.259], [-105.558, 40.259], [-105.558, 39.915]]]}}, {"type": "Feature", "id": "08014", "properties": {"name": "Broomfield", "fips": "08014"}, "geometry": {"type": "Polygon", "coordinates": [[[-105.13, 39.915], [-104.943, 39.915], [-104.943, 40.09], [-105.13, 40.09], [-105.13, 39.915]]]}}, {"type": "Feature", "id": "08001", "properties": {"name": "Adams", "fips": "08001"}, "geometry": {"type": "Polygon", "coordinates": [[[-104.943, 39.573], [-103.574, 39.573], [-103.574, 40.0], [-104.943, 40.0], [-104.943, 39.573]]]}}, {"type": "Feature", "id": "08", "properties": {"name": "Morgan", "fips": "08087"}, "geometry": {"type": "Polygon", "coordinates": [[[-103.574, 39.915], [-103.006, 39.915], [-103.006, 40.349], [-103.574, 40.349], [-103.574, 39.915]]]}}, {"type": "Feature", "id": "08121", "properties": {"name": "Washington", "fips": "08121"}, "geometry": {"type": "Polygon", "coordinates": [[[-103.574, 39.574], [-103.006, 39.574], [-103.006, 39.915], [-103.574, 39.915], [-103.574, 39.574]]]}}, {"type": "Feature", "id": "08125", "properties": {"name": "Yuma", "fips": "08125"}, "geometry": {"type": "Polygon", "coordinates": [[[-103.006, 39.574], [-102.042, 39.574], [-102.042, 40.659], [-103.006, 40.659], [-103.006, 39.574]]]}}, {"type": "Feature", "id": "08077", "properties": {"name": "Mesa", "fips": "08077"}, "geometry": {"type": "Polygon", "coordinates": [[[-109.06, 38.499], [-107.316, 38.499], [-107.316, 39.374], [-109.06, 39.374], [-109.06, 38.499]]]}}, {"type": "Feature", "id": "08029", "properties": {"name": "Delta", "fips": "08029"}, "geometry": {"type": "Polygon", "coordinates": [[[-107.316, 38.499], [-107.008, 38.499], [-107.008, 39.374], [-107.316, 39.374], [-107.316, 38.499]]]}}, {"type": "Feature", "id": "08051", "properties": {"name": "Gunnison", "fips": "08051"}, "geometry": {"type": "Polygon", "coordinates": [[[-107.316, 38.257], [-106.263, 38.257], [-106.263, 38.499], [-107.316, 38.499], [-107.316, 38.257]]]}}, {"type": "Feature", "id": "08", "properties": {"name": "Montrose", "fips": "08085"}, "geometry": {"type": "Polygon", "coordinates": [[[-108.31, 38.257], [-107.316, 38.257], [-107.316, 38.499], [-108.31, 38.499], [-108.31, 38.257]]]}}, {"type": "Feature", "id": "08097", "properties": {"name": "Pitkin", "fips": "08097"}, "geometry": {"type": "Polygon", "coordinates": [[[-107.044, 39.074], [-106.263, 39.074], [-106.263, 39.374], [-107.044, 39.374], [-107.044, 39.074]]]}}, {"type": "Feature", "id": "08065", "properties": {"name": "Lake", "fips": "08065"}, "geometry": {"type": "Polygon", "coordinates": [[[-106.263, 38.857], [-105.928, 38.857], [-105.928, 39.374], [-106.263, 39.374], [-106.263, 38.857]]]}}, {"type": "Feature", "id": "08093", "properties": {"name": "Park", "fips": "08093"}, "geometry": {"type": "Polygon", "coordinates": [[[-105.928, 38.676], [-105.18, 38.676], [-105.18, 39.374], [-105.928, 39.374], [-105.928, 38.676]]]}}, {"type": "Feature", "id": "08059", "properties": {"name": "Jefferson", "fips": "08059"}, "geometry": {"type": "Polygon", "coordinates": [[[-105.24, 39.391], [-104.943, 39.391], [-104.943, 39.914], [-105.24, 39.914], [-105.24, 39.391]]]}}, {"type": "Feature", "id": "08031", "properties": {"name": "Denver", "fips": "08031"}, "geometry": {"type": "Polygon", "coordinates": [[[-105.11, 39.614], [-104.601, 39.614], [-104.601, 39.914], [-105.11, 39.914], [-105.11, 39.614]]]}}, {"type": "Feature", "id": "08005", "properties": {"name": "Arapahoe", "fips": "08005"}, "geometry": {"type": "Polygon", "coordinates": [[[-104.939, 39.391], [-103.574, 39.391], [-103.574, 39.914], [-104.939, 39.914], [-104.939, 39.391]]]}}, {"type": "Feature", "id": "08039", "properties": {"name": "Elbert", "fips": "08039"}, "geometry": {"type": "Polygon", "coordinates": [[[-104.601, 38.686], [-103.574, 38.686], [-103.574, 39.391], [-104.601, 39.391], [-104.601, 38.686]]]}}, {"type": "Feature", "id": "08073", "properties": {"name": "Lincoln", "fips": "08073"}, "geometry": {"type": "Polygon", "coordinates": [[[-103.574, 38.686], [-102.042, 38.686], [-102.042, 39.574], [-103.574, 39.574], [-103.574, 38.686]]]}}, {"type": "Feature", "id": "08063", "properties": {"name": "Kit Carson", "fips": "08063"}, "geometry": {"type": "Polygon", "coordinates": [[[-102.813, 38.686], [-102.042, 38.686], [-102.042, 39.391], [-102.813, 39.391], [-102.813, 38.686]]]}}, {"type": "Feature", "id": "08109", "properties": {"name": "Saguache", "fips": "08109"}, "geometry": {"type": "Polygon", "coordinates": [[[-106.881, 37.574], [-105.636, 37.574], [-105.636, 38.257], [-106.881, 38.257], [-106.881, 37.574]]]}}, {"type": "Feature", "id": "08015", "properties": {"name": "Chaffee", "fips": "08015"}, "geometry": {"type": "Polygon", "coordinates": [[[-106.263, 38.257], [-105.558, 38.257], [-105.558, 38.857], [-106.263, 38.857], [-106.263, 38.257]]]}}, {"type": "Feature", "id": "08043", "properties": {"name": "Fremont", "fips": "08043"}, "geometry": {"type": "Polygon", "coordinates": [[[-105.558, 38.086], [-104.943, 38.086], [-104.943, 38.686], [-105.558, 38.686], [-105.558, 38.086]]]}}, {"type": "Feature", "id": "08119", "properties": {"name": "Teller", "fips": "08119"}, "geometry": {"type": "Polygon", "coordinates": [[[-105.308, 38.676], [-104.601, 38.676], [-104.601, 39.074], [-105.308, 39.074], [-105.308, 38.676]]]}}, {"type": "Feature", "id": "08041", "properties": {"name": "El Paso", "fips": "08041"}, "geometry": {"type": "Polygon", "coordinates": [[[-105.18, 38.086], [-103.574, 38.086], [-103.574, 38.986], [-105.18, 38.986], [-105.18, 38.086]]]}}, {"type": "Feature", "id": "08025", "properties": {"name": "Crowley", "fips": "08025"}, "geometry": {"type": "Polygon", "coordinates": [[[-103.874, 38.086], [-103.245, 38.086], [-103.245, 38.686], [-103.874, 38.686], [-103.874, 38.086]]]}}, {"type": "Feature", "id": "08", "properties": {"name": "Otero", "fips": "08089"}, "geometry": {"type": "Polygon", "coordinates": [[[-103.506, 37.574], [-103.006, 37.574], [-103.006, 38.086], [-103.506, 38.086], [-103.506, 37.574]]]}}, {"type": "Feature", "id": "08011", "properties": {"name": "Bent", "fips": "08011"}, "geometry": {"type": "Polygon", "coordinates": [[[-103.506, 37.574], [-102.042, 37.574], [-102.042, 38.086], [-103.506, 38.086], [-103.506, 37.574]]]}}, {"type": "Feature", "id": "08099", "properties": {"name": "Prowers", "fips": "08099"}, "geometry": {"type": "Polygon", "coordinates": [[[-102.813, 37.574], [-102.042, 37.574], [-102.042, 38.086], [-102.813, 38.086], [-102.813, 37.574]]]}}, {"type": "Feature", "id": "08053", "properties": {"name": "Hinsdale", "fips": "08053"}, "geometry": {"type": "Polygon", "coordinates": [[[-107.63, 37.574], [-106.881, 37.574], [-106.881, 38.257], [-107.63, 38.257], [-107.63, 37.574]]]}}, {"type": "Feature", "id": "08079", "properties": {"name": "Mineral", "fips": "08079"}, "geometry": {"type": "Polygon", "coordinates": [[[-107.044, 37.574], [-106.644, 37.574], [-106.644, 37.977], [-107.044, 37.977], [-107.044, 37.574]]]}}, {"type": "Feature", "id": "08105", "properties": {"name": "Rio Grande", "fips": "08105"}, "geometry": {"type": "Polygon", "coordinates": [[[-106.644, 37.574], [-105.636, 37.574], [-105.636, 38.086], [-106.644, 38.086], [-106.644, 37.574]]]}}, {"type": "Feature", "id": "08003", "properties": {"name": "Alamosa", "fips": "08003"}, "geometry": {"type": "Polygon", "coordinates": [[[-105.912, 37.234], [-105.196, 37.234], [-105.196, 37.574], [-105.912, 37.574], [-105.912, 37.234]]]}}, {"type": "Feature", "id": "08021", "properties": {"name": "Conejos", "fips": "08021"}, "geometry": {"type": "Polygon", "coordinates": [[[-106.882, 36.993], [-105.636, 36.993], [-105.636, 37.574], [-106.882, 37.574], [-106.882, 36.993]]]}}, {"type": "Feature", "id": "08023", "properties": {"name": "Costilla", "fips": "08023"}, "geometry": {"type": "Polygon", "coordinates": [[[-105.636, 36.993], [-105.027, 36.993], [-105.027, 37.574], [-105.636, 37.574], [-105.636, 36.993]]]}}, {"type": "Feature", "id": "08055", "properties": {"name": "Huerfano", "fips": "08055"}, "geometry": {"type": "Polygon", "coordinates": [[[-105.18, 37.33], [-104.255, 37.33], [-104.255, 38.086], [-105.18, 38.086], [-105.18, 37.33]]]}}, {"type": "Feature", "id": "08071", "properties": {"name": "Las Animas", "fips": "08071"}, "geometry": {"type": "Polygon", "coordinates": [[[-104.939, 36.993], [-102.813, 36.993], [-102.813, 37.574], [-104.939, 37.574], [-104.939, 36.993]]]}}, {"type": "Feature", "id": "08101", "properties": {"name": "Pueblo", "fips": "08101"}, "geometry": {"type": "Polygon", "coordinates": [[[-105.027, 37.574], [-103.874, 37.574], [-103.874, 38.086], [-105.027, 38.086], [-105.027, 37.574]]]}}, {"type": "Feature", "id": "08033", "properties": {"name": "Dolores", "fips": "08033"}, "geometry": {"type": "Polygon", "coordinates": [[[-108.96, 37.574], [-108.29, 37.574], [-108.29, 38.257], [-108.96, 38.257], [-108.96, 37.574]]]}}, {"type": "Feature", "id": "08113", "properties": {"name": "San Miguel", "fips": "08113"}, "geometry": {"type": "Polygon", "coordinates": [[[-108.96, 37.814], [-107.967, 37.814], [-107.967, 38.257], [-108.96, 38.257], [-108.96, 37.814]]]}}, {"type": "Feature", "id": "08", "properties": {"name": "Montezuma", "fips": "08083"}, "geometry": {"type": "Polygon", "coordinates": [[[-109.06, 36.993], [-107.967, 36.993], [-107.967, 37.574], [-109.06, 37.574], [-109.06, 36.993]]]}}, {"type": "Feature", "id": "08067", "properties": {"name": "La Plata", "fips": "08067"}, "geometry": {"type": "Polygon", "coordinates": [[[-107.967, 36.993], [-106.882, 36.993], [-106.882, 37.574], [-107.967, 37.574], [-107.967, 36.993]]]}}, {"type": "Feature", "id": "08007", "properties": {"name": "Archuleta", "fips": "08007"}, "geometry": {"type": "Polygon", "coordinates": [[[-107.044, 36.993], [-106.882, 36.993], [-106.882, 37.574], [-107.044, 37.574], [-107.044, 36.993]]]}}, {"type": "Feature", "id": "08111", "properties": {"name": "San Juan", "fips": "08111"}, "geometry": {"type": "Polygon", "coordinates": [[[-107.964, 37.574], [-107.044, 37.574], [-107.044, 37.977], [-107.964, 37.977], [-107.964, 37.574]]]}}, {"type": "Feature", "id": "08017", "properties": {"name": "Cheyenne", "fips": "08017"}, "geometry": {"type": "Polygon", "coordinates": [[[-103.574, 38.257], [-102.042, 38.257], [-102.042, 38.686], [-103.574, 38.686], [-103.574, 38.257]]]}}, {"type": "Feature", "id": "08061", "properties": {"name": "Kiowa", "fips": "08061"}, "geometry": {"type": "Polygon", "coordinates": [[[-103.006, 38.257], [-102.042, 38.257], [-102.042, 38.686], [-103.006, 38.686], [-103.006, 38.257]]]}}]};

    L.geoJSON(coStateFC, {style: styleState}).addTo(map);
    const coBounds = L.geoJSON(coStateFC).getBounds();

    const countiesLayer = L.geoJSON(coCountiesFC, {
      style: styleCounty,
      onEachFeature: (f, lyr) => {
        const name = (f.properties && f.properties.name) ? f.properties.name + ' County' : 'Colorado County';
        lyr.bindTooltip(name, {sticky:true, opacity:0.93, offset:[5,0]});
        lyr.on('mouseover', function() { this.setStyle({color:'rgba(255,255,255,0.75)',weight:2}); });
        lyr.on('mouseout',  function() { this.setStyle(styleCounty()); });
      }
    }).addTo(map);

    map.fitBounds(coBounds, {padding:[16,16]});
    const minZ = Math.max(6, Math.floor(map.getBoundsZoom(CO_MAX_BOUNDS)));
    map.setMinZoom(minZ);

    const chkCounties = $id('layerCounties');
    if (chkCounties) chkCounties.addEventListener('change', () =>
      chkCounties.checked ? countiesLayer.addTo(map) : map.removeLayer(countiesLayer));

    setStatus(statusEl, 'Boundaries loaded ‚úì', 'ok');

    /* ---------- Step 2: Places ---------- */
    let placesLayer = null;
    async function loadPlaces() {
      try {
        setStatus(statusEl, 'Loading places‚Ä¶', 'info');
        const gj = await arcgisQuery(CO_PLACES_URL, "STATE='08'", 'NAME,LSAD,FUNCSTAT,ALAND');
        if (!gj.features.length) throw new Error('empty');
        placesLayer = L.geoJSON(gj, {
          style: stylePlace,
          onEachFeature: (f, lyr) => {
            const name = (f.properties && (f.properties.NAME || f.properties.NAMELSAD)) || '';
            if (name) lyr.bindTooltip(name, {sticky:true, opacity:0.88, offset:[5,0]});
          }
        });
        const chkPlaces = $id('layerPlaces');
        if (chkPlaces) {
          if (chkPlaces.checked) placesLayer.addTo(map);
          chkPlaces.addEventListener('change', () =>
            chkPlaces.checked ? placesLayer.addTo(map) : map.removeLayer(placesLayer));
        }
        setStatus(statusEl, `Places loaded (${gj.features.length}) ‚úì`, 'ok');
      } catch(e) { console.warn('Places unavailable:', e.message); }
    }

    /* ---------- Step 3: LIHTC Projects ---------- */
    let lihtcAll = null;
    const lihtcGroup = L.layerGroup().addTo(map);

    function renderLIHTC() {
      lihtcGroup.clearLayers();
      if (!lihtcAll) return;
      const onlyQCT = !!$id('filterQCT')?.checked;
      const onlyDDA = !!$id('filterDDA')?.checked;
      let shown = 0;
      for (const f of (lihtcAll.features || [])) {
        const p = f.properties || {};
        if (onlyQCT && !(p.QCT===1||p.QCT==='1'||p.QCT==='Y'||p.QCT===true)) continue;
        if (onlyDDA && !(p.DDA===1||p.DDA==='1'||p.DDA==='Y'||p.DDA===true)) continue;
        const coords = f.geometry?.type==='Point' ? f.geometry.coordinates : null;
        if (!coords || !coords[0] || !coords[1]) continue;
        const marker = L.circleMarker([coords[1], coords[0]], {
          pane:'pointsPane2', radius:5.5, weight:1.5,
          color:'rgba(94,200,248,1)', fillColor:'rgba(94,200,248,0.72)', fillOpacity:1
        });
        marker.bindPopup(buildPopup(p), {maxWidth:340});
        const nm   = p.PROJECT || p.PROJ_NM || 'LIHTC Project';
        const city = p.PROJ_CTY || p.STD_CITY || '';
        const yr   = p.YR_PIS ? ` (${p.YR_PIS})` : '';
        const units = p.LI_UNITS ? `<br>${p.LI_UNITS} low-income units` : '';
        marker.bindTooltip(
          `<strong>${nm}</strong>${city?'<br>'+city:''}${yr}${units}`,
          {sticky:false, offset:[8,0], opacity:0.95, direction:'right'}
        );
        marker.addTo(lihtcGroup);
        shown++;
      }
      setStatus(statusEl, `${shown} LIHTC projects ‚úì`, 'ok');
    }

    async function loadLIHTC() {
      setStatus(statusEl, 'Loading LIHTC projects‚Ä¶', 'info');
      let gj = null;
      try {
        gj = await arcgisQuery(HUD_LIHTC_LAYER, "(PROJ_ST='CO') OR (STD_ST='CO')", '*');
        if (!gj.features.length) throw new Error('Empty result from HUD');
        console.log('‚úì LIHTC: loaded from HUD API');
      } catch(e) {
        console.warn('HUD LIHTC API unavailable, using embedded data:', e.message);
        gj = FALLBACK_LIHTC;
      }
      lihtcAll = gj;
      renderLIHTC();
    }

    /* ---------- Step 4: QCT / DDA ---------- */
    let qctLayer = null, ddaLayer = null;
    let qctLoaded = false, ddaLoaded = false;

    function makeOverlayLayer(gj, styleFn, label) {
      return L.geoJSON(gj, {
        pane: 'overlayPane2',
        style: styleFn,
        onEachFeature: (f, lyr) => {
          const p = f.properties || {};
          const name  = p.NAME || p.NAMELSAD || p.GEOID || label;
          const type  = p.DDATYPE || p.TRACTTYPE || '';
          const geoid = p.GEOID || p.GEOID20 || '';
          let tip = `<strong>${name}</strong>`;
          if (type)  tip += `<br><em style="opacity:.8;">${type}</em>`;
          if (geoid) tip += `<br><span style="opacity:.65;font-size:11px;">GEOID: ${geoid}</span>`;
          tip += `<br><span style="opacity:.6;font-size:11px;">${label}</span>`;
          lyr.bindTooltip(tip, {sticky:true, opacity:0.95, direction:'top'});
          lyr.on('mouseover', function() { this.setStyle({weight:2.5,fillOpacity:0.35}); });
          lyr.on('mouseout',  function() { this.setStyle(styleFn()); });
        }
      });
    }

    async function tryLoadFromAPI(primaryUrl, coWhere) {
      const filters = [coWhere,"STATE_ABBR='CO'","STATE='CO'","STUSAB='CO'","STATEFP='08'","1=1"];
      for (const where of filters) {
        try {
          const gj = await arcgisQuery(primaryUrl, where, '*');
          if (!gj.features.length) continue;
          let features = gj.features;
          if (where === '1=1') {
            features = features.filter(f => {
              if (!f.geometry) return false;
              const flat = JSON.stringify(f.geometry.coordinates).match(/-?\d+\.?\d+/g)?.map(Number)||[];
              for (let i=0; i<flat.length-1; i+=2)
                if (flat[i]>-110&&flat[i]<-102&&flat[i+1]>36.5&&flat[i+1]<41.5) return true;
              return false;
            });
          }
          if (features.length) return {...gj, features};
        } catch(_) {}
      }
      throw new Error('API exhausted');
    }

    async function ensureQCT() {
      if (qctLoaded) return; qctLoaded = true;
      try {
        const gj = await tryLoadFromAPI(QCT_LAYER, "STATEFP='08'");
        qctLayer = makeOverlayLayer(gj, styleQCT, 'QCT 2026');
        console.log('‚úì QCT: loaded from API');
      } catch(_) {
        console.warn('QCT API unavailable, using embedded data');
        qctLayer = makeOverlayLayer(FALLBACK_QCT, styleQCT, 'QCT 2026');
      }
    }

    async function ensureDDA() {
      if (ddaLoaded) return; ddaLoaded = true;
      try {
        const gj = await tryLoadFromAPI(DDA_LAYER, "STATEFP='08'");
        ddaLayer = makeOverlayLayer(gj, styleDDA, 'DDA 2026');
        console.log('‚úì DDA: loaded from API');
      } catch(_) {
        console.warn('DDA API unavailable, using embedded data');
        ddaLayer = makeOverlayLayer(FALLBACK_DDA, styleDDA, 'DDA 2026');
      }
    }

    async function syncQCT() {
      const chk = $id('layerQCT'); if (!chk) return;
      if (chk.checked && !qctLayer) await ensureQCT();
      if (qctLayer) chk.checked ? qctLayer.addTo(map) : map.removeLayer(qctLayer);
    }
    async function syncDDA() {
      const chk = $id('layerDDA'); if (!chk) return;
      if (chk.checked && !ddaLayer) await ensureDDA();
      if (ddaLayer) chk.checked ? ddaLayer.addTo(map) : map.removeLayer(ddaLayer);
    }

    /* ---------- Step 5: Transport ---------- */
    const chkTransport = $id('layerTransport');
    if (chkTransport) chkTransport.addEventListener('change', () =>
      chkTransport.checked ? transportLayer.addTo(map) : map.removeLayer(transportLayer));

    /* ---------- Checkboxes ---------- */
    const filterQCT=$id('filterQCT'), filterDDA=$id('filterDDA');
    const chkQCT=$id('layerQCT'),     chkDDA=$id('layerDDA');
    if (chkQCT)    chkQCT.addEventListener('change', syncQCT);
    if (chkDDA)    chkDDA.addEventListener('change', syncDDA);
    if (filterQCT) filterQCT.addEventListener('change', renderLIHTC);
    if (filterDDA) filterDDA.addEventListener('change', renderLIHTC);

    /* ---------- Kick off ---------- */
    await Promise.allSettled([loadPlaces(), loadLIHTC()]);
    if ($id('layerQCT')?.checked) syncQCT();
    if ($id('layerDDA')?.checked) syncDDA();

    setTimeout(() => map.invalidateSize(), 300);
    window.addEventListener('resize', () => map.invalidateSize());
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();

  </script>

  <!-- Lightweight chart init so the restored canvases render even if other JS files are missing -->
  <script>
    (function() {
      if (!window.Chart) return;
      function safeChart(id, cfg) {
        const el = document.getElementById(id);
        if (!el) return;
        try { new Chart(el, cfg); } catch(e) { console.warn("Chart failed", id, e); }
      }
      safeChart("ami-need-chart", {
        type: "bar",
        data: {
          labels: ["30% AMI","50% AMI","60% AMI","80% AMI"],
          datasets: [{ label:"Households (index)", data:[100, 130, 160, 210] },
                     { label:"Available units (index)", data:[35, 55, 95, 140] }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { labels: { color: "rgba(255,255,255,.75)" } } },
                  scales: { x: { ticks: { color:"rgba(255,255,255,.75)" } }, y: { ticks: { color:"rgba(255,255,255,.75)" } } } }
      });
      safeChart("concessions-chart", {
        type: "line",
        data: {
          labels: ["2022","2023","2024","2025"],
          datasets: [{ label:"Avg monthly concession ($)", data:[45, 65, 110, 169], tension:.35 }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { labels: { color: "rgba(255,255,255,.75)" } } },
                  scales: { x: { ticks: { color:"rgba(255,255,255,.75)" } }, y: { ticks: { color:"rgba(255,255,255,.75)" } } } }
      });
      safeChart("foreclosure-chart", {
        type: "line",
        data: {
          labels: ["2023","2024","2025","2026"],
          datasets: [{ label:"Filings (index)", data:[70, 55, 62, 68], tension:.35 }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { labels: { color: "rgba(255,255,255,.75)" } } },
                  scales: { x: { ticks: { color:"rgba(255,255,255,.75)" } }, y: { ticks: { color:"rgba(255,255,255,.75)" } } } }
      });
      safeChart("confidence-chart", {
        type: "line",
        data: {
          labels: ["Q1","Q2","Q3","Q4"],
          datasets: [{ label:"Confidence (index)", data:[42, 46, 44, 48], tension:.35 }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { labels: { color: "rgba(255,255,255,.75)" } } },
                  scales: { x: { ticks: { color:"rgba(255,255,255,.75)" } }, y: { ticks: { color:"rgba(255,255,255,.75)" } } } }
      });
      safeChart("comparison-chart", {
        type: "radar",
        data: {
          labels: ["Allocation","Vacancy","Rent Growth","Unemployment","Foreclosure Risk"],
          datasets: [{ label:"Colorado (index)", data:[62, 78, 35, 70, 68] },
                     { label:"US Avg (index)", data:[55, 60, 55, 62, 60] }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { labels: { color: "rgba(255,255,255,.75)" } } },
                  scales: { r: { ticks: { color:"rgba(255,255,255,.65)" }, grid: { color:"var(--border)" }, angleLines: { color:"var(--border)" }, pointLabels: { color:"rgba(255,255,255,.75)" } } }
      });
    })();
  </script>
  <script src="js/co-ami-gap.js"></script>
</body>
</html>
