'use strict';

const nodemailer = require('nodemailer');

const EMAIL_USER = process.env.EMAIL_USER;
const EMAIL_PASSWORD = process.env.EMAIL_PASSWORD;
const TO = 'communityplanner@gmail.com';

if (!EMAIL_USER || !EMAIL_PASSWORD) {
    console.error('Error: EMAIL_USER and EMAIL_PASSWORD environment variables are required.');
    console.error('Set them before running this script:');
    console.error('  EMAIL_USER=you@gmail.com EMAIL_PASSWORD=your-app-password node test/send-test-email.js');
    process.exit(1);
}

const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: { user: EMAIL_USER, pass: EMAIL_PASSWORD }
});

function buildSuccessEmail() {
    return {
        from: EMAIL_USER,
        to: TO,
        subject: '‚úÖ Website Monitor: Everything is Fine ‚Äî https://example.com',
        html: `<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Website Monitoring Report</title></head>
<body style="font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:20px;color:#212529;">
    <h1 style="color:#343a40;border-bottom:2px solid #dee2e6;padding-bottom:12px;">
        üîç Website Monitoring Report
    </h1>
    <p style="color:#6c757d;">Site: <strong>https://example.com</strong> &nbsp;|&nbsp; Generated: <strong>${new Date().toISOString()}</strong></p>
    <div style="background:#d4edda;border:1px solid #c3e6cb;border-radius:8px;padding:16px;margin-bottom:20px;font-size:20px;font-weight:bold;color:#155724;">
        ‚úÖ Everything is Fine ‚Äî All links are healthy!
    </div>
    <h2 style="color:#343a40;">Summary</h2>
    <table style="width:100%;border-collapse:collapse;margin-bottom:24px;">
        <tr style="background:#f8f9fa;">
            <td style="padding:12px;border:1px solid #dee2e6;font-weight:bold;">Total Links Checked</td>
            <td style="padding:12px;border:1px solid #dee2e6;">45</td>
        </tr>
        <tr>
            <td style="padding:12px;border:1px solid #dee2e6;font-weight:bold;">Healthy Links</td>
            <td style="padding:12px;border:1px solid #dee2e6;color:#155724;">‚úÖ 45</td>
        </tr>
        <tr style="background:#f8f9fa;">
            <td style="padding:12px;border:1px solid #dee2e6;font-weight:bold;">Broken Links</td>
            <td style="padding:12px;border:1px solid #dee2e6;color:#155724;">‚úÖ 0</td>
        </tr>
        <tr>
            <td style="padding:12px;border:1px solid #dee2e6;font-weight:bold;">Health Score</td>
            <td style="padding:12px;border:1px solid #dee2e6;font-weight:bold;color:#155724;">100%</td>
        </tr>
    </table>
    <hr style="border:none;border-top:1px solid #dee2e6;margin-top:32px;">
    <p style="color:#adb5bd;font-size:12px;">Automated report generated by Housing Analytics Website Monitor</p>
</body>
</html>`
    };
}

function buildIssuesEmail() {
    return {
        from: EMAIL_USER,
        to: TO,
        subject: '‚ö†Ô∏è Website Monitor: 3 Issue(s) Found ‚Äî https://example.com',
        html: `<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Website Monitoring Report</title></head>
<body style="font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:20px;color:#212529;">
    <h1 style="color:#343a40;border-bottom:2px solid #dee2e6;padding-bottom:12px;">
        üîç Website Monitoring Report
    </h1>
    <p style="color:#6c757d;">Site: <strong>https://example.com</strong> &nbsp;|&nbsp; Generated: <strong>${new Date().toISOString()}</strong></p>
    <div style="background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:16px;margin-bottom:20px;font-size:20px;font-weight:bold;color:#856404;">
        ‚ö†Ô∏è Issues Found ‚Äî 3 broken link(s) detected
    </div>
    <h2 style="color:#343a40;">Summary</h2>
    <table style="width:100%;border-collapse:collapse;margin-bottom:24px;">
        <tr style="background:#f8f9fa;">
            <td style="padding:12px;border:1px solid #dee2e6;font-weight:bold;">Total Links Checked</td>
            <td style="padding:12px;border:1px solid #dee2e6;">45</td>
        </tr>
        <tr>
            <td style="padding:12px;border:1px solid #dee2e6;font-weight:bold;">Healthy Links</td>
            <td style="padding:12px;border:1px solid #dee2e6;color:#155724;">‚úÖ 42</td>
        </tr>
        <tr style="background:#f8f9fa;">
            <td style="padding:12px;border:1px solid #dee2e6;font-weight:bold;">Broken Links</td>
            <td style="padding:12px;border:1px solid #dee2e6;color:#721c24;">‚ùå 3</td>
        </tr>
        <tr>
            <td style="padding:12px;border:1px solid #dee2e6;font-weight:bold;">Health Score</td>
            <td style="padding:12px;border:1px solid #dee2e6;font-weight:bold;color:#856404;">93%</td>
        </tr>
    </table>
    <h2 style="color:#721c24;">Broken Links Details</h2>
    <table style="width:100%;border-collapse:collapse;margin-bottom:24px;">
        <thead>
            <tr style="background:#f8d7da;">
                <th style="padding:10px;border:1px solid #dee2e6;text-align:left;">URL</th>
                <th style="padding:10px;border:1px solid #dee2e6;text-align:left;">Status</th>
                <th style="padding:10px;border:1px solid #dee2e6;text-align:left;">Recommended Fix</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td style="padding:10px;border:1px solid #dee2e6;word-break:break-all;">https://example.com/old-page</td>
                <td style="padding:10px;border:1px solid #dee2e6;color:#721c24;font-weight:bold;">404</td>
                <td style="padding:10px;border:1px solid #dee2e6;">Page not found. Update or remove this link from your site.</td>
            </tr>
            <tr>
                <td style="padding:10px;border:1px solid #dee2e6;word-break:break-all;">https://example.com/data/missing.json</td>
                <td style="padding:10px;border:1px solid #dee2e6;color:#721c24;font-weight:bold;">503</td>
                <td style="padding:10px;border:1px solid #dee2e6;">Service unavailable. Check if the server is running and retry later.</td>
            </tr>
            <tr>
                <td style="padding:10px;border:1px solid #dee2e6;word-break:break-all;">https://broken-domain-xyz.com/resource</td>
                <td style="padding:10px;border:1px solid #dee2e6;color:#721c24;font-weight:bold;">ENOTFOUND</td>
                <td style="padding:10px;border:1px solid #dee2e6;">Domain not found. Verify the URL is correct and the domain exists.</td>
            </tr>
        </tbody>
    </table>
    <h2 style="color:#856404;">Action Items</h2>
    <ul style="background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:16px 32px;margin-bottom:24px;">
        <li style="margin-bottom:8px;">Fix link #1: <code>https://example.com/old-page</code> ‚Äî Page not found. Update or remove this link from your site.</li>
        <li style="margin-bottom:8px;">Fix link #2: <code>https://example.com/data/missing.json</code> ‚Äî Service unavailable. Check if the server is running and retry later.</li>
        <li style="margin-bottom:8px;">Fix link #3: <code>https://broken-domain-xyz.com/resource</code> ‚Äî Domain not found. Verify the URL is correct and the domain exists.</li>
    </ul>
    <hr style="border:none;border-top:1px solid #dee2e6;margin-top:32px;">
    <p style="color:#adb5bd;font-size:12px;">Automated report generated by Housing Analytics Website Monitor</p>
</body>
</html>`
    };
}

async function main() {
    console.log(`Sending sample monitoring emails to ${TO}...`);

    try {
        await transporter.sendMail(buildSuccessEmail());
        console.log('‚úÖ Sample "Everything is Fine" email sent successfully.');
    } catch (err) {
        console.error('Failed to send success email:', err.message);
    }

    try {
        await transporter.sendMail(buildIssuesEmail());
        console.log('‚úÖ Sample "Issues Found" email sent successfully.');
    } catch (err) {
        console.error('Failed to send issues email:', err.message);
    }

    console.log('Done.');
}

main().catch(err => {
    console.error('Unexpected error:', err);
    process.exit(1);
});
